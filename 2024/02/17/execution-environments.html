<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Execution Environments - From Zero to Hero. An in-depth explanation. | Steffen’s random thoughts</title>
<meta name="generator" content="Jekyll v3.9.5">
<meta property="og:title" content="Execution Environments - From Zero to Hero. An in-depth explanation.">
<meta name="author" content="Steffen Scheib">
<meta property="og:locale" content="en_US">
<meta name="description" content="Preface">
<meta property="og:description" content="Preface">
<link rel="canonical" href="https://blog.scheib.me/2024/02/17/execution-environments.html">
<meta property="og:url" content="https://blog.scheib.me/2024/02/17/execution-environments.html">
<meta property="og:site_name" content="Steffen’s random thoughts">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-02-17T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Execution Environments - From Zero to Hero. An in-depth explanation.">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Steffen Scheib"},"dateModified":"2024-04-25T00:00:00+00:00","datePublished":"2024-02-17T00:00:00+00:00","description":"Preface","headline":"Execution Environments - From Zero to Hero. An in-depth explanation.","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.scheib.me/2024/02/17/execution-environments.html"},"url":"https://blog.scheib.me/2024/02/17/execution-environments.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://blog.scheib.me/feed.xml" title="Steffen's random thoughts">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Steffen's random thoughts</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">/about</a></div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Execution Environments - From Zero to Hero. An in-depth explanation.</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-02-17T00:00:00+00:00" itemprop="datePublished">Published: Feb 17, 2024
      </time>
      <time class="dt-modified" datetime="2024-04-25T00:00:00+00:00" itemprop="dateModified">• Last modified: Apr 25, 2024
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Steffen Scheib </span></span>• <span itemprop="readingTime" itemscope><span class="h-card" itemprop="readingTime">

149 minutes to read
</span></span></p>
  </header>

  <div class="toc">
    <h2>Table of contents</h2>
    <ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#a-quick-look-into-the-past">A quick look into the past</a></li>
<li>
<a href="#ansibles-execution-environments-ees-an-introduction">Ansible’s execution environments (EEs): An introduction</a><ul><li>
<a href="#execution-environments-getting-started">Execution environments: Getting started</a><ul>
<li><a href="#ansible-navigator"><code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#ansible-builder"><code class="language-plaintext highlighter-rouge">ansible-builder</code></a></li>
<li><a href="#existing-ees-an-overview">Existing EEs: An overview</a></li>
<li><a href="#deciding-which-existing-ee-to-obtain">Deciding which existing EE to obtain</a></li>
</ul>
</li></ul>
</li>
<li>
<a href="#using-existing-ees-with-ansible-navigator">Using existing EEs with <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a><ul>
<li><a href="#installing-ansible-navigator">Installing <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#getting-started-with-ansible-navigator">Getting started with <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#an-overview-of-the-commands-of-ansible-navigator">An overview of the commands of <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#configuration-of-ansible-navigator">Configuration of <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#my-configuration-for-ansible-navigator">My configuration for <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#playbook-artifacts-in-ansible-navigator"><code class="language-plaintext highlighter-rouge">playbook-artifacts</code> in <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#modes-of-ansible-navigator">Modes of <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#navigating-in-ansible-navigator-when-using-the-text-based-user-interface-tui">Navigating in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> when using the text-based user interface (<code class="language-plaintext highlighter-rouge">TUI</code>)</a></li>
<li><a href="#running-playbooks-in-ansible-navigator">Running playbooks in <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
<li><a href="#mounting-certificates-inside-the-ee-while-using-ansible-navigator">Mounting certificates inside the <code class="language-plaintext highlighter-rouge">EE</code> while using <code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
</ul>
</li>
<li>
<a href="#building-custom-ees-with-ansible-builder">Building custom EEs with <code class="language-plaintext highlighter-rouge">ansible-builder</code></a><ul>
<li><a href="#installing-ansible-builder">Installing <code class="language-plaintext highlighter-rouge">ansible-builder</code></a></li>
<li><a href="#getting-started-with-ansible-builder">Getting started with <code class="language-plaintext highlighter-rouge">ansible-builder</code></a></li>
<li><a href="#execution-environment-definition">Execution Environment definition</a></li>
<li>
<a href="#execution-environment-stages">Execution Environment stages</a><ul>
<li><a href="#base-stage"><code class="language-plaintext highlighter-rouge">base</code> stage</a></li>
<li><a href="#galaxy-stage"><code class="language-plaintext highlighter-rouge">galaxy</code> stage</a></li>
<li><a href="#builder-stage"><code class="language-plaintext highlighter-rouge">builder</code> stage</a></li>
<li><a href="#final-stage"><code class="language-plaintext highlighter-rouge">final</code> stage</a></li>
</ul>
</li>
<li>
<a href="#complex-execution-environments">Complex execution environments</a><ul>
<li><a href="#specifying-dependencies-as-files">Specifying dependencies as files</a></li>
<li><a href="#installing-ansible-collections-and-roles">Installing Ansible collections and roles</a></li>
<li><a href="#installing-python-packages">Installing Python packages</a></li>
<li><a href="#installing-system-packages">Installing system packages</a></li>
<li><a href="#adding-certificates-to-an-ee">Adding certificates to an EE</a></li>
<li><a href="#defining-a-proxy">Defining a proxy</a></li>
<li><a href="#custom-python-package-repository">Custom Python package repository</a></li>
<li><a href="#enabling-and-disabling-repositories">Enabling and disabling repositories</a></li>
<li><a href="#the-complete-complex-execution-environment-making-use-of-advanced-yaml-syntax">The complete complex execution environment: Making use of advanced <code class="language-plaintext highlighter-rouge">YAML</code> syntax</a></li>
</ul>
</li>
<li><a href="#using-custom-base-images">Using custom base images</a></li>
<li>
<a href="#enabling-non-red-hat-repositories">Enabling non-Red Hat repositories</a><ul>
<li><a href="#the-issue">The issue</a></li>
<li><a href="#solutions-to-the-problem">Solutions to the problem</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li>
<a href="#change-log">Change log</a><ul>
<li><a href="#2024-04-25">2024-04-25</a></li>
<li><a href="#2024-04-01">2024-04-01</a></li>
<li><a href="#2024-03-12">2024-03-12</a></li>
<li><a href="#2024-03-11">2024-03-11</a></li>
<li><a href="#2024-03-10">2024-03-10</a></li>
<li><a href="#2024-03-02">2024-03-02</a></li>
</ul>
</li>
</ul>
  </div>
  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="preface">
  
  
    Preface <a href="#preface">#</a>
  
  
</h2>
    

<p>To understand why execution environments (EEs) are such a crucial part of modern Ansible we need to briefly look into the past.
To a time where there were no EEs, but <em>something</em> else to accommodate for certain situations.</p>

<p>In the following brief look into the past, I’ll cover only the basics. For experienced Ansible users which are aware of Ansible’s history this chapter is most likely useless -
feel free to skip to the next chapter <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>Okay, let’s get into it <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>
<h2 id="a-quick-look-into-the-past">
  
  
    A quick look into the past <a href="#a-quick-look-into-the-past">#</a>
  
  
</h2>
    

<p>Probably most users of Ansible encountered at some point a situation, where they needed to install a specific version of a Python module as a specific module of a collection
required it to be installed.</p>

<p>Let’s take as an example <a href="https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html"><code class="language-plaintext highlighter-rouge">community.general.proxmox</code></a>. The
module <code class="language-plaintext highlighter-rouge">proxmox</code> <a href="https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html#requirements">specifies</a> the following requirements:</p>

<blockquote>
  <p>The below requirements are needed on the host that executes this module.</p>
  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">proxmoxer</code> <!-- markdownlint-disable-line MD032 -->
</li>
    <li><code class="language-plaintext highlighter-rouge">requests</code></li>
  </ul>
</blockquote>

<p>Both <a href="https://github.com/proxmoxer/proxmoxer"><code class="language-plaintext highlighter-rouge">proxmoxer</code></a> and <a href="https://github.com/psf/requests"><code class="language-plaintext highlighter-rouge">requests</code></a> are
<a href="https://packaging.python.org/en/latest/tutorials/installing-packages/">Python packages</a>.</p>

<p>At this point we know, we need to install both Python packages <em>somehow</em> on our system where we execute Ansible. This leaves us with basically three choices:</p>

<ol>
  <li>Use the system’s package manager to install the packages - if packaged versions are available</li>
  <li>Install the Python packages using <a href="https://ianbicking.org/blog/2008/10/pyinstall-is-dead-long-live-pip.html"><code class="language-plaintext highlighter-rouge">pip installs packages</code>, better known as <code class="language-plaintext highlighter-rouge">pip</code></a> to install the
Python packages either in the user context (<a href="https://pip.pypa.io/en/stable/user_guide/#user-installs"><code class="language-plaintext highlighter-rouge">--user</code></a>) or in the system context (<strong>don’t ever install
Python packages in the system context!</strong>)</li>
  <li>Use a <a href="https://docs.python.org/3/library/venv.html"><code class="language-plaintext highlighter-rouge">Python Virtual Environment</code>, better known as <code class="language-plaintext highlighter-rouge">venv</code></a>
</li>
</ol>

<p>We can choose either of the three options above and we should be good to go, right?</p>

<p><em>Theoretically</em>, yes. <em>Practically</em>, not really - well, at least it comes with its challenges.</p>

<p>Why? Allow me to tell you little a story that might sound very familiar to you <img class="emoji" title=":innocent:" alt=":innocent:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f607.png" height="20" width="20">.</p>

<p>Let’s assume we’d pick option three, the Python Virtual Environments. <code class="language-plaintext highlighter-rouge">venvs</code> are usually what most Ansible users would go with, as it ‘separates’ the Python packages of the
actual Python system packages and therefore keeps the actual system ‘clean’.</p>

<p>Okay great, now you installed both <code class="language-plaintext highlighter-rouge">requests</code> and <code class="language-plaintext highlighter-rouge">proxmoxer</code>. It’s in your <code class="language-plaintext highlighter-rouge">venv</code>. Now you can get started with developing the Ansible role you wanted.</p>

<p>You start developing your role and you install more and more Ansible collections. With it, you install more and more Python packages as well as system packages, because, of
course, most of the collections depend on specific Python and/or system packages.</p>

<p>Finally you are done: You couldn’t be happier right now. Your role works <em>exactly</em> as you’ve imagined.</p>

<p>Now a colleague asks you whether you can share the Ansible code you have developed as he is in need of <em>exactly</em> such a role you have been working very hard on. Since you
published your role on your company’s git, you point your colleague to the git repository of your Ansible role.</p>

<p>The colleague comes back to you asking:</p>
<blockquote>
  <p>What Python packages do I need to install to make your role work?</p>
</blockquote>

<p>Of course you have the answer: You’ll simply look what’s installed inside your <code class="language-plaintext highlighter-rouge">venv</code> which you have been using the whole time while developing the role. You extract the list
of Python packages and send it to your colleague. Your colleagues comes back once again because the role still doesn’t work.</p>

<p>Then you remember: Right! You also installed system packages and made <em>some</em> modifications to your system’s configuration in order to make <em>something</em> work. If you just could
remember <em>what</em> you installed and modified.</p>

<p>Does that sound familiar to you? <img class="emoji" title=":joy:" alt=":joy:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png" height="20" width="20"></p>

<p>It doesn’t even need to be a colleague that asks you to use your role. The same issue happens when you migrate to a new development machine or upgrade to a newer operating
system version, etc. Certainly it happened to me. And not only once <img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">.</p>

<p>In the above story, I haven’t even started pulling in different versions of Ansible and/or Python that make things even more complex. Let alone if you’d like to deploy
that role now in production where there are stricter security requirements, of course.</p>

<p>Of course, you could argue that a proper documentation and a well-defined <a href="https://pip.pypa.io/en/stable/reference/requirements-file-format/">Python requirements file</a>
basically eliminates all of the issues above. You are right - for the most part at least. There are situations where a perfect documentation is not sufficient. Just imagine
you develop on Debian and you want to migrate to a different operating system. System package names and system configurations are most definitively different. Sure, you’ll be
able to make it work, but it requires effort. Effort that is unnecessary and a cumbersome burden most people would like to avoid because they can spent their time better with
something more productive.</p>

<p>So, what’s then a better solution to achieve the same - or even better - outcome?
Meet <a href="https://docs.ansible.com/ansible/latest/getting_started_ee/index.html#getting-started-with-execution-environments">Ansible’s execution environments (EEs)</a>.</p>
<h2 id="ansibles-execution-environments-ees-an-introduction">
  
  
    Ansible’s execution environments (EEs): An introduction <a href="#ansibles-execution-environments-ees-an-introduction">#</a>
  
  
</h2>
    

<p>So what exactly are EEs?</p>

<p>First and foremost, EEs are container images - they are basically packaged Ansible control nodes. Essentially, you can picture it as your development machine
or your centralized Ansible control node that runs your Ansible content in production, packaged in a container image with everything it needs to run specific Ansible content.</p>

<p>EEs come by default with a few things:</p>

<ol>
  <li>Ansible, usually <code class="language-plaintext highlighter-rouge">ansible-core</code>
</li>
  <li><a href="https://ansible.readthedocs.io/projects/runner/en/latest/"><code class="language-plaintext highlighter-rouge">ansible-runner</code></a></li>
  <li>A specific Python version that fits the Ansible version used</li>
</ol>

<p>That’s really it - for the bare minimum.</p>

<p>But what makes EEs so powerful and versatile is their great flexibility bundled with all the advantages of containers. If you haven’t worked with containers before, you might
not see the massive benefits of EEs just yet. I understand that. Some people might even be afraid of containers as they haven’t been using them until this point.</p>

<p>Rest assured: Containers are not bad. They are actually awesome if you understand the benefits of them and understand that you need to adapt in some ways to them.
This might sound at first like a big task, but it really is not.</p>

<p>Especially in the context of EEs, containers are not just not bad, but are <em>the</em> solution to all the problems I outlined above. I know, this might not be clear yet at this
point. You - hopefully - understand or at the very least begin to understand, what I mean once you finished reading this blog post.</p>

<p>For those who are afraid of containers: You don’t <em>really</em> need to work with containers in that sense when dealing with EEs. When building and executing EEs, you essentially
work with two ‘wrappers’ that take care of building and running your containers in such a way that you usually don’t need to interact with container images and containers
directly. I explain all of that in greater detail a bit later.</p>

<p>With the knowledge of what EEs are, I guess everyone can easily imagine why they solve the issues <code class="language-plaintext highlighter-rouge">venvs</code> have.</p>

<p>Essentially, you <strong>define and extend your EE</strong> as necessary <strong>while you actively develop</strong> Ansible content. This is <em>exactly</em> the same workflow you are used to when developing
Ansible Content with <code class="language-plaintext highlighter-rouge">venvs</code>. This time however, since everything is now neatly packaged in a container, you can now essentially share your development environment. With
<em>everything</em> you have modified. Be it settings within the EE, installed system packages or Python packages, as well as every Ansible content you depend on when running your
Ansible code.</p>

<p>EEs effectively eliminate the “.. but it works on my machine!” <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>
<h3 id="execution-environments-getting-started">
  
  
    Execution environments: Getting started <a href="#execution-environments-getting-started">#</a>
  
  
</h3>
    

<p>Working with EEs is pretty straight-forward once you know what you need. In the previous chapter I referred to two ‘wrappers’ that enable you to use and create EEs - these are:</p>

<ol>
  <li><a href="https://ansible.readthedocs.io/projects/navigator/"><code class="language-plaintext highlighter-rouge">ansible-navigator</code></a></li>
  <li><a href="https://ansible.readthedocs.io/projects/builder/en/latest/"><code class="language-plaintext highlighter-rouge">ansible-builder</code></a></li>
</ol>

<p>Let me give you a <em>very brief</em> overview over these tools.</p>
<h4 id="ansible-navigator">
  
  
    <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#ansible-navigator">#</a>
  
  
</h4>
    

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> is essentially an extension for all (well, most of) the <code class="language-plaintext highlighter-rouge">ansible-</code> commands (e.g. <code class="language-plaintext highlighter-rouge">ansible-playbook</code>, <code class="language-plaintext highlighter-rouge">ansible-inventory</code>, <code class="language-plaintext highlighter-rouge">ansible-doc</code>, etc.) you are
used to when working with Ansible on the command line interface (<code class="language-plaintext highlighter-rouge">CLI</code>). You <em>need</em> <code class="language-plaintext highlighter-rouge">ansible-navigator</code> to run your Ansible content via <code class="language-plaintext highlighter-rouge">CLI</code> inside an EE, as
<code class="language-plaintext highlighter-rouge">ansible-playbook</code> is not able to run something inside an EE.</p>
<h4 id="ansible-builder">
  
  
    <code class="language-plaintext highlighter-rouge">ansible-builder</code> <a href="#ansible-builder">#</a>
  
  
</h4>
    

<p><code class="language-plaintext highlighter-rouge">ansible-builder</code> is the tool to use when building execution environments. It makes creating and extending existing EEs easy and straight-forward. Under the hood, it
essentially interacts with <a href="https://podman.io/"><code class="language-plaintext highlighter-rouge">podman</code></a> to create the images.</p>

<p>Now that we know the <em>very basics</em> about EEs, let’s look a little deeper.</p>
<h4 id="existing-ees-an-overview">
  
  
    Existing EEs: An overview <a href="#existing-ees-an-overview">#</a>
  
  
</h4>
    

<p>The understand the concept behind EEs, please allow me to contextualize the Ansible ecosystem with regards to EEs a little.</p>

<p>There are existing EEs which you can utilize to get started. Both the Ansible community and Red Hat maintain a few EEs. The ones maintained by the
Ansible community are either hosted on <a href="https://quay.io/">https://quay.io</a> or on GitHub’s Container Registry <a href="https://ghcr.io">https://ghcr.io</a>. The ones Red Hat maintains are
officially called <em>Ansible Automation Platform execution environments</em>, which are <a href="https://catalog.redhat.com/software/containers/explore"><em>Certified Container Images</em></a> and
are provided via Red Hat’s Container Registry <a href="https://catalog.redhat.com/">registry.redhat.io</a>. I’ll refer to Red Hat’s EEs typically as “certified EEs”, as it makes
communication easier <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>The difference between EEs of the Ansible community (we at Red Hat, usually refer to them as <em>upstream</em>) and Red Hat’s EEs (we at Red Hat, usually refer to them as
<em>downstream</em>) is that upstream EEs are <em>usually</em> based on CentOS Stream, while downstream EEs are based on
<a href="https://catalog.redhat.com/software/base-images">Red Hat’s Universal Base Image (<code class="language-plaintext highlighter-rouge">UBI</code>)</a> and are <em>essentially</em> Red Hat Enterprise Linux (RHEL) in containers, if you will.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> To use Red Hat certified EEs you need to be a Red Hat subscriber If you don’t own any subscriptions, you can make use of
<a href="https://developers.redhat.com/articles/faqs-no-cost-red-hat-enterprise-linux">Red Hat’s Developer Subscription</a> which is provided at no cost by Red Hat.</p>

<p>The major difference, however, is the level of support you’ll get. Upstream in general moves really fast and does not do any
<a href="https://en.wikipedia.org/wiki/Backporting"><code class="language-plaintext highlighter-rouge">backports</code></a> for older Ansible versions.
In contrast, Red Hat supports their EEs for a <a href="https://access.redhat.com/support/policy/updates/ansible-automation-platform">defined life cycle</a> and does <code class="language-plaintext highlighter-rouge">backports</code> for bug
fixes and/or security fixes to older EEs which are using older <code class="language-plaintext highlighter-rouge">ansible-core</code> versions, which are still under support by Red Hat.</p>

<p>Please don’t get confused that the <a href="https://access.redhat.com/support/policy/updates/ansible-automation-platform">linked life cycle</a> points to the Ansible Automation Platform
life cycle. That’s not a mistake. The reason being that Red Hat treats several components of the Ansible ecosystem (such as Execution and Decision Environments, <code class="language-plaintext highlighter-rouge">ansible-core</code>,
<code class="language-plaintext highlighter-rouge">ansible-navigator</code>, <code class="language-plaintext highlighter-rouge">ansible-builder</code> among other things) as one <em>platform</em>. As Ansible Automation Platform subscriber, you’ll get a defined set of components in a
certain version, which ensures that all components are compatible with each other.</p>

<p>Upstream essentially treats various components, such as EEs, <code class="language-plaintext highlighter-rouge">ansible-builder</code>, <code class="language-plaintext highlighter-rouge">ansible-navigator</code> etc. as separate projects and therefore you <em>might</em> encounter difficulties
using the latest upstream versions together.</p>

<p><strong>Please don’t get me wrong</strong>: I am not saying you should avoid upstream releases. That’s not what I am saying at all. Upstream projects are <em>the core of everything</em> we do at
Red Hat as we follow the <a href="https://www.redhat.com/en/about/open-source/participation-guidelines">‘upstream first’</a> guideline and you should definitively make use of upstream
projects. However, you <em>might</em> want to reconsider using upstream projects if you are going to use them in production or you require a certain level of support to sustain your
business.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> Please keep in mind that this is a <strong>very simplified</strong> overview of upstream and downstream projects in the Open Source world. If you run a business and are about
to make a decision to either use upstream or downstream projects, I highly encourage you to do your own research to build up a solid understanding of the topic before
you decide.</p>

<p>Now that the <em>basic</em> principles of upstream vs. downstream with regards to EEs are out of the way, let’s actually get our hands dirty <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>
<h4 id="deciding-which-existing-ee-to-obtain">
  
  
    Deciding which existing EE to obtain <a href="#deciding-which-existing-ee-to-obtain">#</a>
  
  
</h4>
    

<p>Alright, let’s obtain one EE and start using it - but where do you get them and which one to chose?</p>

<p>For upstream EEs, you are probably going to choose either the <a href="https://github.com/ansible/creator-ee">Ansible Creator EE</a>, which is aimed towards Ansible content developers
or the <a href="https://quay.io/repository/ansible/awx-ee"><code class="language-plaintext highlighter-rouge">AWX EE</code></a> which is meant to be used when running your code in <a href="https://github.com/ansible/awx"><code class="language-plaintext highlighter-rouge">AWX</code></a> (one of Red Hat’s
upstream projects that are part of the Ansible Automation Platform).</p>

<p>In this blog post I am going to focus on using Red Hat’s certified EEs.</p>

<p>Certified EEs come, at the time of this writing, in different variants:</p>

<ul>
  <li>Either based on <code class="language-plaintext highlighter-rouge">UBI</code> 8 or <code class="language-plaintext highlighter-rouge">UBI</code> 9</li>
  <li>Either contain <code class="language-plaintext highlighter-rouge">ansible-core</code> <em>only</em> or <code class="language-plaintext highlighter-rouge">ansible-core</code> and a set of <a href="https://catalog.redhat.com/software/search?target_platforms=Red%20Hat%20Ansible%20Automation%20Platform"><em>certified collections</em></a>
</li>
  <li>In a <em>special</em> case, one EE contains Ansible Engine 2.9, but this EE is going to go away in the future as Ansible Engine reached its downstream end of life in December last
year (31.12.2023). This EE is/was provided merely for the reason to support customers in their migration from older Ansible Automation Platform versions, as Ansible itself
has changed drastically.</li>
</ul>

<p><em>Technically</em> that’s four variants, but <code class="language-plaintext highlighter-rouge">UBI</code> 8 or <code class="language-plaintext highlighter-rouge">UBI</code> 9 ‘only’ change the underlying operating system <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20">.</p>

<p>Again, Red Hat’s EEs are hosted on <a href="https://catalog.redhat.com">registry.redhat.io</a> where the ‘user-browsable interface’ is <a href="https://catalog.redhat.com">catalog.redhat.com</a>.
When browsing to <a href="https://catalog.redhat.com">registry.redhat.io</a> with your browser, you’ll be redirected to <a href="https://catalog.redhat.com">catalog.redhat.com</a> automatically, but
you’ll be pulling the EEs of <code class="language-plaintext highlighter-rouge">registry.redhat.io</code>.</p>

<p>Now, <em>finally</em>, here are some of the available EEs:</p>

<ul>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform/ee-minimal-rhel8/62bd87442c0945582b2b4b37">ansible-automation-platform/ee-minimal-rhel8</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform/ee-minimal-rhel9/6447df2aa123f7fc409f847e">ansible-automation-platform/ee-minimal-rhel9</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-minimal-rhel9/643d4c13fae71880450b6108">ansible-automation-platform-24/ee-minimal-rhel9</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-supported-rhel9/643d4c7255839fe0f27b0f30">ansible-automation-platform-24/ee-supported-rhel9</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-supported-rhel8/63a333ce183540f5962ae01d">ansible-automation-platform-24/ee-supported-rhel8</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-minimal-rhel8/63a3338544b6f291781716c7">ansible-automation-platform-24/ee-minimal-rhel8</a></li>
  <li><a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-29-rhel8/63a3322ccdc6fa07ca9d7527">ansible-automation-platform-24/ee-29-rhel8</a></li>
</ul>

<p>You can already tell a difference from the namespace portion of the EEs. <code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel9</code> vs. <code class="language-plaintext highlighter-rouge">ansible-automation-platform-24/ee-minimal-rhel9</code>.
Moreover, there is a <code class="language-plaintext highlighter-rouge">supported</code> variant and a <code class="language-plaintext highlighter-rouge">minimal</code> variant.</p>

<p>First off: Don’t get confused. <code class="language-plaintext highlighter-rouge">supported</code> in this context means, it will contain <code class="language-plaintext highlighter-rouge">ansible-core</code> <strong>and</strong> <em>some</em> <strong>supported</strong> Ansible collections. The <code class="language-plaintext highlighter-rouge">minimal</code>
variant is exactly as supported as the <code class="language-plaintext highlighter-rouge">supported</code> one is, albeit it’s totally understandable if you are confused <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">. The <code class="language-plaintext highlighter-rouge">minimal</code> EE contains <code class="language-plaintext highlighter-rouge">ansible-core</code> <strong>only</strong> -
no collections or anything else.</p>

<p>There is also this <em>special</em> EE, which contains Ansible Engine 2.9: <code class="language-plaintext highlighter-rouge">ansible-automation-platform-24/ee-29-rhel8</code>. Again, this EE is/was provided merely for the reason to
support customers in their migration from older Ansible Automation Platform/Ansible versions.</p>

<p>Secondly, the namespace difference (<code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel9</code> vs. <code class="language-plaintext highlighter-rouge">ansible-automation-platform-24/ee-minimal-rhel9</code>) is due to ‘historic’ reasons,
basically.</p>

<p>Nowadays, we encourage customers to make use of the <em>version-less</em> or <em>multi stream</em> EEs as <em>versioned</em> or <em>single stream</em> EEs are going to go away in the future.
I prefer using the terms <em>version-less</em> and <em>versioned</em> over <em>multi stream</em> and <em>single stream</em>, as it - in my opinion - more accurately describes what is meant.</p>

<p><em>Versioned</em> in this specific case refers to EEs that are build for a <em>specific</em> Ansible Automation Platform <strong>version</strong> - such as <code class="language-plaintext highlighter-rouge">ansible-automation-platform-24/ee-minimal-rhel9</code>.
From this example, the Ansible Automation Platform version that contains the EE <code class="language-plaintext highlighter-rouge">ee-minimal-rhel9</code> is 2.4. This is how EEs where distributed in the past.</p>

<p>Nowadays, EEs are rather independent of the Ansible Automation Platform version and are distributed ‘<em>independently</em>’, meaning not tied to a specific Ansible Automation
Platform version in that sense. Hence: <em>version-less</em>.</p>

<p>The idea behind the <em>version-less</em> EEs is basically to pick and chose which <code class="language-plaintext highlighter-rouge">ansible-core</code> version you’d like to have included in your EE. The
<a href="https://catalog.redhat.com/software/containers/ansible-automation-platform/ee-minimal-rhel8/62bd87442c0945582b2b4b37/history">version tags</a> of, for instance,
<code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel8</code> correspond to <code class="language-plaintext highlighter-rouge">ansible-core</code> versions.</p>

<p>One thing important to know: Often, container images make use of the <code class="language-plaintext highlighter-rouge">latest</code> tag, which commonly - who would have guessed it - refers to the latest available version of the
container image. But when you are trying to pull <code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel8:latest</code> using <code class="language-plaintext highlighter-rouge">podman</code>, you’ll be greeted with an error:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># podman pull ansible-automation-platform/ee-minimal-rhel8:latest</span>
Resolved <span class="s2">"ansible-automation-platform/ee-minimal-rhel8"</span> as an <span class="nb">alias</span> <span class="o">(</span>/etc/containers/registries.conf.d/001-rhel-shortnames.conf<span class="o">)</span>
Trying to pull registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:latest...
WARN[0001] Failed, retrying <span class="k">in </span>1s ... <span class="o">(</span>1/3<span class="o">)</span><span class="nb">.</span> Error: initializing <span class="nb">source </span>docker://registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:latest: reading manifest latest <span class="k">in </span>registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8: unsupported: This repository does not use the <span class="s2">"latest"</span> tag to track the most recent image and must be pulled with an explicit version or image reference. For more information, see: https://access.redhat.com/articles/4301321
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Don’t get confused that I am using <code class="language-plaintext highlighter-rouge">podman</code> to pull the EE. You don’t have to do the same. We’ll be using <code class="language-plaintext highlighter-rouge">ansible-builder</code> for that. Using <code class="language-plaintext highlighter-rouge">podman</code> in
this specific case is just easier.</p>

<p>In <a href="https://access.redhat.com/articles/4301321">Red Hat’s linked knowledge base article</a> it is explained <em>why</em> this change was introduced for a number of container images if
you are curious of the <em>why</em>. In the context of the <em>version-less</em> EEs you only need to know, that it doesn’t work <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>After all, users typically want the latest available version of <code class="language-plaintext highlighter-rouge">ansible-core</code> within the same <em>minor version</em> (the second digit in e.g 2.<strong>15</strong>.9).
It is not a good idea to jump from say <code class="language-plaintext highlighter-rouge">ansible-core</code> 2.15 to <code class="language-plaintext highlighter-rouge">ansible-core</code> 2.16 <em>without</em> evaluating what <em>changed</em> in between those versions. On the other hand,
you’d most likely want to have the <em>latest 2.15</em> version, e.g. 2.15.9, as <em>usually</em> there are no <em>breaking</em> or <em>major</em> changes within the same minor version.</p>

<p>If that’s a use-case you can relate to, then I have good news for you: You can specify the tag <code class="language-plaintext highlighter-rouge">2.15</code> on the execution environment, e.g.
<code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel8:2.15</code>, which will pull always the latest available version within this minor version, which is 2.15.x.</p>

<p>If you want to be more specific, you can do that too, simply specify a tag with an additional z-version (the last digit in e.g. 2.15.<strong>9</strong>), e.g.
<code class="language-plaintext highlighter-rouge">ansible-automation-platform/ee-minimal-rhel8:2.15.9</code></p>

<p>And if you want to make <em>extra sure</em> that the image your a pulling does not <em>change</em> even if you specify a z-version, you can include the <code class="language-plaintext highlighter-rouge">SHA checksum</code> (also called
<code class="language-plaintext highlighter-rouge">digest</code>) of the image in the name:
<code class="language-plaintext highlighter-rouge">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8@sha256:2a17184e6ea2200b1335c0a39d04159fd040d5ce7fc1990a9d424cc20cfacd4d</code>. This name refers to
<code class="language-plaintext highlighter-rouge">ee-minimal-rhel-8: 2.15.9-4</code>.</p>

<p>This way you ensure that you <em>never</em> get any other image than you used. In turn, however, this means you need to update the name regularly.</p>

<p>I, personally, don’t include the <code class="language-plaintext highlighter-rouge">digest</code> in the name, as I trust Red Hat to not replace an existing image version with a new one. In terms of security, however,
<strong>a bad actor</strong> <em>could</em> replace the image version with a new one. Specifying the <code class="language-plaintext highlighter-rouge">digest</code> will prevent you from pulling that image version.</p>

<p>One last thing to discuss is the absence of the <code class="language-plaintext highlighter-rouge">supported</code> variants (the ones that contain besides <code class="language-plaintext highlighter-rouge">ansible-core</code> also <em>some</em> <strong>supported</strong> Ansible collections) of EEs, as
well as the absence of the <em>special EE</em> (<code class="language-plaintext highlighter-rouge">ee-29-rhel8</code>) in <em>version-less</em> EEs.</p>

<p>For the <em>special EE</em> (<code class="language-plaintext highlighter-rouge">ee-29-rhel8</code>) the reason is simple: There is nothing to choose from. There is only Ansible Engine 2.9 to use and it was never intended to run on RHEL 9,
therefore there is only the RHEL 8 variant. Period. It will also go away in the future, as already mentioned.</p>

<p>For the <code class="language-plaintext highlighter-rouge">supported</code> variants the answer is a different one: Red Hat envisions that Ansible Automation Platform users are building their very own and very specific EEs that
fulfill exactly their needs on top of a supported <code class="language-plaintext highlighter-rouge">minimal</code> EE containing only <code class="language-plaintext highlighter-rouge">ansible-core</code>.</p>

<p>If you think a moment about it, it hopefully makes perfect sense to you. You likely have very specific requirements for an EE. Such as the <code class="language-plaintext highlighter-rouge">ansible-core</code> version used, the
included collections, the included Python packages, maybe you need access to a corporate proxy which requires you to include a set of certificate authority certificates into
your EE and so on and so forth. All these things couldn’t possibly come from Red Hat.</p>

<p>At first, this might mean to you that you’ll need to dive a little deeper into EEs than you’d like to, but it is worthwhile, and really easy.
I mean, the chances are high, that you’ll need to build your own EEs in the future if you are in a corporate environment - which most Red Hat customers are - so why not learn
to build them yourself right from the start.</p>

<p>In later sections, we’ll learn how to build complex EEs on top of your very own base EEs that fit <em>exactly</em> your specific requirement.
Just keep on reading <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>
<h2 id="using-existing-ees-with-ansible-navigator">
  
  
    Using existing EEs with <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#using-existing-ees-with-ansible-navigator">#</a>
  
  
</h2>
    

<p>After we’ve learned a lot about EEs in the previous chapters, let’s actually use them <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">. To use the EEs on the <code class="language-plaintext highlighter-rouge">CLI</code>, let me first
introduce you to <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. In an earlier chapter I have briefly touched on <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, but <code class="language-plaintext highlighter-rouge">ansible-navigator</code> is crucial for developing and testing
EEs before actually putting them into production - so we need to have a deeper look into it to actually leverage its functionalities.</p>
<h3 id="installing-ansible-navigator">
  
  
    Installing <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#installing-ansible-navigator">#</a>
  
  
</h3>
    

<p>There are multiple ways you can install <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, which are detailed in the
<a href="https://ansible.readthedocs.io/projects/navigator/installation/">installation documentation</a>.</p>

<p>To install a stable version of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> on RHEL (I’ll refer to it as <em>downstream</em>), you need access to one of the Red Hat Ansible Automation Platform
repositories, for instance:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Red Hat Ansible Automation Platform 2.4 for RHEL 8 x86_64 (RPMs)</code>, repository ID: <code class="language-plaintext highlighter-rouge">ansible-automation-platform-2.4-for-rhel-8-x86_64-rpms</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">Red Hat Ansible Automation Platform 2.4 for RHEL 9 x86_64 (RPMs)</code>, repository ID: <code class="language-plaintext highlighter-rouge">ansible-automation-platform-2.4-for-rhel-9-x86_64-rpms</code>
</li>
</ul>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Once again the hint that the above repositories require you to be a <a href="#existing-ees-an-overview">Red Hat subscriber</a>.</p>

<p>Simply enable the repository you’ve chosen using <code class="language-plaintext highlighter-rouge">subscription-manager</code>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>subscription-manager repos <span class="nt">--enable</span> ansible-automation-platform-2.4-for-rhel-8-x86_64-rpms
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>Then install <code class="language-plaintext highlighter-rouge">ansible-navigator</code> using <code class="language-plaintext highlighter-rouge">dnf</code> or <code class="language-plaintext highlighter-rouge">yum</code>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>ansible-navigator
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>If you’d rather like to use the latest available upstream version, you can do so with <a href="https://pypi.org/project/pip/"><code class="language-plaintext highlighter-rouge">pip</code></a>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>python3-pip
<span class="nv">$ </span>python3 <span class="nt">-m</span> pip <span class="nb">install </span>ansible-navigator <span class="nt">--user</span>
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>For <code class="language-plaintext highlighter-rouge">ansible-navigator</code> to be able to work with EEs, you either need <a href="https://podman.io/"><code class="language-plaintext highlighter-rouge">podman</code></a> or <a href="https://www.docker.com/"><code class="language-plaintext highlighter-rouge">docker</code></a> on your system, as we are going to use
containers and naturally need <em>something</em> to handle them <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">. I’ll use <code class="language-plaintext highlighter-rouge">podman</code> for the remainder of this post, but all commands I am going to use with
<code class="language-plaintext highlighter-rouge">podman</code> are working exactly the same when replacing <code class="language-plaintext highlighter-rouge">podman</code> with <code class="language-plaintext highlighter-rouge">docker</code>.</p>

<p>After all, we really only run <strong>one</strong> command with <code class="language-plaintext highlighter-rouge">podman</code>. The remainder will be handled by <code class="language-plaintext highlighter-rouge">ansible-builder</code> <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The upstream variant of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> is not exclusively available on RHEL; You can install it on a few more operating systems. Please refer to the
<a href="https://ansible.readthedocs.io/projects/navigator/installation/">installation documentation</a> to get an overview of all supported operating systems.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> There is one important difference in the above versions: The downstream variant of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> will default to an EE that is provided and supported by Red Hat,
while the upstream variant will default to an upstream EE. At the time of this writing, the downstream variant of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> of the Ansible Automation Platform 2.4
repository will pull <code class="language-plaintext highlighter-rouge">registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest</code> while the upstream variant will pull <code class="language-plaintext highlighter-rouge">ghcr.io/ansible/creator-ee</code>.</p>
<h3 id="getting-started-with-ansible-navigator">
  
  
    Getting started with <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#getting-started-with-ansible-navigator">#</a>
  
  
</h3>
    

<p>First up: <code class="language-plaintext highlighter-rouge">ansible-navigator</code> has a ton of features. We’ll only cover the very basics of it which gets you up to speed with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. If you’d like to dive deeper
into specific features of <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, the <a href="https://ansible.readthedocs.io/projects/navigator/">documentation</a> provides a good starting point for that.</p>

<p>As I mentioned already, <code class="language-plaintext highlighter-rouge">ansible-navigator</code> is meant to extend the current <code class="language-plaintext highlighter-rouge">CLI</code> tools, which you are most likely familiar with, such as:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ansible-playbook</code></li>
  <li><code class="language-plaintext highlighter-rouge">ansible-inventory</code></li>
  <li><code class="language-plaintext highlighter-rouge">ansible-doc</code></li>
  <li>etc.</li>
</ul>

<p>Extending the functionality of the ‘original’ <code class="language-plaintext highlighter-rouge">CLI</code> tools of Ansible means for <code class="language-plaintext highlighter-rouge">ansible-navigator</code> - in a nutshell - that it can work with EEs. First, you’d maybe think that
only <code class="language-plaintext highlighter-rouge">ansible-playbook</code> should be extended or superseded, as this command is where we actually run playbooks.</p>

<p>Let’s talk about this hypothesis.</p>

<p>It is easiest to show the difference using <code class="language-plaintext highlighter-rouge">ansible-galaxy collection list</code> and <code class="language-plaintext highlighter-rouge">ansible-doc</code>.</p>

<p>Let’s first check which collections I have installed locally:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-galaxy collection list

<span class="c"># /home/steffen/.ansible/collections/ansible_collections</span>
Collection                  Version
<span class="nt">---------------------------</span> <span class="nt">----------</span>
ansible.controller          4.3.0
ansible.netcommon           5.3.0
ansible.posix               1.5.4
ansible.tower               3.8.6
ansible.utils               2.10.3
ansible.windows             1.11.0
community.crypto            2.16.2
community.docker            3.3.2
community.general           7.3.0
community.mysql             3.4.0
community.postgresql        2.2.0
community.routeros          2.7.0
community.zabbix            1.9.1
containers.podman           1.10.1
infra.ah_configuration      2.0.2
kubernetes.core             2.3.2
openstack.cloud             2.0.0
redhat.openshift            2.2.0
redhat.rhel_system_roles    1.22.0
redhat.satellite            3.15.0
redhat.satellite_operations 2.1.0
sscheib.insights            0.0.2
theforeman.foreman          3.11.0-dev
zabbix.zabbix               1.2.2
</code></pre></div></div>

<p>Now, let’s try the same with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>.</p>

<p>First, as I use the downstream variant of <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, I need to login to the container registry of Red Hat (<code class="language-plaintext highlighter-rouge">registry.redhat.io</code>) - this the single <code class="language-plaintext highlighter-rouge">podman</code>
command that is <em>required</em> to know about when using the downstream variant of <code class="language-plaintext highlighter-rouge">ansible-navigator</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>podman login registry.redhat.io
Username: myUsername
Password:
Login Succeeded!
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> To learn which credentials you can use to login to <code class="language-plaintext highlighter-rouge">registry.redhat.io</code>, Red Hat has created a great
                     <a href="https://access.redhat.com/RegistryAuthentication">knowledge base article</a> which also explains how to use tokens for authentication instead of username
                     and password.</p>

<p>Let’s run the equivalent command using <code class="language-plaintext highlighter-rouge">ansible-navigator</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator collections list
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image and pull policy overview
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image name:     registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
Execution environment image tag:      latest
Execution environment pull arguments: None
Execution environment pull policy:    tag
Execution environment pull needed:    True
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Updating the execution environment
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Running the <span class="nb">command</span>: podman pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
Trying to pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest...
Getting image <span class="nb">source </span>signatures
Checking <span class="k">if </span>image destination supports signatures
Copying blob 4a22b5338626 skipped: already exists
Copying blob 161ea1f419fb skipped: already exists
Copying blob 72e13691cee8 skipped: already exists
Copying blob 74e0c06e5eac skipped: already exists
Copying config 996b5c1825 <span class="k">done
</span>Writing manifest to image destination
Storing signatures
996b5c1825b0b3d56296900606fe360a652d4633e0f517a6716bf489579808cc


   Name                                 Version    Shadowed    Type         Path
 0│amazon.aws                           6.4.0      False       contained    /usr/share/ansible/collections/ansible_collections/amazon/aws
 1│ansible.builtin                      2.15.9     False       contained    /usr/lib/python3.9/site-packages/ansible
 2│ansible.controller                   4.5.1      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/controller
 3│ansible.netcommon                    6.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/netcommon
 4│ansible.network                      3.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/network
 5│ansible.posix                        1.5.4      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/posix
 6│ansible.scm                          2.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/scm
 7│ansible.security                     2.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/security
 8│ansible.snmp                         2.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/snmp
 9│ansible.utils                        3.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/utils
10│ansible.windows                      1.14.0     False       contained    /usr/share/ansible/collections/ansible_collections/ansible/windows
11│ansible.yang                         2.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ansible/yang
12│arista.eos                           7.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/arista/eos
13│cisco.asa                            5.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/cisco/asa
14│cisco.ios                            6.1.0      False       contained    /usr/share/ansible/collections/ansible_collections/cisco/ios
15│cisco.iosxr                          7.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/cisco/iosxr
16│cisco.nxos                           6.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/cisco/nxos
17│cloud.common                         2.1.2      False       contained    /usr/share/ansible/collections/ansible_collections/cloud/common
18│cloud.terraform                      1.1.1      False       contained    /usr/share/ansible/collections/ansible_collections/cloud/terraform
19│frr.frr                              2.0.2      False       contained    /usr/share/ansible/collections/ansible_collections/frr/frr
20│ibm.qradar                           3.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/ibm/qradar
21│junipernetworks.junos                6.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/junipernetworks/junos
22│kubernetes.core                      2.4.0      False       contained    /usr/share/ansible/collections/ansible_collections/kubernetes/core
23│microsoft.ad                         1.1.0      False       contained    /usr/share/ansible/collections/ansible_collections/microsoft/ad
24│openvswitch.openvswitch              2.1.1      False       contained    /usr/share/ansible/collections/ansible_collections/openvswitch/openvswitch
25│redhat.amq_broker                    1.3.0      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/amq_broker
26│redhat.eap                           1.3.1      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/eap
27│redhat.insights                      1.0.7      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/insights
28│redhat.openshift                     2.3.0      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/openshift
29│redhat.redhat_csp_download           1.2.2      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/redhat_csp_download
30│redhat.rhel_idm                      1.10.0     False       contained    /usr/share/ansible/collections/ansible_collections/redhat/rhel_idm
31│redhat.rhel_system_roles             1.21.1     False       contained    /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles
32│redhat.rhv                           2.4.2      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/rhv
33│redhat.runtimes_common               1.0.2      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/runtimes_common
34│redhat.sap_install                   1.2.1      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/sap_install
35│redhat.satellite                     3.10.0     False       contained    /usr/share/ansible/collections/ansible_collections/redhat/satellite
36│redhat.satellite_operations          1.3.0      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/satellite_operations
37│redhat.sso                           1.2.1      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/sso
38│sap.sap_operations                   1.0.4      False       contained    /usr/share/ansible/collections/ansible_collections/sap/sap_operations
39│servicenow.itsm                      2.1.0      False       contained    /usr/share/ansible/collections/ansible_collections/servicenow/itsm
40│splunk.es                            3.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/splunk/es
41│trendmicro.deepsec                   3.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/trendmicro/deepsec
42│vmware.vmware_rest                   2.3.1      False       contained    /usr/share/ansible/collections/ansible_collections/vmware/vmware_rest
43│vyos.vyos                            4.0.2      False       contained    /usr/share/ansible/collections/ansible_collections/vyos/vyos
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> I copied the collection list from the text-based user interface of <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. A text-based user interface might be known to you from e.g.
<code class="language-plaintext highlighter-rouge">nmtui</code>, <code class="language-plaintext highlighter-rouge">tmux</code> or <code class="language-plaintext highlighter-rouge">vim</code>. All of them are based on the same library: <a href="https://en.wikipedia.org/wiki/Ncurses"><code class="language-plaintext highlighter-rouge">ncurses</code></a>, that’s why it might look familiar to you.</p>

<p>Looking at the above output, we can notice that there’s quite a difference to the previous <code class="language-plaintext highlighter-rouge">ansible-galaxy collection list</code>.</p>

<p>Why’s that?</p>

<p>First, the EE image gets pulled. <strong>After</strong> the EE image was pulled, it started <code class="language-plaintext highlighter-rouge">ansible-navigator</code> in the text-based user interface (<code class="language-plaintext highlighter-rouge">TUI</code>), and then finally the collections
are listed.</p>

<p>Now it might become clear why the majority of the <code class="language-plaintext highlighter-rouge">ansible-navigator</code> commands are run in an EE: To show correct information, <code class="language-plaintext highlighter-rouge">ansible-navigator</code> needs to access the Ansible
version inside the EE and with it all the collections, the documentation, the Python packages and so on and so forth.</p>

<p>That is why I can run <code class="language-plaintext highlighter-rouge">ansible-navigator doc vyos.vyos.vyos_static_routes</code> and get the documentation for it, but when I run the equivalent comment with <code class="language-plaintext highlighter-rouge">ansible-doc</code>, Ansible
only shows a warning:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-doc vyos.vyos.vyos_static_routes
<span class="o">[</span>WARNING]: vyos.vyos.vyos_static_routes was not found
</code></pre></div></div>

<p>The reason being that the collection <code class="language-plaintext highlighter-rouge">vyos.vyos</code> is installed within the EE <code class="language-plaintext highlighter-rouge">ansible-automation-platform-24/ee-supported-rhel8</code>, which is used
by <code class="language-plaintext highlighter-rouge">ansible-navigator</code> in this example, but not on my local system, where the <code class="language-plaintext highlighter-rouge">ansible-doc vyos.vyos.vyos_static_routes</code> command will look for.</p>
<h3 id="an-overview-of-the-commands-of-ansible-navigator">
  
  
    An overview of the commands of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#an-overview-of-the-commands-of-ansible-navigator">#</a>
  
  
</h3>
    

<p>With the previous chapter, we found out why it makes sense to have the majority of the conventional Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools extended with EE support. But what features does
<code class="language-plaintext highlighter-rouge">ansible-navigator</code> actually provide?</p>

<p>Let’s have a look at the <code class="language-plaintext highlighter-rouge">--help</code> output of <code class="language-plaintext highlighter-rouge">ansible-navigator</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator <span class="nt">--help</span>
Usage: ansible-navigator <span class="o">[</span>options]

<span class="o">[</span>..]

Subcommands:
 <span class="o">{</span>subcommand<span class="o">}</span> <span class="nt">--help</span>
  builder                                        Build <span class="o">[</span>execution environment]<span class="o">(</span>https://docs.ansible.com/ansible/devel/getting_started_ee/index.html<span class="o">)</span> <span class="o">(</span>container image<span class="o">)</span>
  collections                                    Explore available collections
  config                                         Explore the current ansible configuration
  doc                                            Review documentation <span class="k">for </span>a module or plugin
  <span class="nb">exec                                           </span>Run a <span class="nb">command </span>within an execution environment
  images                                         Explore execution environment images
  inventory                                      Explore an inventory
  lint                                           Lint a file or directory <span class="k">for </span>common errors and issues
  replay                                         Explore a previous run using a playbook artifact
  run                                            Run a playbook
  settings                                       Review the current ansible-navigator settings
  welcome                                        Start at the welcome page
</code></pre></div></div>

<p>That’s quite a lot of sub-commands, but how do they map to the original Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools?</p>

<p>The answer is not as straight-forward as you might think. First off: <code class="language-plaintext highlighter-rouge">ansible-navigator</code> is an <strong>extension</strong> to the original Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools, <strong>not</strong> a <strong>replacement</strong>.
Having said that, <em>some</em> original Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools are incorporated into <code class="language-plaintext highlighter-rouge">ansible-navigator</code>:</p>

<p>Let me start with the obvious ones:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ansible command</th>
      <th style="text-align: left">ansible-navigator command</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-galaxy collection list</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-navigator collections list</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-config</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-navigator config</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-doc</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-navigator doc</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-inventory</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-navigator inventory</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-playbook</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ansible-navigator run</code></td>
    </tr>
  </tbody>
</table>

<p>The above table shows the most common Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools, but a few are missing:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ansible</code></li>
  <li><code class="language-plaintext highlighter-rouge">ansible-test</code></li>
  <li><code class="language-plaintext highlighter-rouge">ansible-vault</code></li>
</ul>

<p>For both <code class="language-plaintext highlighter-rouge">ansible</code> and <code class="language-plaintext highlighter-rouge">ansible-test</code> you can use the <code class="language-plaintext highlighter-rouge">exec</code> sub-command. For an Ansible ad-hoc command this will look like the following:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator <span class="nb">exec</span> <span class="nt">--</span> ansible <span class="nt">-m</span> ping localhost
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image and pull policy overview
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image name:     registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
Execution environment image tag:      latest
Execution environment pull arguments: None
Execution environment pull policy:    tag
Execution environment pull needed:    True
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Updating the execution environment
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Running the <span class="nb">command</span>: podman pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
Trying to pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest...
Getting image <span class="nb">source </span>signatures
Checking <span class="k">if </span>image destination supports signatures
Copying blob 4a22b5338626 skipped: already exists
Copying blob 72e13691cee8 skipped: already exists
Copying blob 161ea1f419fb skipped: already exists
Copying blob 74e0c06e5eac skipped: already exists
Copying config 996b5c1825 <span class="k">done
</span>Writing manifest to image destination
Storing signatures
996b5c1825b0b3d56296900606fe360a652d4633e0f517a6716bf489579808cc
localhost | SUCCESS <span class="o">=&gt;</span> <span class="o">{</span>
    <span class="s2">"changed"</span>: <span class="nb">false</span>,
    <span class="s2">"ping"</span>: <span class="s2">"pong"</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Personally</strong>, I do not see much sense in using <code class="language-plaintext highlighter-rouge">ansible-vault</code> and <code class="language-plaintext highlighter-rouge">ansible-test</code> with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>; It is just easier to stick with the original <code class="language-plaintext highlighter-rouge">CLI</code> tools for them.</p>

<p>If you’d really like to do it, here are the commands:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator <span class="nb">exec</span> <span class="nt">--</span> ansible-test <span class="nt">--help</span>
<span class="nv">$ </span>ansible-navigator <span class="nb">exec</span> <span class="nt">--</span> ansible-vault <span class="nt">--help</span>
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>What essentially is done with <code class="language-plaintext highlighter-rouge">ansible-navigator exec</code> is to execute commands inside the EE. No more, no less. For the ad-hoc commands, this can definitively be a benefit to
run it inside an EE, but for <code class="language-plaintext highlighter-rouge">ansible-test</code> and <code class="language-plaintext highlighter-rouge">ansible-vault</code> I don’t see the value. If you know a use-case, please let me know! <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

<p>Lastly, there are also some sub-commands that are specific to <code class="language-plaintext highlighter-rouge">ansible-navigator</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">builder</code></li>
  <li><code class="language-plaintext highlighter-rouge">images</code></li>
  <li><code class="language-plaintext highlighter-rouge">lint</code></li>
  <li><code class="language-plaintext highlighter-rouge">replay</code></li>
  <li><code class="language-plaintext highlighter-rouge">settings</code></li>
</ul>

<p>Let me start with the ones, where I do not see a benefit in using them directly with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, but your mileage my vary:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">builder</code>: You could theoretically build EEs using <code class="language-plaintext highlighter-rouge">ansible-navigator builder</code>, but under the hood it basically calls <code class="language-plaintext highlighter-rouge">ansible-builder</code>, so I decided to stick to
<code class="language-plaintext highlighter-rouge">ansible-builder</code> directly</li>
  <li>
<code class="language-plaintext highlighter-rouge">lint</code>: With <code class="language-plaintext highlighter-rouge">ansible-navigator lint</code> you can lint your Ansible code, <em>if</em> <code class="language-plaintext highlighter-rouge">ansible-lint</code> is installed. Essentially, it calls <code class="language-plaintext highlighter-rouge">ansible-lint</code> under the hood, so I decided to
 stick to <code class="language-plaintext highlighter-rouge">ansible-lint</code> directly</li>
</ul>

<p>So what’s left for sub-commands are <code class="language-plaintext highlighter-rouge">images</code>, <code class="language-plaintext highlighter-rouge">replay</code> and <code class="language-plaintext highlighter-rouge">settings</code>.</p>

<p>With <code class="language-plaintext highlighter-rouge">ansible-navigator settings</code> you can view the current settings of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> and create sample settings.</p>
<h3 id="configuration-of-ansible-navigator">
  
  
    Configuration of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#configuration-of-ansible-navigator">#</a>
  
  
</h3>
    

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="https://ansible.readthedocs.io/projects/navigator/settings/">configuration file locations</a> follow the same logic as the well-known
<code class="language-plaintext highlighter-rouge">ansible.cfg</code>.</p>

<p>Following locations are valid:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> in your current working directory</li>
  <li>
<code class="language-plaintext highlighter-rouge">~/.ansible-navigator.yml</code> in your home directory</li>
</ul>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> configuration file in your current working directory has precedence over the <code class="language-plaintext highlighter-rouge">~/.ansible-navigator.yml</code> in your home directory.</p>

<p>Alternatively, you can override the configuration file location with an environment variable: <code class="language-plaintext highlighter-rouge">ANSIBLE_NAVIGATOR_CONFIG</code>. Please note that the environment variable
<code class="language-plaintext highlighter-rouge">ANSIBLE_NAVIGATOR_CONFIG</code> has the highest precedence.</p>

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> settings can either be stored in <code class="language-plaintext highlighter-rouge">YAML</code> or <code class="language-plaintext highlighter-rouge">JSON</code>. For <code class="language-plaintext highlighter-rouge">YAML</code> the file extension needs to either be <code class="language-plaintext highlighter-rouge">.yml</code> or <code class="language-plaintext highlighter-rouge">.yaml</code>. For <code class="language-plaintext highlighter-rouge">JSON</code> it is <code class="language-plaintext highlighter-rouge">.json</code>.</p>

<p>Decide on either format (I suggest <code class="language-plaintext highlighter-rouge">YAML</code>, of course <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">) and make sure that only <em>one</em> configuration file is present in either of the locations. If
<code class="language-plaintext highlighter-rouge">ansible-navigator</code> finds more than one configuration file in one of the possible configuration file locations, it will error out:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator settings <span class="nt">--help</span>
  Error: Only one file among <span class="s1">'/home/steffen/.ansible-navigator.yml'</span>,
         <span class="s1">'/home/steffen/.ansible-navigator.yaml'</span> and
         <span class="s1">'/home/steffen/.ansible-navigator.json'</span> should be present <span class="k">in</span>
         /home/steffen Found: <span class="s1">'/home/steffen/.ansible-navigator.yml'</span> and
         <span class="s1">'/home/steffen/.ansible-navigator.json'</span>

   Note: Configuration failed, using default log file location.
         <span class="o">(</span>/home/steffen/ansible-navigator.log<span class="o">)</span> Log level <span class="nb">set </span>to debug
   Hint: Review the hints and log file to see what went wrong.
</code></pre></div></div>

<p>You can find a <a href="https://ansible.readthedocs.io/projects/navigator/settings/">sample configuration</a> in the documentation or you can generate one using <code class="language-plaintext highlighter-rouge">ansible-navigator</code>.</p>

<p>Okay, let’s generate a sample configuration using <code class="language-plaintext highlighter-rouge">ansible-navigator settings --sample</code> and redirect the output to <code class="language-plaintext highlighter-rouge">~/.ansible-navigator.yml</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator settings <span class="nt">--sample</span> <span class="o">&gt;</span> ~/.ansible-navigator.yml
Trying to pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest...
Getting image <span class="nb">source </span>signatures
Checking <span class="k">if </span>image destination supports signatures
Copying blob 4a22b5338626 skipped: already exists
Copying blob 161ea1f419fb skipped: already exists
Copying blob 72e13691cee8 skipped: already exists
Copying blob 74e0c06e5eac skipped: already exists
Copying config 996b5c1825 <span class="k">done
</span>Writing manifest to image destination
Storing signatures
</code></pre></div></div>

<p>Unfortunately, this leaves us with a broken configuration, as part of the image pulling is also part of the <code class="language-plaintext highlighter-rouge">~/.ansible-navigator.yml</code> configuration file:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> ~/.ansible-navigator.yml
996b5c1825b0b3d56296900606fe360a652d4633e0f517a6716bf489579808cc
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image and pull policy overview
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Execution environment image name:     registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
Execution environment image tag:      latest
Execution environment pull arguments: None
Execution environment pull policy:    tag
Execution environment pull needed:    True
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Updating the execution environment
<span class="nt">--------------------------------------------------------------------------------------------------------------</span>
Running the <span class="nb">command</span>: podman pull registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel8:latest
<span class="nt">---</span>
ansible-navigator:
<span class="c">#   ansible:</span>
<span class="c">#     config:</span>
<span class="c">#       # Help options for ansible-config command in stdout mode</span>
<span class="c">#       help: False</span>
<span class="c">#       # Specify the path to the ansible configuration file</span>
<span class="c">#       path: ./ansible.cfg</span>
<span class="o">[</span>..]
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> From my point of view, the indentation in the generated <code class="language-plaintext highlighter-rouge">ansible-navigator</code> sample configuration is wrong. Technically, and according to
the <a href="https://yaml.org/spec/1.2.2/#61-indentation-spaces"><code class="language-plaintext highlighter-rouge">YAML</code> specification 1.2.2</a>, <em>any</em> number of spaces is fine.</p>
<blockquote>
  <p>In <code class="language-plaintext highlighter-rouge">YAML</code> block styles, structure is determined by indentation. In general, indentation is defined as a zero or more space characters at the start of a line.
I think, however, that either two (preferred) or four spaces are the common number of spaces used for indentation.</p>
</blockquote>

<p>The only way I found to overcome this is to create a small configuration file that disables using EEs and will be overwritten by our redirect:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> ~/.ansible-navigator.yml
<span class="nt">---</span>
ansible-navigator:
  execution-environment:
    enabled: <span class="nb">false</span>
...
</code></pre></div></div>

<p>It is not possible to specify the same settings on the <code class="language-plaintext highlighter-rouge">CLI</code> as then <code class="language-plaintext highlighter-rouge">ansible-navigator</code> will error out:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator settings <span class="nt">--ee</span> <span class="nb">false</span> <span class="nt">--sample</span>
Warning: Issues were found <span class="k">while </span>applying the settings.
   Hint: Command provided: <span class="s1">'settings --ee false --sample'</span>

  Error: Settings file found /home/steffen/ansible-navigator.yaml, but failed to load it.
           error was: <span class="s1">'Settings file cannot be empty.'</span>
   Hint: Try checking the settings file <span class="s1">'/home/steffen/ansible-navigator.yaml'</span>and ensure it is properly formatted

   Note: Configuration failed, using default log file location. <span class="o">(</span>/home/steffen/ansible-navigator.log<span class="o">)</span> Log level <span class="nb">set </span>to debug
   Hint: Review the hints and log file to see what went wrong.
</code></pre></div></div>
<h3 id="my-configuration-for-ansible-navigator">
  
  
    My configuration for <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#my-configuration-for-ansible-navigator">#</a>
  
  
</h3>
    

<p>Below you’ll find one of configurations I am using. I don’t have a configuration in my home directory: The reason being that I store a copy of my <code class="language-plaintext highlighter-rouge">ansible.cfg</code>, my
<code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> and various other configurations in a ‘project’ directory. This project directory is structured per use-case and that’s why I have special settings in
each <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> and <code class="language-plaintext highlighter-rouge">ansible.cfg</code> - such as number of forks, the Ansible remote user and the EE to use.</p>

<p>I’ll write a separate blog post about how and why I structure my projects this way in the distant future, as I have been asked a couple of times already how I develop
Ansible code and how I organize things - but that’s a topic for the other blog post.</p>

<p>Below is the configuration of my <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> for my project <code class="language-plaintext highlighter-rouge">ansible-project-satellite</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">ansible-navigator</span><span class="pi">:</span>
  <span class="na">mode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">stdout'</span>
  <span class="na">logging</span><span class="pi">:</span>
    <span class="na">level</span><span class="pi">:</span> <span class="s1">'</span><span class="s">critical'</span>
    <span class="na">append</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/dev/null'</span>

  <span class="na">color</span><span class="pi">:</span>
    <span class="na">enable</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">osc4</span><span class="pi">:</span> <span class="no">true</span>

  <span class="na">editor</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">vim_from_setting'</span>
    <span class="na">console</span><span class="pi">:</span> <span class="no">true</span>

  <span class="na">inventory-columns</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ansible_network_os'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ansible_network_cli_ssh_type'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ansible_connection'</span>

  <span class="na">execution-environment</span><span class="pi">:</span>
    <span class="na">container-engine</span><span class="pi">:</span> <span class="s1">'</span><span class="s">podman'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost/ee-ansible_project-satellite-rhel-8:latest'</span>
    <span class="na">pull</span><span class="pi">:</span>
      <span class="na">policy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">never'</span>

  <span class="na">playbook-artifact</span><span class="pi">:</span>
    <span class="na">enable</span><span class="pi">:</span> <span class="no">false</span>

  <span class="na">ansible</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./ansible.cfg'</span>
    <span class="na">doc</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">inventory</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">entries</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">./inventory/'</span>

  <span class="na">ansible-lint</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./.ansible-lint'</span>

  <span class="na">time-zone</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Europe/Berlin'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>It is a very minimal configuration and should not be taken as “the correct configuration to use”. This is my preference, yours probably differ.</p>

<p>Following a quick summary of the settings I applied:</p>

<ol>
  <li>I don’t want to log to a log-file, that’s why basically ‘redirect’ the log to <code class="language-plaintext highlighter-rouge">/dev/null</code>
</li>
  <li>I’d like to have colors in my terminal <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">. And yes, I develop on the <code class="language-plaintext highlighter-rouge">CLI</code> using <code class="language-plaintext highlighter-rouge">vim</code> only <img class="emoji" title=":satisfied:" alt=":satisfied:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png" height="20" width="20">!</li>
  <li>The editor that should be used when editing anything in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> should be <code class="language-plaintext highlighter-rouge">vim</code>
</li>
  <li>I added a few more <code class="language-plaintext highlighter-rouge">inventory-columns</code> that I find interesting</li>
  <li>I set <code class="language-plaintext highlighter-rouge">podman</code> as my <code class="language-plaintext highlighter-rouge">container-engine</code> and specified a specific image to use. I also never want <code class="language-plaintext highlighter-rouge">ansible-navigator</code> to pull the image, because it is locally available</li>
  <li>I don’t want to use <code class="language-plaintext highlighter-rouge">playbook-artifacts</code> - we’ll talk about that in a moment</li>
  <li>I specify the <code class="language-plaintext highlighter-rouge">ansible.cfg</code> and the <code class="language-plaintext highlighter-rouge">inventories</code> to use and disable all help in the <code class="language-plaintext highlighter-rouge">TUI</code>
</li>
  <li>I played around with <code class="language-plaintext highlighter-rouge">ansible-lint</code> in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> and left the <code class="language-plaintext highlighter-rouge">ansible-lint</code> setting pointing to my configuration file</li>
  <li>Lastly, I specified the time-zone. This will be used for calculating the time when using <code class="language-plaintext highlighter-rouge">playbook-artifacts</code>
</li>
</ol>
<h3 id="playbook-artifacts-in-ansible-navigator">
  
  
    <code class="language-plaintext highlighter-rouge">playbook-artifacts</code> in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#playbook-artifacts-in-ansible-navigator">#</a>
  
  
</h3>
    

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> does not only extend the original Ansible <code class="language-plaintext highlighter-rouge">CLI</code> tools with EEs, but also brings some new features to the table. One of them is <code class="language-plaintext highlighter-rouge">playbook-artifacts</code>.
<code class="language-plaintext highlighter-rouge">playbook-artifacts</code> are essentially a structured way of saving the events of a playbook run.</p>

<p>At first, this might sound boring and not useful at all, but here is the thing which makes it great:</p>

<p>You can replay any playbook (using <code class="language-plaintext highlighter-rouge">ansible-navigator replay</code>) by using the created playbook artifact. This allows for easier troubleshooting as every task is written to the
artifact file with both the arguments it was executed with and what the result of it was.</p>

<p>This can be beneficial as you are able to troubleshoot easier. And if you ever hit a roadblock and simply cannot find out what’s wrong, you just share the artifact with one of
your colleagues and can get your colleague’s help that way.</p>

<p>I personally don’t use them at all times. I enable the artifact creation when I need it.</p>
<h3 id="modes-of-ansible-navigator">
  
  
    Modes of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#modes-of-ansible-navigator">#</a>
  
  
</h3>
    

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> comes with two modes:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">interactive</code>: That’s the default and provides you with the <code class="language-plaintext highlighter-rouge">TUI</code> to interact with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. This mode is required when replaying artifacts. It is also helpful
 when looking at existing EEs to determine what’s in them.</li>
  <li>
<code class="language-plaintext highlighter-rouge">stdout</code>: <code class="language-plaintext highlighter-rouge">stdout</code> is essentially the ‘good old look’ of <code class="language-plaintext highlighter-rouge">ansible-playbook</code>. I prefer using this mode for most of the things I do with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>.</li>
</ol>

<p>The mode can either be saved in the configuration file (<a href="#my-configuration-for-ansible-navigator">as in my above configuration file</a> or can be overwritten by specifying the
<code class="language-plaintext highlighter-rouge">-m</code> or <code class="language-plaintext highlighter-rouge">--mode</code> parameter, like in the following example:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator <span class="nt">-m</span> stdout
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->
<h3 id="navigating-in-ansible-navigator-when-using-the-text-based-user-interface-tui">
  
  
    Navigating in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> when using the text-based user interface (<code class="language-plaintext highlighter-rouge">TUI</code>) <a href="#navigating-in-ansible-navigator-when-using-the-text-based-user-interface-tui">#</a>
  
  
</h3>
    

<p>Navigation in the <code class="language-plaintext highlighter-rouge">TUI</code> of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> is easy and straight-forward when you are used to <code class="language-plaintext highlighter-rouge">vim</code>.</p>

<p>If you are not used to <code class="language-plaintext highlighter-rouge">vim</code>, here is a quick run through:
Pressing <code class="language-plaintext highlighter-rouge">:</code> will enable you to call the different functions. Say you wanted to check the images <code class="language-plaintext highlighter-rouge">ansible-navigator</code> knows about, then you’ll simply type <code class="language-plaintext highlighter-rouge">:images</code> and press enter.</p>

<p>Getting help is done via <code class="language-plaintext highlighter-rouge">:help</code>, looking at collections is done via <code class="language-plaintext highlighter-rouge">:collections</code>, and so on.</p>

<p>There are also shortcuts available (as you might have noticed when looking at <code class="language-plaintext highlighter-rouge">:help</code>). For instance, <code class="language-plaintext highlighter-rouge">:im</code> calls <code class="language-plaintext highlighter-rouge">:images</code>, <code class="language-plaintext highlighter-rouge">:h</code> calls <code class="language-plaintext highlighter-rouge">:help</code>, etc. The shortcuts are listed
in <code class="language-plaintext highlighter-rouge">:help</code>. Going back a screen is done by pressing escape on your keyboard and you can quit <code class="language-plaintext highlighter-rouge">ansible-navigator</code> with <code class="language-plaintext highlighter-rouge">:quit</code> or <code class="language-plaintext highlighter-rouge">:q</code>.</p>

<p>So, once you are in one of these functions, you’ll notice on the left-hand side a numbering which starts at 0.</p>

<p>Let’s look into an example of <code class="language-plaintext highlighter-rouge">ansible-navigator images</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Image                                                    Tag                                          Execution environment                 Created                  Size
0│ansible-test-utility-container                           2.0.0                                        False                                 15 months ago            7.7 MB
1│default-test-container                                   7.14.0                                       False                                 9 months ago             1.6 GB
2│ee-ansible_project-zabbix-rhel-8                         latest                                       True                                  2 months ago             436 MB
3│ee-minimal-rhel8                                         2.15                                         True                                  4 months ago             338 MB
4│ee-supported-rhel8                                       latest                                       True                                  2 weeks ago              1.73 GB
5│rootfs                                                   x86-generic-openwrt-22.03                    False                                 4 months ago             12.1 MB
6│rootfs                                                   x86-generic-openwrt-21.02                    False                                 4 months ago             10.5 MB
7│rootfs                                                   x86-generic-snapshot                         False                                 10 months ago            9.15 MB
</code></pre></div></div>

<p>If I now want to know more about the EE <code class="language-plaintext highlighter-rouge">ee-supported-rhel8</code>, I simply press <code class="language-plaintext highlighter-rouge">3</code> and I’ll be offered a different set of options:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Image: ee-supported-rhel:latest                                                            Description
0│Image information                                                                          Information collected from image inspection
1│General information                                                                        OS and python version information
2│Ansible version and collections                                                            Information about ansible and ansible collections
3│Python packages                                                                            Information about python and python packages
4│Operating system packages                                                                  Information about operating system packages
5│Everything                                                                                 All image information
</code></pre></div></div>

<p>To know more about the Ansible version and the EEs included collections, I press <code class="language-plaintext highlighter-rouge">2</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Image: ee-supported-rhel8:latest (primary) (Information about ansible and ansible collections)
 0│---
 1│ansible:
 2│  collections:
 3│    details:
 4│      amazon.aws: 6.4.0
 5│      ansible.controller: 4.5.1
 6│      ansible.netcommon: 6.0.0
 7│      ansible.network: 3.0.0
 8│      ansible.posix: 1.5.4
 9│      ansible.scm: 2.0.0
10│      ansible.security: 2.0.0
11│      ansible.snmp: 2.0.0
12│      ansible.utils: 3.0.0
13│      ansible.windows: 1.14.0
14│      ansible.yang: 2.0.0
15│      arista.eos: 7.0.0
16│      cisco.asa: 5.0.0
17│      cisco.ios: 6.1.0
18│      cisco.iosxr: 7.0.0
19│      cisco.nxos: 6.0.0
20│      cloud.common: 2.1.2
21│      cloud.terraform: 1.1.1
22│      frr.frr: 2.0.2
23│      ibm.qradar: 3.0.0
24│      junipernetworks.junos: 6.0.0
25│      kubernetes.core: 2.4.0
26│      microsoft.ad: 1.1.0
27│      openvswitch.openvswitch: 2.1.1
28│      redhat.amq_broker: 1.3.0
29│      redhat.eap: 1.3.1
30│      redhat.insights: 1.0.7
31│      redhat.openshift: 2.3.0
32│      redhat.redhat_csp_download: 1.2.2
33│      redhat.rhel_idm: 1.10.0
34│      redhat.rhel_system_roles: 1.21.1
35│      redhat.rhv: 2.4.2
36│      redhat.runtimes_common: 1.0.2
37│      redhat.sap_install: 1.2.1
38│      redhat.satellite: 3.10.0
39│      redhat.satellite_operations: 1.3.0
40│      redhat.sso: 1.2.1
41│      sap.sap_operations: 1.0.4
42│      servicenow.itsm: 2.1.0
43│      splunk.es: 3.0.0
44│      trendmicro.deepsec: 3.0.0
45│      vmware.vmware_rest: 2.3.1
46│      vyos.vyos: 4.0.2
47│  version:
48│    details: ansible [core 2.15.9]
</code></pre></div></div>

<p>Now I can see what Ansible collections are part of the EE, great <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>If you have more than 9 options available, you need to make use of <code class="language-plaintext highlighter-rouge">:10</code>, followed by pressing enter to get to the 10th item, or <code class="language-plaintext highlighter-rouge">:35</code> followed by pressing enter to get to
the 35th item. This is exactly the way you’d navigate to line numbers in <code class="language-plaintext highlighter-rouge">vim</code> <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Whenever there is nothing more <code class="language-plaintext highlighter-rouge">ansible-navigator</code> can show to you by selecting an item from the list - like with the collections above - it’ll simply do
nothing. So when I would want to get more information about the Satellite collection, which is item 38 and type <code class="language-plaintext highlighter-rouge">:38</code> followed by enter, <code class="language-plaintext highlighter-rouge">ansible-navigator</code> will do nothing.</p>
<h3 id="running-playbooks-in-ansible-navigator">
  
  
    Running playbooks in <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#running-playbooks-in-ansible-navigator">#</a>
  
  
</h3>
    

<p>Now we’ve learned a lot about <code class="language-plaintext highlighter-rouge">ansible-navigator</code>, but let’s actually use it.</p>

<p>I have the following <em>very</em> simple playbook:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Configure</span><span class="nv"> </span><span class="s">SSHD'</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s1">'</span><span class="s">g_satellites'</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># required for the role redhat.rhel_system_roles.sshd'</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s1">'</span><span class="s">file_deployment'</span>
    <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.rhel_system_roles.sshd'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>In the above playbook I merely include two roles:</p>

<ol>
  <li>My own role <a href="https://github.com/sscheib/ansible-role-file_deployment"><code class="language-plaintext highlighter-rouge">file_deployment</code></a> which places two files on the managed nodes that are required to configure <code class="language-plaintext highlighter-rouge">sshd</code>
in the way I want it</li>
  <li>The RHEL system role to configure <code class="language-plaintext highlighter-rouge">sshd</code>:
<a href="https://console.redhat.com/ansible/automation-hub/repo/published/redhat/rhel_system_roles/content/role/sshd/"><code class="language-plaintext highlighter-rouge">redhat.rhel_system_roles.sshd</code></a>
</li>
</ol>

<p>For this little demo, I specified
<a href="https://catalog.redhat.com/software/containers/ansible-automation-platform-24/ee-supported-rhel8/63a333ce183540f5962ae01d">ansible-automation-platform-24/ee-supported-rhel8</a> as
the EE to use and set the pull policy to <code class="language-plaintext highlighter-rouge">missing</code> in the <code class="language-plaintext highlighter-rouge">ansible-navigator</code> configuration file in my working directory (<code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code>). I further specified to
use as inventory the directory <code class="language-plaintext highlighter-rouge">./inventory</code> and to use the <code class="language-plaintext highlighter-rouge">ansible.cfg</code> that is in my current directory:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">ansible-navigator</span><span class="pi">:</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
  <span class="na">execution-environment</span><span class="pi">:</span>
    <span class="na">container-engine</span><span class="pi">:</span> <span class="s1">'</span><span class="s">podman'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ee-supported-rhel8'</span>
    <span class="na">pull</span><span class="pi">:</span>
      <span class="na">policy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">missing'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
  <span class="na">ansible</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./ansible.cfg'</span>
    <span class="na">doc</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">inventory</span><span class="pi">:</span>
      <span class="na">help</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">entries</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">./inventory/'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>Let’s quickly examine the folder structure in this directory:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree <span class="nb">.</span>
<span class="nb">.</span>
├── ansible.cfg
├── ansible-navigator.yml
├── collections
│   └── requirements.yml
├── inventory
│   ├── g_satellites.yml
│   ├── host_vars
│   │   ├── satellite.office.int.scheib.me
│   │   │   ├── 00a_secrets.yml
│   │   │   ├── 00b_secrets_base.yml
│   │   │   ├── 00c_register_satellite.yml
│   │   │   ├── 00d_user_deployment.yml
│   │   │   ├── 00e_package_installation.yml
│   │   │   ├── 00f_service_management.yml
│   │   │   ├── 00g_file_deployment.yml
│   │   └── satellite.pve.ext.scheib.me
│   │       ├── 00a_secrets.yml
│   │       ├── 00b_secrets_base.yml
│   │       ├── 00c_register_satellite.yml
│   │       ├── 00d_user_deployment.yml
│   │       ├── 00e_package_installation.yml
│   │       ├── 00f_service_management.yml
│   │       ├── 00g_sshd.yml
│   └── ungrouped.yml
├── playbooks
│   ├── 000_setup.yml
│   ├── 00_create_kickstart.yml
│   ├── 01a_register_satellite.yml
│   ├── 01b_user_deployment.yml
│   ├── 01c_package_installation.yml
│   ├── 01d_service_management.yml
│   ├── 01e_sshd.yml
│   ├── 01f_generate_ssl_key_pairs.yml
│   ├── files
│   │   ├── sshd_issue.net
│   │   └── sshd_motd
│   ├── group_vars -&gt; ../inventory/group_vars/
│   └── host_vars -&gt; ../inventory/host_vars/
└── roles
    └── requirements.yml

20 directories, 159 files
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The directory contains <em>way more</em> files and directories than shown above (see the last line in the output above), but I removed a lot of the output
to shorten it a little.</p>

<p>My hosts are in this specific case in the group <code class="language-plaintext highlighter-rouge">g_satellites</code> which is defined in the file <code class="language-plaintext highlighter-rouge">inventory/g_satellites.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">g_satellites</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="na">satellite.office.int.scheib.me</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">satellite.pve.ext.scheib.me</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>The corresponding <code class="language-plaintext highlighter-rouge">host_vars</code> for both hosts are stored in <code class="language-plaintext highlighter-rouge">inventory/host_vars/&lt;hostname&gt;</code>. Both <code class="language-plaintext highlighter-rouge">host_vars</code> directories contain a file <code class="language-plaintext highlighter-rouge">00g_sshd.yml</code> which is where I get
the settings for the RHEL system role <code class="language-plaintext highlighter-rouge">redhat.rhel_system_roles.sshd</code>.</p>

<p>As an example what one of them looks like:</p>

<!-- markdownlint-disable MD003 MD022 -->

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="nn">---</span>
<span class="na">sshd_enable</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd_skip_defaults</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd_manage_firewall</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd_manage_selinux</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd_sysconfig</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd_sysconfig_override_crypto_policy</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">sshd</span><span class="pi">:</span>
  <span class="na">AddressFamily</span><span class="pi">:</span> <span class="s1">'</span><span class="s">inet'</span>
  <span class="na">AllowAgentForwarding</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">AllowTcpForwarding</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">AllowStreamLocalForwarding</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">AuthenticationMethods</span><span class="pi">:</span> <span class="s1">'</span><span class="s">publickey'</span>
  <span class="na">AuthorizedKeysFile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%h/.ssh/authorized_keys'</span>
  <span class="na">Banner</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/etc/issue.net'</span>
  <span class="na">ChallengeResponseAuthentication</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">ChrootDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">none'</span>
  <span class="na">Ciphers</span><span class="pi">:</span> <span class="pi">&gt;-</span>
    <span class="s">{{</span>
      <span class="s">[</span>
        <span class="s">'chacha20-poly1305@openssh.com',</span>
        <span class="s">'aes256-gcm@openssh.com',</span>
        <span class="s">'aes128-gcm@openssh.com',</span>
        <span class="s">'aes256-ctr',</span>
        <span class="s">'aes192-ctr',</span>
        <span class="s">'aes128-ctr'</span>
      <span class="s">] | join\(',')</span>
    <span class="s">}}</span>
  <span class="na">ClientAliveCountMax</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">ClientAliveInterval</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">Compression</span><span class="pi">:</span> <span class="s1">'</span><span class="s">delayed'</span>
  <span class="na">FingerprintHash</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sha512'</span>
  <span class="na">GatewayPorts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">HostbasedAuthentication</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">HostKey</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">/etc/ssh/ssh_host_ecdsa_key'</span>
  <span class="na">HostKeyAlgorithms</span><span class="pi">:</span> <span class="pi">&gt;-</span>
    <span class="s">{{</span>
      <span class="s">[</span>
        <span class="s">'ecdsa-sha2-nistp256-cert-v01@openssh.com',</span>
        <span class="s">'ecdsa-sha2-nistp384-cert-v01@openssh.com',</span>
        <span class="s">'ecdsa-sha2-nistp521-cert-v01@openssh.com',</span>
        <span class="s">'ecdsa-sha2-nistp256',</span>
        <span class="s">'ecdsa-sha2-nistp384',</span>
        <span class="s">'ecdsa-sha2-nistp521'</span>
      <span class="s">] | join\(',')</span>
    <span class="s">}}</span>
  <span class="na">IgnoreRhosts</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">IPQoS</span><span class="pi">:</span> <span class="s1">'</span><span class="s">lowdelay</span><span class="nv"> </span><span class="s">throughput'</span>
  <span class="na">KexAlgorithms</span><span class="pi">:</span> <span class="pi">&gt;-</span>
    <span class="s">{{</span>
      <span class="s">[</span>
        <span class="s">'curve25519-sha256@libssh.org',</span>
        <span class="s">'ecdh-sha2-nistp521',</span>
        <span class="s">'ecdh-sha2-nistp384',</span>
        <span class="s">'ecdh-sha2-nistp256',</span>
        <span class="s">'diffie-hellman-group-exchange-sha256'</span>
      <span class="s">] | join\(',')</span>
    <span class="s">}}</span>
  <span class="na">ListenAddress</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">0.0.0.0'</span>
  <span class="na">LoginGraceTime</span><span class="pi">:</span> <span class="m">60</span>
  <span class="na">LogLevel</span><span class="pi">:</span> <span class="s1">'</span><span class="s">VERBOSE'</span>
  <span class="na">MACs</span><span class="pi">:</span> <span class="pi">&gt;-</span>
    <span class="s">{{</span>
      <span class="s">[</span>
        <span class="s">'hmac-sha2-512-etm@openssh.com',</span>
        <span class="s">'hmac-sha2-256-etm@openssh.com',</span>
        <span class="s">'umac-128-etm@openssh.com',</span>
        <span class="s">'hmac-sha2-512',</span>
        <span class="s">'hmac-sha2-256',</span>
        <span class="s">'umac-128@openssh.com'</span>
      <span class="s">] | join\(',')</span>
    <span class="s">}}</span>
  <span class="na">MaxAuthTries</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">MaxSessions</span><span class="pi">:</span> <span class="m">6</span>
  <span class="na">MaxStartups</span><span class="pi">:</span> <span class="s1">'</span><span class="s">10:30:60'</span>
  <span class="na">PasswordAuthentication</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PermitEmptyPasswords</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PermitRootLogin</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PermitTunnel</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PermitTTY</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">PermitUserEnvironment</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PermitUserRC</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">PidFile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/var/run/sshd.pid'</span>
  <span class="na">Port</span><span class="pi">:</span> <span class="m">1905</span>
  <span class="na">PrintMotd</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">Protocol</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">PubkeyAcceptedKeyTypes</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521'</span>
  <span class="na">PubkeyAuthentication</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">RekeyLimit</span><span class="pi">:</span> <span class="s1">'</span><span class="s">64M</span><span class="nv"> </span><span class="s">4H'</span>
  <span class="na">Subsystem</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sftp</span><span class="nv"> </span><span class="s">internal-sftp'</span>
  <span class="na">StrictModes</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">SyslogFacility</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AUTH'</span>
  <span class="na">TCPKeepAlive</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">UseDNS</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">VersionAddendum</span><span class="pi">:</span> <span class="s1">'</span><span class="s">none'</span>
  <span class="na">X11Forwarding</span><span class="pi">:</span> <span class="no">false</span>
<span class="nn">...</span></code></pre></figure>

<!-- markdownlint-enable MD003 MD022 -->

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> As a side note: Yes, the configuration above is
<a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standards">Federal Information Processing Standards (<code class="language-plaintext highlighter-rouge">FIPS</code>)</a> compliant <img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">.</p>

<p>Finally, there are also <code class="language-plaintext highlighter-rouge">host_vars</code> for my role <code class="language-plaintext highlighter-rouge">file_deployment</code>. As an example you’ll find below the configuration for one of the hosts:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">fd_files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sshd_motd'</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/etc/motd'</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s1">'</span><span class="s">root'</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">root'</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0644'</span>

  <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sshd_issue.net'</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/etc/issue.net'</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s1">'</span><span class="s">root'</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">root'</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0644'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>The corresponding files are stored in <code class="language-plaintext highlighter-rouge">playbooks/files</code>.</p>

<p><em>Locally installed</em> I have my custom role as well as the collection <code class="language-plaintext highlighter-rouge">redhat.rhel_system_roles</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-galaxy role list
<span class="c"># /home/steffen/.ansible/roles</span>
- sscheib.filebeat, <span class="o">(</span>unknown version<span class="o">)</span>
- ansible-timesync, <span class="o">(</span>unknown version<span class="o">)</span>
- willshersystems.sshd, v0.17.0
- ansible-role-logrotate, <span class="o">(</span>unknown version<span class="o">)</span>
- ansible-role-rsyslog, <span class="o">(</span>unknown version<span class="o">)</span>
- ansible-sshd, <span class="o">(</span>unknown version<span class="o">)</span>
- zabbix_add_host, v1.0.6
- satellite_proxmox_compute_ressource, v1.0
- sscheib.openwrt_dropbear, <span class="o">(</span>unknown version<span class="o">)</span>
- openwrt_dropbear, <span class="o">(</span>unknown version<span class="o">)</span>
- satellite_create_host, v1.0.2
- satellite_publish_promote_content_views, v1.0.2
- satellite_prepare_installation, v1.0.3
- satellite_template_synchronization, v1.0.2
- satellite_global_parameters, v1.0.1
- file_deployment, v1.0.1
- rhel_iso_kickstart, v2.0.6
- user_deployment, v1.0.5
- package_installation, v1.0.1
- service_management, v1.0.2
- generate_ssl_key_pairs, v1.1.5
- register_to_satellite, v1.0.4
<span class="c"># /usr/share/ansible/roles</span>
<span class="c"># /etc/ansible/roles</span>

<span class="nv">$ </span>ansible-galaxy collection list

<span class="c"># /home/steffen/.ansible/collections/ansible_collections</span>
Collection                  Version
<span class="nt">---------------------------</span> <span class="nt">----------</span>
ansible.controller          4.3.0
ansible.netcommon           5.3.0
ansible.posix               1.5.4
ansible.tower               3.8.6
ansible.utils               2.10.3
ansible.windows             1.11.0
community.crypto            2.16.2
community.docker            3.3.2
community.general           7.3.0
community.mysql             3.4.0
community.postgresql        2.2.0
community.routeros          2.7.0
community.zabbix            1.9.1
containers.podman           1.10.1
infra.ah_configuration      2.0.2
kubernetes.core             2.3.2
openstack.cloud             2.0.0
redhat.openshift            2.2.0
redhat.rhel_system_roles    1.22.0
redhat.satellite            3.15.0
redhat.satellite_operations 2.1.0
sscheib.insights            0.0.2
theforeman.foreman          3.11.0-dev
zabbix.zabbix               1.2.2
</code></pre></div></div>

<p>That should do it, right? <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20"></p>

<p>Let’s see what happens:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-navigator run <span class="nt">-m</span> stdout playbooks/01e_sshd.yml <span class="nt">--limit</span> satellite.office.int.scheib.me
ERROR! the role <span class="s1">'file_deployment'</span> was not found <span class="k">in</span> /home/steffen/sources/ansible-project-satellite/playbooks/roles:/home/runner/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:/home/steffen/sources/ansible-project-satellite/playbooks

The error appears to be <span class="k">in</span> <span class="s1">'/home/steffen/sources/ansible-project-satellite/playbooks/01e_sshd.yml'</span>: line 7, column 7, but may
be elsewhere <span class="k">in </span>the file depending on the exact syntax problem.

The offending line appears to be:

  roles:
    - role: <span class="s1">'file_deployment'</span>
      ^ here
Please review the log <span class="k">for </span>errors.
</code></pre></div></div>

<p>That’s certainly correct. The role is not part of my project directory, nor is it part of the EE. Let’s see if we can <em>somehow</em> make it work <em>without</em> building a custom EE
that contains the role.</p>

<p>Let’s adjust the <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> configuration a little:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">ansible-navigator</span><span class="pi">:</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
  <span class="na">execution-environment</span><span class="pi">:</span>
    <span class="na">container-engine</span><span class="pi">:</span> <span class="s1">'</span><span class="s">podman'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ee-supported-rhel8'</span>
    <span class="na">pull</span><span class="pi">:</span>
      <span class="na">policy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">missing'</span>
    <span class="na">volume-mounts</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">~/.ansible/roles/'</span>
        <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/home/runner/.ansible/roles'</span>
        <span class="na">options</span><span class="pi">:</span> <span class="s1">'</span><span class="s">z'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>We just specified a <a href="https://docs.podman.io/en/v4.4/markdown/podman-volume-mount.1.html"><code class="language-plaintext highlighter-rouge">volume mount</code></a>, which is a container feature to mount a local directory into the
container’s filesystem.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The above description of a <code class="language-plaintext highlighter-rouge">volume mount</code> is overly simplified. If you’d like to know more about <code class="language-plaintext highlighter-rouge">volume mounts</code>, please consult the
<a href="https://docs.podman.io/en/latest/markdown/podman-volume-mount.1.html">documentation</a> of <code class="language-plaintext highlighter-rouge">podman</code>.</p>

<p>Rerunning the playbook seems to work now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ansible-navigator run -m stdout playbooks/01e_sshd.yml --limit satellite.office.int.scheib.me

PLAY [Configure SSHD] ****************************************************************************************************************************************************************

TASK [file_deployment : Include tasks to ensure all variables are defined properly] **************************************************************************************************
included: /home/runner/.ansible/roles/file_deployment/tasks/assert.yml for satellite.office.int.scheib.me

TASK [file_deployment : Ensure mandatory variables, as  well as variables, which have a default value, are set (boolean)] ************************************************************
ok: [satellite.office.int.scheib.me] =&gt; (item=variable: _fd_quiet_assert) =&gt; {
    "__t_var": "_fd_quiet_assert",
    "ansible_loop_var": "__t_var",
    "changed": false,
    "msg": "Variable '_fd_quiet_assert' defined properly - value: 'False'"
}

TASK [file_deployment : Ensure _fd_packages is defined properly] *********************************************************************************************************************
ok: [satellite.office.int.scheib.me] =&gt; {
    "changed": false,
    "msg": "Files are defined correctly"
}

TASK [file_deployment : Include tasks to deploy files] *******************************************************************************************************************************
included: /home/runner/.ansible/roles/file_deployment/tasks/file_deployment.yml for satellite.office.int.scheib.me

TASK [file_deployment : file_deployment | Deploy files] ******************************************************************************************************************************
ok: [satellite.office.int.scheib.me] =&gt; (item=/etc/motd)
ok: [satellite.office.int.scheib.me] =&gt; (item=/etc/issue.net)

TASK [redhat.rhel_system_roles.sshd : Invoke the role, if enabled] *******************************************************************************************************************
included: /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/roles/sshd/tasks/sshd.yml for satellite.office.int.scheib.me
[..]
</code></pre></div></div>

<p>Perfect! Right? <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20"></p>

<p>Well, yes, but no <img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">. Here is the thing: If you’d use a customized EE that contains itself also roles, the above <code class="language-plaintext highlighter-rouge">volume mount</code> would effectively overwrite the directory
in that sense, that the <code class="language-plaintext highlighter-rouge">volume mount</code> would overlay the existing roles.</p>

<p>To accommodate for that scenario we have two options:</p>

<ol>
  <li>
    <p>Specify a different roles directory using an Ansible configuration option:</p>

    <p><a href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#default-roles-path"><code class="language-plaintext highlighter-rouge">roles_path</code></a>. We could also specify it via the environment variable
 <code class="language-plaintext highlighter-rouge">ANSIBLE_ROLES_PATH</code></p>
  </li>
  <li>
    <p>Mount our local roles directory to a different directory that is checked by Ansible by default</p>

    <p>If we recall the error from above, where it couldn’t find the role, there was an important piece of information in the error message - the search paths for Ansible roles:</p>
  </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR! the role 'file_deployment' was not found in /home/steffen/sources/ansible-project-satellite/playbooks/roles:/home/runner/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:/home/steffen/sources/ansible-project-satellite/playbooks
</code></pre></div></div>

<p>So, Ansible will look at:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/home/steffen/sources/ansible-project-satellite/playbooks/roles</code></li>
  <li><code class="language-plaintext highlighter-rouge">/home/runner/.ansible/roles</code></li>
  <li><code class="language-plaintext highlighter-rouge">/usr/share/ansible/roles:/etc/ansible/roles</code></li>
  <li><code class="language-plaintext highlighter-rouge">/home/steffen/sources/ansible-project-satellite/playbooks</code></li>
</ul>

<p>We could therefore modify the volume mount to use either <code class="language-plaintext highlighter-rouge">/home/runner/.ansible/roles</code> or <code class="language-plaintext highlighter-rouge">/usr/share/ansible/roles:/etc/ansible/roles</code>.</p>

<p>Let’s take the safer approach by adjusting the <code class="language-plaintext highlighter-rouge">roles_path</code>.</p>

<p>Do you recall that I specified the <code class="language-plaintext highlighter-rouge">ansible.cfg</code> in the <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> file? We can take advantage of that!</p>

<p>We first adjust our <code class="language-plaintext highlighter-rouge">ansible-navigator.yml</code> to mount the roles somewhere else:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">ansible-navigator</span><span class="pi">:</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
  <span class="na">execution-environment</span><span class="pi">:</span>
    <span class="na">container-engine</span><span class="pi">:</span> <span class="s1">'</span><span class="s">podman'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ee-supported-rhel8'</span>
    <span class="na">pull</span><span class="pi">:</span>
      <span class="na">policy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">missing'</span>
    <span class="na">volume-mounts</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">~/.ansible/roles/'</span>
        <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/home/runner/custom_roles/'</span>
        <span class="na">options</span><span class="pi">:</span> <span class="s1">'</span><span class="s">z'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>Finally, we add the following to our <code class="language-plaintext highlighter-rouge">ansible.cfg</code>:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[defaults]</span>
<span class="py">roles_path</span>          <span class="p">=</span> <span class="s">$HOME/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:$HOME/custom_roles</span>
</code></pre></div></div>

<p>Let us check whether everything works as intended:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-navigator run -m stdout playbooks/01e_sshd.yml --limit satellite.office.int.scheib.me

PLAY [Configure SSHD] ****************************************************************************************************************************************************************

TASK [file_deployment : Include tasks to ensure all variables are defined properly] **************************************************************************************************
included: /home/runner/custom_roles/file_deployment/tasks/assert.yml for satellite.office.int.scheib.me

TASK [file_deployment : Ensure mandatory variables, as  well as variables, which have a default value, are set (boolean)] ************************************************************
ok: [satellite.office.int.scheib.me] =&gt; (item=variable: _fd_quiet_assert) =&gt; {
    "__t_var": "_fd_quiet_assert",
    "ansible_loop_var": "__t_var",
    "changed": false,
    "msg": "Variable '_fd_quiet_assert' defined properly - value: 'False'"
}

TASK [file_deployment : Ensure _fd_packages is defined properly] *********************************************************************************************************************
ok: [satellite.office.int.scheib.me] =&gt; {
    "changed": false,
    "msg": "Files are defined correctly"
}

TASK [file_deployment : Include tasks to deploy files] *******************************************************************************************************************************
included: /home/runner/custom_roles/file_deployment/tasks/file_deployment.yml for satellite.office.int.scheib.me

TASK [file_deployment : file_deployment | Deploy files] ******************************************************************************************************************************
ok: [satellite.office.int.scheib.me] =&gt; (item=/etc/motd)
[..]
</code></pre></div></div>

<p>Awesome <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">!</p>

<p>But wait a minute - why does it know about my files in <code class="language-plaintext highlighter-rouge">playbooks/files</code> and even about the <code class="language-plaintext highlighter-rouge">host_vars</code> and all that?</p>

<p><code class="language-plaintext highlighter-rouge">ansible-navigator</code> mounts the current directory (‘project directory’) automatically inside the EE. This is why everything is working
<a href="https://ansible.readthedocs.io/projects/navigator/faq/#where-should-the-ansiblecfg-file-go-when-using-an-execution-environment">auto-magically</a> <img class="emoji" title=":rocket:" alt=":rocket:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f680.png" height="20" width="20">.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> It is great to play around like that on your development machine, but this is not something that should be used in production. <strong>Instead building custom EEs is the
way to go</strong>. This ensures portability and eliminates the typical problems of “.. but it works on my machine!”. I just wanted to show case what’s possible with
<code class="language-plaintext highlighter-rouge">ansible-navigator</code> <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20"></p>
<h3 id="mounting-certificates-inside-the-ee-while-using-ansible-navigator">
  
  
    Mounting certificates inside the <code class="language-plaintext highlighter-rouge">EE</code> while using <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <a href="#mounting-certificates-inside-the-ee-while-using-ansible-navigator">#</a>
  
  
</h3>
    

<p>At times you might not want to build a new <code class="language-plaintext highlighter-rouge">EE</code> to provide an <code class="language-plaintext highlighter-rouge">EE</code> with your custom certificates. For this instance, you can utilize the
<a href="#running-playbooks-in-ansible-navigator">aforementioned</a> <a href="https://docs.podman.io/en/latest/markdown/podman-volume-mount.1.html"><code class="language-plaintext highlighter-rouge">volume mounts</code></a> with a special flag: <code class="language-plaintext highlighter-rouge">:O</code>.</p>

<p>The <a href="https://docs.podman.io/en/v4.9.0/markdown/podman-run.1.html#volume-v-source-volume-host-dir-container-dir-options">flag <code class="language-plaintext highlighter-rouge">:O</code></a> mounts the directory as
<a href="https://docs.kernel.org/filesystems/overlayfs.html"><code class="language-plaintext highlighter-rouge">Overlay filesystem</code></a>, which makes it ‘immutable’. Any changes to a mounted <code class="language-plaintext highlighter-rouge">Overlay filesystem</code> are temporary and will
only happen in the container’s context - not on the host the mount originated from.</p>

<p>Additionally, <code class="language-plaintext highlighter-rouge">podman</code> applies the <code class="language-plaintext highlighter-rouge">private</code> <code class="language-plaintext highlighter-rouge">SELinux label</code> to the mount, which is the same as when specifying <code class="language-plaintext highlighter-rouge">:z</code> (as we used <a href="#running-playbooks-in-ansible-navigator">above</a>).</p>

<p>This enables you to use it <a href="https://github.com/containers/podman/blob/main/docs/tutorials/rootless_tutorial.md"><code class="language-plaintext highlighter-rouge">rootless</code></a> in <code class="language-plaintext highlighter-rouge">podman</code>, without the need to relabel the
<code class="language-plaintext highlighter-rouge">SELinux</code> labels on your certificates.</p>

<p>To make use of this feature for your certificates, you’ll need to specify the following in your <code class="language-plaintext highlighter-rouge">ansible-navigator</code> configuration file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">volume-mounts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/etc/pki/ca-trust'</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/etc/pki/ca-trust'</span>
    <span class="na">options</span><span class="pi">:</span> <span class="s1">'</span><span class="s">O'</span>
</code></pre></div></div>

<p>Of course, you can mount all sorts of host directories the same way - this is not specifically tied to certificates.</p>
<h2 id="building-custom-ees-with-ansible-builder">
  
  
    Building custom EEs with <code class="language-plaintext highlighter-rouge">ansible-builder</code> <a href="#building-custom-ees-with-ansible-builder">#</a>
  
  
</h2>
    

<p>Now that we learned a ton of stuff about <code class="language-plaintext highlighter-rouge">ansible-navigator</code> and its capabilities, let’s take a closer look at <code class="language-plaintext highlighter-rouge">ansible-builder</code>.</p>

<p><code class="language-plaintext highlighter-rouge">ansible-builder</code> is essentially a wrapper that calls <code class="language-plaintext highlighter-rouge">podman</code> to create container images for running Ansible content - the EEs, we talked about. While using existing EEs
gives you a quick start, there will be a point, where the existing EEs just don’t fit your needs (anymore). Here is where <code class="language-plaintext highlighter-rouge">ansible-builder</code> comes in.</p>
<h3 id="installing-ansible-builder">
  
  
    Installing <code class="language-plaintext highlighter-rouge">ansible-builder</code> <a href="#installing-ansible-builder">#</a>
  
  
</h3>
    

<p>There are multiple ways you can install <code class="language-plaintext highlighter-rouge">ansible-builder</code>, which are detailed in the
<a href="https://ansible.readthedocs.io/projects/builder/en/latest/installation/">installation documentation</a>.</p>

<p>To install a stable version of <code class="language-plaintext highlighter-rouge">ansible-builder</code> on RHEL (I’ll refer to it as <em>downstream</em>), you need access to one of the Red Hat Ansible Automation Platform
repositories, for instance:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Red Hat Ansible Automation Platform 2.4 for RHEL 8 x86_64 (RPMs)</code>, repository ID: <code class="language-plaintext highlighter-rouge">ansible-automation-platform-2.4-for-rhel-8-x86_64-rpms</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">Red Hat Ansible Automation Platform 2.4 for RHEL 9 x86_64 (RPMs)</code>, repository ID: <code class="language-plaintext highlighter-rouge">ansible-automation-platform-2.4-for-rhel-9-x86_64-rpms</code>
</li>
</ul>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Once again the hint that the above repositories require you to be a <a href="#existing-ees-an-overview">Red Hat subscriber</a>.</p>

<p>Simply enable the repository you’ve chosen using <code class="language-plaintext highlighter-rouge">subscription-manager</code>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>subscription-manager repos <span class="nt">--enable</span> ansible-automation-platform-2.4-for-rhel-8-x86_64-rpms
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>Then install <code class="language-plaintext highlighter-rouge">ansible-navigator</code> using <code class="language-plaintext highlighter-rouge">dnf</code> or <code class="language-plaintext highlighter-rouge">yum</code>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>ansible-navigator
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>If you’d rather like to use the latest available upstream version, you can do so with <a href="https://pypi.org/project/pip/"><code class="language-plaintext highlighter-rouge">pip</code></a>:</p>

<!-- markdownlint-disable MD014 -->
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dnf <span class="nb">install </span>python3-pip
<span class="nv">$ </span>python3 <span class="nt">-m</span> pip <span class="nb">install </span>ansible-builder <span class="nt">--user</span>
</code></pre></div></div>
<!-- markdownlint-enable MD014 -->

<p>For <code class="language-plaintext highlighter-rouge">ansible-builder</code> to be able to build EEs, you either need <a href="https://podman.io/"><code class="language-plaintext highlighter-rouge">podman</code></a> or <a href="https://www.docker.com/"><code class="language-plaintext highlighter-rouge">docker</code></a> on your system, as we are going to
build containers and naturally need <em>something</em> to handle them <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">. I’ll use <code class="language-plaintext highlighter-rouge">podman</code> for the remainder of this post, but all commands I am going to use
with <code class="language-plaintext highlighter-rouge">podman</code> are working exactly the same when replacing <code class="language-plaintext highlighter-rouge">podman</code> with <code class="language-plaintext highlighter-rouge">docker</code>.</p>

<p>After all, we really only run <strong>one</strong> command with <code class="language-plaintext highlighter-rouge">podman</code>. The remainder will be handled by <code class="language-plaintext highlighter-rouge">ansible-builder</code> <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The upstream variant of <code class="language-plaintext highlighter-rouge">ansible-builder</code> is not exclusively available on RHEL; You can install it on a few more operating systems. Please refer to the
<a href="https://ansible.readthedocs.io/projects/builder/en/latest/installation/">installation documentation</a> to get an overview of all supported operating systems.</p>
<h3 id="getting-started-with-ansible-builder">
  
  
    Getting started with <code class="language-plaintext highlighter-rouge">ansible-builder</code> <a href="#getting-started-with-ansible-builder">#</a>
  
  
</h3>
    

<p>First off: I am going to talk about <code class="language-plaintext highlighter-rouge">ansible-builder</code> v3 which was released by
Red Hat with the <a href="https://access.redhat.com/support/policy/updates/ansible-automation-platform">Ansible Automation Platform 2.4</a>. With v3 of <code class="language-plaintext highlighter-rouge">ansible-builder</code> a new, <em>way</em> more
flexible format of writing EE definitions has been introduced. Please upgrade to <code class="language-plaintext highlighter-rouge">ansible-builder</code> v3+ if you haven’t yet. It makes a <strong>huge</strong> difference.</p>

<p>Having said that, let’s first look at the help output of <code class="language-plaintext highlighter-rouge">ansible-builder</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-builder <span class="nt">--help</span>
usage: ansible-builder <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">--version</span><span class="o">]</span> <span class="o">{</span>create,build,introspect<span class="o">}</span> ...

Tooling to <span class="nb">help </span>build container images <span class="k">for </span>running Ansible content. Get started by looking at the <span class="nb">help </span>text <span class="k">for </span>one of the subcommands.

positional arguments:
  <span class="o">{</span>create,build,introspect<span class="o">}</span>
                        The <span class="nb">command </span>to invoke.
    create              Creates a build context, which can be used by podman to build an image.
    build               Builds a container image.
    introspect          Introspects collections <span class="k">in </span>folder.

optional arguments:
  <span class="nt">-h</span>, <span class="nt">--help</span>            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">--version</span>             Print ansible-builder version and exit.
</code></pre></div></div>

<p>Okay, that’s a <em>lot less</em> possibilities than with <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. Don’t let yourself fool. This is all you <strong>need</strong>.</p>

<p>Actually, we really only need <code class="language-plaintext highlighter-rouge">create</code> and <code class="language-plaintext highlighter-rouge">build</code> as commands.</p>

<p><code class="language-plaintext highlighter-rouge">introspect</code> is used by <code class="language-plaintext highlighter-rouge">ansible-builder</code> itself to figure out dependencies of collections. That is something
we do not need at the moment, but surely is helpful if you are interested in finding out why a specific system or Python package has been installed.</p>

<p>Let me quickly show you what it looks like when I let <code class="language-plaintext highlighter-rouge">ansible-builder introspect</code> check my installed collections:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-builder introspect ~/.ansible/collections/
<span class="c"># Dependency data for /home/steffen/.ansible/collections/</span>
<span class="nt">---</span>
python:
  ansible.controller:
  - <span class="s1">'pytz  # for schedule_rrule lookup plugin'</span>
  - <span class="s1">'python-dateutil&gt;=2.7.0  # schedule_rrule'</span>
  - <span class="s1">'awxkit  # For import and export modules'</span>
  ansible.netcommon:
  - ansible-pylibssh <span class="o">&gt;=</span> 0.2.0
  - jxmlease
  - ncclient
  - netaddr
  - paramiko
  - xmltodict
  - grpcio
  - protobuf
  ansible.tower:
  - <span class="s1">'pytz  # for tower_schedule_rrule lookup plugin'</span>
  - <span class="s1">'python-dateutil&gt;=2.7.0  # tower_schedule_rrule'</span>
  - <span class="s1">'awxkit  # For import and export modules'</span>
  ansible.utils:
  - jsonschema
  - textfsm
  - ttp
  - xmltodict
  - netaddr
  community.crypto:
  - PyYAML
  community.docker:
  - docker
  - requests
  - paramiko
  community.routeros:
  - librouteros
  kubernetes.core:
  - kubernetes&gt;<span class="o">=</span>12.0.0
  - requests-oauthlib
  - jsonpatch
  openstack.cloud:
  - openstacksdk&gt;<span class="o">=</span>1.0.0
  redhat.openshift:
  - kubernetes&gt;<span class="o">=</span>12.0.0
  - requests-oauthlib
  redhat.satellite:
  - requests&gt;<span class="o">=</span>2.4.2
  - ipaddress<span class="p">;</span> python_version &lt; <span class="s1">'3.3'</span>
  - PyYAML
  sscheib.insights:
  - requests
  theforeman.foreman:
  - requests&gt;<span class="o">=</span>2.4.2
  - ipaddress<span class="p">;</span> python_version &lt; <span class="s1">'3.3'</span>
  - PyYAML
  zabbix.zabbix:
  - netaddr&gt;<span class="o">=</span>0.8
  - Jinja2&gt;<span class="o">=</span>3.1.2

system:
  ansible.controller:
  - python38-pytz <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python38-requests <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python38-pyyaml <span class="o">[</span>platform:centos-8 platform:rhel-8]
  ansible.netcommon:
  - gcc-c++ <span class="o">[</span>doc <span class="nb">test </span>platform:rpm]
  - libyaml-devel <span class="o">[</span><span class="nb">test </span>platform:rpm]
  - libyaml-dev <span class="o">[</span><span class="nb">test </span>platform:dpkg]
  - python3-devel <span class="o">[</span><span class="nb">test </span>platform:rpm]
  - python3 <span class="o">[</span><span class="nb">test </span>platform:rpm]
  - gcc <span class="o">[</span>compile platform:rpm]
  - libssh-dev <span class="o">[</span>compile platform:dpkg]
  - libssh-devel <span class="o">[</span>compile platform:rpm]
  - python3-Cython <span class="o">[</span>compile platform:fedora-35 platform:rhel-9]
  - python3-six <span class="o">[</span>platform:centos-9 platform:rhel-9]
  - python39-six <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python3-lxml <span class="o">[</span>platform:centos-9 platform:rhel-9]
  - python39-lxml <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - findutils <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - gcc <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - make <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - python3-devel <span class="o">[</span>compile platform:centos-9 platform:rhel-9]
  - python39-devel <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - python3-cffi <span class="o">[</span>platform:centos-9 platform:rhel-9]
  - python39-cffi <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python3-cryptography <span class="o">[</span>platform:centos-9 platform:rhel-9]
  - python39-cryptography <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python3-pycparser <span class="o">[</span>platform:centos-9 platform:rhel-9]
  - python39-pycparser <span class="o">[</span>platform:centos-8 platform:rhel-8]
  ansible.posix:
  - rsync <span class="o">[</span>platform:redhat]
  ansible.utils:
  - gcc-c++ <span class="o">[</span>doc <span class="nb">test </span>platform:rpm]
  - python3-devel <span class="o">[</span><span class="nb">test </span>platform:rpm]
  - python3 <span class="o">[</span><span class="nb">test </span>platform:rpm]
  community.crypto:
  - cryptsetup <span class="o">[</span>platform:dpkg]
  - cryptsetup <span class="o">[</span>platform:rpm]
  - openssh-client <span class="o">[</span>platform:dpkg]
  - openssh-clients <span class="o">[</span>platform:rpm]
  - openssl <span class="o">[</span>platform:dpkg]
  - openssl <span class="o">[</span>platform:rpm]
  - python3-cryptography <span class="o">[</span>platform:dpkg]
  - python3-cryptography <span class="o">[</span>platform:rpm]
  - python3-openssl <span class="o">[</span>platform:dpkg]
  - python3-pyOpenSSL <span class="o">[</span>platform:rpm <span class="o">!</span>platform:rhel <span class="o">!</span>platform:centos <span class="o">!</span>platform:rocky]
  - python3-pyOpenSSL <span class="o">[</span>platform:rhel-8]
  - python3-pyOpenSSL <span class="o">[</span>platform:rhel <span class="o">!</span>platform:rhel-6 <span class="o">!</span>platform:rhel-7 <span class="o">!</span>platform:rhel-8
    epel]
  - python3-pyOpenSSL <span class="o">[</span>platform:centos-8]
  - python3-pyOpenSSL <span class="o">[</span>platform:centos <span class="o">!</span>platform:centos-6 <span class="o">!</span>platform:centos-7 <span class="o">!</span>platform:centos-8
    epel]
  - python3-pyOpenSSL <span class="o">[</span>platform:rocky-8]
  - python3-pyOpenSSL <span class="o">[</span>platform:rocky <span class="o">!</span>platform:rocky-8 epel]
  infra.ah_configuration:
  - python <span class="o">&gt;=</span>3.5
  kubernetes.core:
  - kubernetes-client <span class="o">[</span>platform:fedora]
  - openshift-clients <span class="o">[</span>platform:rhel-8]
  openstack.cloud:
  - gcc <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - python38-cryptography <span class="o">[</span>platform:centos-8 platform:rhel-8]
  - python38-devel <span class="o">[</span>compile platform:centos-8 platform:rhel-8]
  - python38-requests <span class="o">[</span>platform:centos-8 platform:rhel-8]
  redhat.rhel_system_roles:
  - openssl
  - dnf
  redhat.satellite:
  - python3-rpm <span class="o">[(</span>platform:redhat platform:base-py3<span class="o">)]</span>
  - rpm-python <span class="o">[(</span>platform:redhat platform:base-py2<span class="o">)]</span>
  - python38-requests <span class="o">[</span>platform:centos-8 platform:rhel-8]
  sscheib.insights:
  - python38-requests <span class="o">[</span>platform:centos-8 platform:rhel-8]
  theforeman.foreman:
  - python3-rpm <span class="o">[(</span>platform:redhat platform:base-py3<span class="o">)]</span>
  - rpm-python <span class="o">[(</span>platform:redhat platform:base-py2<span class="o">)]</span>
  - python38-requests <span class="o">[</span>platform:centos-8 platform:rhel-8]
</code></pre></div></div>

<p>That’s quite a bunch of system and Python packages <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>Again, <code class="language-plaintext highlighter-rouge">ansible-builder introspect</code> is not particularly useful, unless you debug an issue with dependencies. I just wanted you to know, that <em>if</em> there is an issue with
dependencies while building EEs, this command can be pretty handy.</p>

<p>Now that we have the the <code class="language-plaintext highlighter-rouge">introspect</code> out of the way, let’s look at the two remaining sub-commands:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">create</code></li>
  <li><code class="language-plaintext highlighter-rouge">build</code></li>
</ul>

<p>In a nutshell, <code class="language-plaintext highlighter-rouge">ansible-builder create</code> creates a so-called <em>build context</em> for you - remember, we want to build containers. Building containers is done via a
<a href="https://www.mankier.com/5/Containerfile"><code class="language-plaintext highlighter-rouge">Containerfile</code></a> (for <code class="language-plaintext highlighter-rouge">podman</code>) or a <a href="https://docs.docker.com/reference/dockerfile/"><code class="language-plaintext highlighter-rouge">Dockerfile</code></a> (for <code class="language-plaintext highlighter-rouge">docker</code>) which comes in a
specific format. <code class="language-plaintext highlighter-rouge">Containerfile</code> and <code class="language-plaintext highlighter-rouge">Dockerfile</code> definitions are <em>largely</em> interchangeable (there <em>were</em> differences in the past, but I don’t know if it is the same today).</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Further in this post I’ll use <code class="language-plaintext highlighter-rouge">Containerfile</code> as reference to make things easier. Just know that <em>usually</em> <code class="language-plaintext highlighter-rouge">Containerfile</code> and <code class="language-plaintext highlighter-rouge">Dockerfile</code> are
interchangeable.</p>

<p><code class="language-plaintext highlighter-rouge">ansible-builder create</code> essentially translate an <a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/">EE definition</a> into container build steps. That is
useful if you ever need to modify the <code class="language-plaintext highlighter-rouge">Containerfile</code> to your <em>very</em>, <em>very</em> specific needs before building the container image. <em>Usually</em>, <code class="language-plaintext highlighter-rouge">ansible-builder</code> with the new
Version 3 of the EE definition is enough for the majority of use cases.</p>

<p>Please bear with me a minute, I’ll explain shortly what an EE definition looks like.</p>

<p><code class="language-plaintext highlighter-rouge">ansible-builder build</code> on the other hand, goes one step further than <code class="language-plaintext highlighter-rouge">ansible-builder create</code>. Once the build context has been created, it will also run <code class="language-plaintext highlighter-rouge">podman</code> under the
hood to actually create and tag your image.</p>

<p>Again, the above explanation is very high level, but we’ll go into the details later on.</p>
<h3 id="execution-environment-definition">
  
  
    Execution Environment definition <a href="#execution-environment-definition">#</a>
  
  
</h3>
    

<p>Before we dive into it: Just a reminder, I’ll be talking about <em>Version 3</em> (<code class="language-plaintext highlighter-rouge">ansible-builder</code> version &gt; 3 is required) of the EE definition. Version 1 has limitations that have
largely been resolved by Version 3. If you have been building Version 1 EEs previously, please consider migrating to Version 3, as it eases the process a lot - especially for
complex EEs.</p>

<p>Let’s dive into it - finally we get to define something <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p>Execution Environment definitions essentially describe <em>what</em> you’d like to have within your EE. Typically, the <em>what</em> is a combination of these:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">ansible-core</code> and which version of it</li>
  <li>
<code class="language-plaintext highlighter-rouge">ansible-runner</code> and which version of it</li>
  <li>Ansible collections</li>
  <li>Ansible roles</li>
  <li>Python packages, both as dependencies of an Ansible collection and as a “user-supplied” package</li>
  <li>System packages, both as dependencies of an Ansible collection and as a “user-supplied” package</li>
  <li>Additional system configurations, modifications and files, such as certificate authorities of your company or specific proxy settings</li>
</ol>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> What I mean by a “user-supplied” package (for both system packages and Python packages) is that you specifically instructed <code class="language-plaintext highlighter-rouge">ansible-builder</code> to install
these packages during the EE build.</p>

<p>EE definitions are written entirely in <a href="https://yaml.org/"><code class="language-plaintext highlighter-rouge">YAML</code></a> and should therefore be no trouble writing for anyone who as previously worked with <code class="language-plaintext highlighter-rouge">YAML</code> - such as
Ansible users <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">.</p>

<p>Let’s imagine a scenario:</p>

<p>Your Satellite team approached you, that they’d like to automate Red Hat Satellite and therefore need the latest versions of the collections
<a href="https://console.redhat.com/ansible/automation-hub/repo/published/redhat/satellite/"><code class="language-plaintext highlighter-rouge">redhat.satellite</code></a> and
<a href="https://console.redhat.com/ansible/automation-hub/repo/published/redhat/satellite_operations/"><code class="language-plaintext highlighter-rouge">redhat.satellite_operations</code></a> inside the EE.
They also want to make use of the latest available <code class="language-plaintext highlighter-rouge">ansible-core</code> version, which is at the time of this writing 2.16.</p>

<p>That’s pretty straight-forward. We have the choice to either use <code class="language-plaintext highlighter-rouge">UBI</code> 8 or <code class="language-plaintext highlighter-rouge">UBI</code> 9, and we decide to go with <code class="language-plaintext highlighter-rouge">UBI</code> 8.</p>

<p>So what we need inside the EE:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">ansible-core</code> in version 2.16</li>
  <li>
<code class="language-plaintext highlighter-rouge">ansible-runner</code> in version 2.16</li>
  <li>
<a href="https://console.redhat.com/ansible/automation-hub/repo/published/redhat/satellite/"><code class="language-plaintext highlighter-rouge">redhat.satellite</code></a> in the latest version</li>
  <li>
<a href="https://console.redhat.com/ansible/automation-hub/repo/published/redhat/satellite_operations/"><code class="language-plaintext highlighter-rouge">redhat.satellite_operations</code></a> in the latest version</li>
  <li>The EE should be based on <code class="language-plaintext highlighter-rouge">UBI</code> 8</li>
</ol>

<p>I know, you have waited for a complex EE definition, but you’ll be shocked how easy it is to define the above requirements as EE. Have a look at the EE definition
below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span>
    <span class="na">collections</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.satellite'</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.satellite_operations'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/microdnf'</span>

<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.cfg'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">configs/'</span>

<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_galaxy</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/configs/ansible.cfg</span><span class="nv"> </span><span class="s">/home/runner/.ansible.cfg'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>That’s it. Really. Before we dive into what all the options do, let me first explain what <code class="language-plaintext highlighter-rouge">ansible-builder</code> command to run and check whether all our requirements are met.</p>

<p>I put the above definition in a file called <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>: That is the default file <code class="language-plaintext highlighter-rouge">ansible-builder</code> will try to open if you don’t pass a specific EE definitions
file using the <code class="language-plaintext highlighter-rouge">--file</code> or <code class="language-plaintext highlighter-rouge">-f</code> switches.</p>

<p>Further, I increased the verbosity (<code class="language-plaintext highlighter-rouge">--verbosity</code> or <code class="language-plaintext highlighter-rouge">-v</code> with either 0, 1, 2 or 3 as value) to actually see what’s happening during the build and lastly, I
<a href="https://docs.podman.io/en/latest/markdown/podman-tag.1.html">tagged</a> (essentially assigned a name and a version to my image) my image as <code class="language-plaintext highlighter-rouge">ee-satellite-rhel-8:latest</code> using the
<code class="language-plaintext highlighter-rouge">--tag</code> or <code class="language-plaintext highlighter-rouge">-t</code> switches.</p>

<p>The corresponding <code class="language-plaintext highlighter-rouge">ansible-builder build</code> command is the following:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-builder build <span class="nt">--tag</span> ee-satellite-rhel-8 <span class="nt">--verbosity</span> 3
</code></pre></div></div>

<p>Pretty easy, right? Once you run that command you’ll see something like this as the last messages of the <code class="language-plaintext highlighter-rouge">ansible-builder build</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[4/4] COMMIT ee-satellite-rhel-8
--&gt; 0ac2e9ef7216
Successfully tagged localhost/ee-satellite-rhel-8:latest
0ac2e9ef72169c7104b40e04bde34480b107b46efb5469bbb36ee883fe232e1e
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Please note, the above checksum you see, is the checksum of the container image and yours definitively <em>differs</em>.</p>

<p>You can check all your locally existing container images with <code class="language-plaintext highlighter-rouge">ansible-navigator images</code> using the <code class="language-plaintext highlighter-rouge">TUI</code> interface:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Image                                                                                Tag          Execution environment                  Created                    Size
 0│ee-minimal-rhel8                                                                     2.16         True                                   3 weeks ago                345 MB
 1│ee-satellite-rhel-8                                                                  latest       True                                   17 minutes ago             445 MB
</code></pre></div></div>

<p>Or if you prefer, using <code class="language-plaintext highlighter-rouge">podman image list</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>podman images
REPOSITORY                                                            TAG         IMAGE ID      CREATED         SIZE
localhost/ee-satellite-rhel-8                                         latest      d9b8762094e4  15 minutes ago  445 MB
registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8       2.16        74f040829a5c  3 weeks ago     345 MB
</code></pre></div></div>

<p>Now, let’s check if our EE <code class="language-plaintext highlighter-rouge">localhost/ee-satellite-rhel-8</code> contains <code class="language-plaintext highlighter-rouge">ansible-core 2.16</code> and the collections <code class="language-plaintext highlighter-rouge">redhat.satellite</code> and <code class="language-plaintext highlighter-rouge">redhat.satellite_operations</code>. We are going
to use <code class="language-plaintext highlighter-rouge">ansible-navigator collections --execution-environment-image localhost/ee-satellite-rhel-8:latest --pull-policy never</code> for that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Name                                 Version    Shadowed    Type         Path
0│ansible.builtin                      2.16.3     False       contained    /usr/local/lib/python3.11/site-packages/ansible
1│redhat.satellite                     4.0.0      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/satellite
2│redhat.satellite_operations          2.1.0      False       contained    /usr/share/ansible/collections/ansible_collections/redhat/satellite_operations
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Since we don’t have a container registry on our host (which is perfectly normal!) we need to use <code class="language-plaintext highlighter-rouge">--pull-policy</code> or <code class="language-plaintext highlighter-rouge">--pp</code> with the value <code class="language-plaintext highlighter-rouge">never</code>, which
instructs <code class="language-plaintext highlighter-rouge">ansible-navigator</code> to not <em>pull</em> the EE, which would otherwise fail. This is <em>only</em> for EEs that you’ve built locally or pulled already from a container registry
and don’t want to update it every time you run <code class="language-plaintext highlighter-rouge">ansible-navigator</code>. This helps also speed up the ramp-up time of <code class="language-plaintext highlighter-rouge">ansible-navigator</code> <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> <code class="language-plaintext highlighter-rouge">--execution-environment-image</code> can be shortened with <code class="language-plaintext highlighter-rouge">--eei</code>. This will give you back plenty of time if you are such a bad typist as I am and type
<code class="language-plaintext highlighter-rouge">--execution-environment-image</code> wrong at least twice every time I try to use it<img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">.</p>

<p>Okay great, we have the <code class="language-plaintext highlighter-rouge">ansible-core</code> version as well as the Ansible collections <code class="language-plaintext highlighter-rouge">redhat.satellite</code> and <code class="language-plaintext highlighter-rouge">redhat.satellite_operations</code>.</p>

<p>Easy, wasn’t it? <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

<p>Let’s break down this easy EE definition:</p>

<ol>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#version"><code class="language-plaintext highlighter-rouge">version</code> option</a></p>

    <p>With <code class="language-plaintext highlighter-rouge">version</code> we specify the EE definition version to use. We want this to be <code class="language-plaintext highlighter-rouge">3</code>. Version <code class="language-plaintext highlighter-rouge">1</code> looks a little different and - as said - has quite some limitations.
Additionally version 3 is <strong>required</strong> when using <code class="language-plaintext highlighter-rouge">ansible-builder</code> 3.x (which we do).</p>
  </li>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#images"><code class="language-plaintext highlighter-rouge">images</code> option</a></p>

    <p><code class="language-plaintext highlighter-rouge">images</code> is a dictionary, and the only supported attribute within <code class="language-plaintext highlighter-rouge">images</code> is <code class="language-plaintext highlighter-rouge">base_image</code>, which itself <em>must</em> have a <code class="language-plaintext highlighter-rouge">name</code> attribute which specifies the base image to use.</p>

    <p>Remember we talked about using existing EEs? We use these existing EEs now to add “on top” of the existing EEs our own content.</p>
  </li>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#dependencies"><code class="language-plaintext highlighter-rouge">dependencies</code> option</a></p>

    <p>I only <em>briefly</em> explain these so-called “in-line dependencies”. We’ll later use separate files for each of the requirement types - you understand why later on.</p>

    <p>Alright, so <code class="language-plaintext highlighter-rouge">dependencies</code> can have multiple attributes, but we <em>only</em> specified the <code class="language-plaintext highlighter-rouge">galaxy</code> attribute, which itself can either have a <code class="language-plaintext highlighter-rouge">roles</code> attribute or a <code class="language-plaintext highlighter-rouge">collections</code>
 attribute. The latter of which we used. In there we specify the roles and collections we want to be included in the EE.</p>

    <p>Again, I leave the Python package and system package dependencies out, as well as more complex definitions of collections and roles (with version and source) as we’ll later
 have it in separate files.</p>
  </li>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#options"><code class="language-plaintext highlighter-rouge">options</code> option</a></p>

    <p>The <code class="language-plaintext highlighter-rouge">options</code> option can have a <em>bunch</em> of attributes, but in the context of this minimal EE definition, we simply need to set the <code class="language-plaintext highlighter-rouge">package_manager_path</code>, which defaults to
 <code class="language-plaintext highlighter-rouge">/usr/bin/dnf</code>, which is not present. Instead EEs make use of <code class="language-plaintext highlighter-rouge">/usr/bin/microdnf</code> a slimmed down version of <code class="language-plaintext highlighter-rouge">dnf</code>.</p>
  </li>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#additional-build-steps"><code class="language-plaintext highlighter-rouge">additional_build_steps</code> option</a></p>

    <p>The <code class="language-plaintext highlighter-rouge">additional_build_steps</code> option is probably <strong>the most important</strong> option when it comes to building complex EEs. In our example we copied the <code class="language-plaintext highlighter-rouge">ansible.cfg</code> to the
 <code class="language-plaintext highlighter-rouge">/home/runner</code> directory (which is home directory of the <code class="language-plaintext highlighter-rouge">ansible-runner</code> user) so that this user is able to reach for instance
 <a href="https://console.redhat.com">Red Hat’s Automation Hub</a> or your Private Automation Hub.</p>

    <p>We also specified a specific attribute: <code class="language-plaintext highlighter-rouge">prepend_galaxy</code>, this essentially tells <code class="language-plaintext highlighter-rouge">ansible-builder</code> to put the build steps in this section <strong>before</strong> the installation
 of Ansible content.</p>

    <p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> We’ll go into much more details later on this topic.</p>
  </li>
  <li>
    <p><a href="https://ansible.readthedocs.io/projects/builder/en/stable/definition/#additional-build-files"><code class="language-plaintext highlighter-rouge">additional_build_files</code> option</a></p>

    <p>With <code class="language-plaintext highlighter-rouge">additional_build_files</code> we can copy files we have next to our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code> into the build context directory. From there we can add it to the EE.
 This is useful for providing the <code class="language-plaintext highlighter-rouge">ansible.cfg</code> to the EE, but will also come in handy if we need to add other files - such as certificate authority certificates - to
 the EE.</p>
  </li>
</ol>

<p>Before we move on, let’s look at what is in the <code class="language-plaintext highlighter-rouge">context</code> directory next to your <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree context/
context/
├── _build
│   ├── configs
│   │   └── ansible.cfg
│   ├── requirements.yml
│   └── scripts
│       ├── assemble
│       ├── check_ansible
│       ├── check_galaxy
│       ├── entrypoint
│       ├── install-from-bindep
│       └── introspect.py
└── Containerfile
</code></pre></div></div>

<p>So, the <code class="language-plaintext highlighter-rouge">context</code> directory contains the <code class="language-plaintext highlighter-rouge">_build</code> directory and a <code class="language-plaintext highlighter-rouge">Containerfile</code>. Let’s have a glimpse at them <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">configs</code></p>

    <p>We introduced this directory ourselves, as we specified to copy our <code class="language-plaintext highlighter-rouge">ansible.cfg</code> to <code class="language-plaintext highlighter-rouge">_build/configs</code>. This is our <code class="language-plaintext highlighter-rouge">ansible.cfg</code> we specified to copy in the EE definition.
 If you check the content of your <code class="language-plaintext highlighter-rouge">ansible.cfg</code> and the one that ended up in the EE, you’ll find that they are the same.</p>

    <p>You don’t have to specify that config sub-directory, <code class="language-plaintext highlighter-rouge">_build</code> is enough. I personally just find it cleaner that way, so I know what comes from me in terms of additional files.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">requirements.yml</code></p>

    <p>Let’s quickly look what’s in the <code class="language-plaintext highlighter-rouge">requirements.yml</code>:</p>

    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">cat </span>context/_build/requirements.yml
 collections:
 - name: redhat.satellite
 - name: redhat.satellite_operations
</code></pre></div>    </div>

    <p>Does that look familiar to you? <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

    <p>These are the collection we specified in our EE definition. They are simply added to a <code class="language-plaintext highlighter-rouge">requirements.yml</code> by <code class="language-plaintext highlighter-rouge">ansible-builder</code> when they are specified in-line, as we did.
 <a href="https://docs.ansible.com/ansible/latest/galaxy/user_guide.html#installing-roles-and-collections-from-the-same-requirements-yml-file"><code class="language-plaintext highlighter-rouge">requirements.yml</code></a> should be known to
 most Ansible users already: This is the standard format of providing depending collections and roles and can be read by <code class="language-plaintext highlighter-rouge">ansible-galaxy collection install</code> or
 <code class="language-plaintext highlighter-rouge">ansible-galaxy role install</code> when you pass the <code class="language-plaintext highlighter-rouge">--requirements-file</code> or, more commonly, the <code class="language-plaintext highlighter-rouge">-r</code> switch to the <code class="language-plaintext highlighter-rouge">ansible-galaxy command</code> and point it to the
 file, e.g.: <code class="language-plaintext highlighter-rouge">ansible-galaxy collection install -r requirements.yml</code>.
 This is exactly what <code class="language-plaintext highlighter-rouge">ansible-builder</code> does during the <code class="language-plaintext highlighter-rouge">galaxy stage</code> (where roles and collections are installed)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Containerfile</code></p>

    <p>This file is essentially the “translation” of the EE definition to “container build language”. Of course, certain things are predefined, but you’ll find it contains the
 options we specified.</p>

    <p>Let’s have a look:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> ARG EE_BASE_IMAGE="registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16"
 ARG PYCMD="/usr/bin/python3"
 ARG PKGMGR_PRESERVE_CACHE=""
 ARG ANSIBLE_GALAXY_CLI_COLLECTION_OPTS=""
 ARG ANSIBLE_GALAXY_CLI_ROLE_OPTS=""
 ARG PKGMGR="/usr/bin/microdnf"

 # Base build stage
 FROM $EE_BASE_IMAGE as base
 USER root
 ARG EE_BASE_IMAGE
 ARG PYCMD
 ARG PKGMGR_PRESERVE_CACHE
 ARG ANSIBLE_GALAXY_CLI_COLLECTION_OPTS
 ARG ANSIBLE_GALAXY_CLI_ROLE_OPTS
 ARG PKGMGR

 RUN $PYCMD -m ensurepip
 COPY _build/scripts/ /output/scripts/
 COPY _build/scripts/entrypoint /opt/builder/bin/entrypoint

 # Galaxy build stage
 FROM base as galaxy
 ARG EE_BASE_IMAGE
 ARG PYCMD
 ARG PKGMGR_PRESERVE_CACHE
 ARG ANSIBLE_GALAXY_CLI_COLLECTION_OPTS
 ARG ANSIBLE_GALAXY_CLI_ROLE_OPTS
 ARG PKGMGR

 COPY _build/configs/ansible.cfg /home/runner/.ansible.cfg
 RUN /output/scripts/check_galaxy
 COPY _build /build
 WORKDIR /build

 RUN ansible-galaxy role install $ANSIBLE_GALAXY_CLI_ROLE_OPTS -r requirements.yml --roles-path "/usr/share/ansible/roles"
 RUN ANSIBLE_GALAXY_DISABLE_GPG_VERIFY=1 ansible-galaxy collection install $ANSIBLE_GALAXY_CLI_COLLECTION_OPTS -r requirements.yml --collections-path "/usr/share/ansible/collections"

 # Builder build stage
 FROM base as builder
 WORKDIR /build
 ARG EE_BASE_IMAGE
 ARG PYCMD
 ARG PKGMGR_PRESERVE_CACHE
 ARG ANSIBLE_GALAXY_CLI_COLLECTION_OPTS
 ARG ANSIBLE_GALAXY_CLI_ROLE_OPTS
 ARG PKGMGR

 RUN $PYCMD -m pip install --no-cache-dir bindep pyyaml requirements-parser

 COPY --from=galaxy /usr/share/ansible /usr/share/ansible

 RUN $PYCMD /output/scripts/introspect.py introspect --sanitize --write-bindep=/tmp/src/bindep.txt --write-pip=/tmp/src/requirements.txt
 RUN /output/scripts/assemble

 # Final build stage
 FROM base as final
 ARG EE_BASE_IMAGE
 ARG PYCMD
 ARG PKGMGR_PRESERVE_CACHE
 ARG ANSIBLE_GALAXY_CLI_COLLECTION_OPTS
 ARG ANSIBLE_GALAXY_CLI_ROLE_OPTS
 ARG PKGMGR

 RUN /output/scripts/check_ansible $PYCMD

 COPY --from=galaxy /usr/share/ansible /usr/share/ansible

 COPY --from=builder /output/ /output/
 RUN /output/scripts/install-from-bindep &amp;&amp; rm -rf /output/wheels
 RUN chmod ug+rw /etc/passwd
 RUN mkdir -p /runner &amp;&amp; chgrp 0 /runner &amp;&amp; chmod -R ug+rwx /runner
 WORKDIR /runner
 RUN $PYCMD -m pip install --no-cache-dir 'dumb-init==1.2.5'
 RUN rm -rf /output
 LABEL ansible-execution-environment=true
 USER 1000
 ENTRYPOINT ["/opt/builder/bin/entrypoint", "dumb-init"]
 CMD ["bash"]
</code></pre></div>    </div>

    <p>I know, if you are not familiar with building containers, most of the file looks like gibberish to you. Don’t worry, with Version 3 of the EE definition, you don’t need to
 touch the <code class="language-plaintext highlighter-rouge">Containerfile</code> itself - <em>usually</em>.
 There might be <em>very, very</em> specific use-case where <code class="language-plaintext highlighter-rouge">ansible-builder</code> cannot fulfill your needs, but I personally haven’t encountered it (yet).</p>

    <p>Nevertheless, what you <strong>need</strong> to understand are the various stages the build passes through. This is because you can inject commands to each of those stages
 (at the very beginning and the very end of each section, essentially), and this is <em>exactly</em> what you need to realize complex EEs with proxies, certificates and so on.
 We’ll cover these build stages in the next section.</p>
  </li>
</ol>
<h3 id="execution-environment-stages">
  
  
    Execution Environment stages <a href="#execution-environment-stages">#</a>
  
  
</h3>
    

<p>During an EE build, we actually build <em>multiple</em> intermediate images. We call these intermediate images <strong>stages</strong>.</p>

<p>If we take the <code class="language-plaintext highlighter-rouge">Containerfile</code> from the previous section, we can see the following statements in it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[..]
FROM $EE_BASE_IMAGE as base  # first image
[..]
FROM base as galaxy  # second image
[..]
FROM base as builder  # third image
[..]
FROM base as final  # fourth image
[..]
</code></pre></div></div>

<p>With these <code class="language-plaintext highlighter-rouge">FROM X as Y</code> statements we start building <em>a new image</em>.</p>

<p>First, we start with the <code class="language-plaintext highlighter-rouge">base</code> stage. Next, is the <code class="language-plaintext highlighter-rouge">galaxy</code> stage, followed by the <code class="language-plaintext highlighter-rouge">builder</code> stage and lastly the <code class="language-plaintext highlighter-rouge">final</code> stage.
For all these stages, you can prepend or append container build commands yourself - this makes it highly flexible.</p>

<p>In below table you’ll see which <code class="language-plaintext highlighter-rouge">additional_build_steps</code> attribute needs to be used for which stage:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">stage</th>
      <th style="text-align: left">attribute</th>
      <th style="text-align: left">position</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">base</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">prepend_base</code></td>
      <td style="text-align: left">beginning of <code class="language-plaintext highlighter-rouge">base</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">base</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">append_base</code></td>
      <td style="text-align: left">end of <code class="language-plaintext highlighter-rouge">base</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">galaxy</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">prepend_galaxy</code></td>
      <td style="text-align: left">beginning of <code class="language-plaintext highlighter-rouge">galaxy</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">galaxy</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">append_galaxy</code></td>
      <td style="text-align: left">end of <code class="language-plaintext highlighter-rouge">galaxy</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">builder</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">prepend_builder</code></td>
      <td style="text-align: left">beginning of <code class="language-plaintext highlighter-rouge">builder</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">builder</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">append_builder</code></td>
      <td style="text-align: left">end of <code class="language-plaintext highlighter-rouge">builder</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">final</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">prepend_final</code></td>
      <td style="text-align: left">beginning of <code class="language-plaintext highlighter-rouge">final</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">final</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">append_final</code></td>
      <td style="text-align: left">end of <code class="language-plaintext highlighter-rouge">final</code>
</td>
    </tr>
  </tbody>
</table>

<p>To be able to use these stages effectively, we’ll need to understand what each of the sections does - let’s have a look.</p>
<h4 id="base-stage">
  
  
    <code class="language-plaintext highlighter-rouge">base</code> stage <a href="#base-stage">#</a>
  
  
</h4>
    

<p>The <code class="language-plaintext highlighter-rouge">base</code> stages begins by ensuring that <code class="language-plaintext highlighter-rouge">pip</code> is available (<code class="language-plaintext highlighter-rouge">RUN $PYCMD -m ensurepip</code>). This is important, as we’ll use the intermediate image <code class="language-plaintext highlighter-rouge">base</code> as our base for the
other intermediate images - hence the name <code class="language-plaintext highlighter-rouge">base</code>.</p>

<p>Next, we copy the scripts we have in <code class="language-plaintext highlighter-rouge">_build/scripts</code> to <code class="language-plaintext highlighter-rouge">/output/scripts</code> and copy the <code class="language-plaintext highlighter-rouge">entrypoint</code> script to its destination at <code class="language-plaintext highlighter-rouge">/opt/builder/bin/entrypoint</code>. The
<code class="language-plaintext highlighter-rouge">entrypoint</code> script will later on be the entry point for the <code class="language-plaintext highlighter-rouge">final</code> image.</p>

<p>The <code class="language-plaintext highlighter-rouge">scripts</code> contain scripts which we need during the build of our intermediate containers. Usually, you don’t need to look at them and understand what’s happening.
For troubleshooting it’s surely worthwhile to have a look <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>
<h4 id="galaxy-stage">
  
  
    <code class="language-plaintext highlighter-rouge">galaxy</code> stage <a href="#galaxy-stage">#</a>
  
  
</h4>
    

<p>Within the <code class="language-plaintext highlighter-rouge">galaxy</code> stage we’ll only install all Ansible collections and roles that are asked to be installed. That’s it <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>
<h4 id="builder-stage">
  
  
    <code class="language-plaintext highlighter-rouge">builder</code> stage <a href="#builder-stage">#</a>
  
  
</h4>
    

<p>The builder stage first copies what we’ve installed in the <code class="language-plaintext highlighter-rouge">galaxy</code> stage to <code class="language-plaintext highlighter-rouge">/usr/share/ansible</code> and then we <code class="language-plaintext highlighter-rouge">introspect</code> the content of it. Which means in other words,
we extract the dependencies that each collection requires and write them into <code class="language-plaintext highlighter-rouge">/tmp/src/bindep.txt</code> for system package dependencies or <code class="language-plaintext highlighter-rouge">/tmp/src/requirements.txt</code>
for Python packages.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20">
Remember the <code class="language-plaintext highlighter-rouge">ansible-builder introspect</code> a few sections earlier? That’s essentially the same.</p>

<p>Finally we run a mysterious script <code class="language-plaintext highlighter-rouge">/output/scripts/assemble</code>. That’s one of the scripts that are in the <code class="language-plaintext highlighter-rouge">context/scripts</code> directory when you run <code class="language-plaintext highlighter-rouge">ansible-builder create</code> only.</p>

<p>What this script essentially does is resolving Python package dependencies and installing them to <code class="language-plaintext highlighter-rouge">/output</code>, which we need for the next stage. Additionally system packages are
installed and a list of them is collected and written for the next stage into <code class="language-plaintext highlighter-rouge">/output</code>.</p>

<p>We also cache what we’ve downloaded for Python packages, so the next stage progresses quicker <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>
<h4 id="final-stage">
  
  
    <code class="language-plaintext highlighter-rouge">final</code> stage <a href="#final-stage">#</a>
  
  
</h4>
    

<p>This is - who would have guessed it - the final image. Essentially we combine everything now.</p>

<p>First we copy from the <code class="language-plaintext highlighter-rouge">galaxy</code> stage the Ansible collections and roles to <code class="language-plaintext highlighter-rouge">/usr/share/ansible/</code>, then we copy the result of the <code class="language-plaintext highlighter-rouge">builder</code> stage from <code class="language-plaintext highlighter-rouge">/output</code> to
<code class="language-plaintext highlighter-rouge">/output</code> and re-install the cached Python packages and as well the system package dependencies.</p>
<h3 id="complex-execution-environments">
  
  
    Complex execution environments <a href="#complex-execution-environments">#</a>
  
  
</h3>
    

<p>With all the knowledge from the previous chapters, we can finally start creating complex execution environments <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p>I’ll make up a completely random scenario where we install a bunch of collections, Python and system packages. In my imaginary scenario, we’ll need to set a proxy,
a custom Python package repository and we also need to install custom certificate authority certificates. Further, we’ll disable and enable repositories.</p>
<h4 id="specifying-dependencies-as-files">
  
  
    Specifying dependencies as files <a href="#specifying-dependencies-as-files">#</a>
  
  
</h4>
    

<p>A few sections earlier, we specified the Ansible collections we wanted to install via in-line dependencies. Above I said, we’ll be using files.
The reason being, that - from my point of view - the more collections, Python and system packages you want to install, the harder to read the EE definition gets.</p>

<p>For this reason I’ve decided for myself to always use files to specify the dependencies - no matter how much I have.</p>

<p>We have three types of dependencies we can specify:</p>

<ol>
  <li>Ansible collections and roles</li>
  <li>Python packages</li>
  <li>System packages</li>
</ol>

<p>They all have a very specific format; They are easy to remember formats, however. At least from my perspective.</p>
<h4 id="installing-ansible-collections-and-roles">
  
  
    Installing Ansible collections and roles <a href="#installing-ansible-collections-and-roles">#</a>
  
  
</h4>
    

<p>Defining Ansible collections and roles should be the easiest of all. The
<a href="https://docs.ansible.com/ansible/latest/galaxy/user_guide.html#installing-roles-and-collections-from-the-same-requirements-yml-file">format</a> is probably known to most
Ansible users.</p>

<p>For this example, I’ve copied one of my own <code class="language-plaintext highlighter-rouge">requirements.yml</code> and placed it next to my <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>. I use the below
<code class="language-plaintext highlighter-rouge">requirements.yml</code> for automating Satellite end-to-end. It contains a few collections, as well as some roles:</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> If you don’t specify a version for a collection or role, it’ll default to use the latest possible version.</p>

<p>If you want reproducibility for your EEs (so that it builds the same <em>every time</em>, even months after you created the initial EE), you <em>must</em> specify fixed versions of
collections and roles. <code class="language-plaintext highlighter-rouge">&gt;=</code> means “bigger than or equal to” (as seen in the code block below), which results in the installation of new versions of the
respective collections and roles if they are available.</p>

<p>This is only for the “user-specified” Ansible collections and roles. Once you install Ansible collections, they can come with their own dependencies, which you
cannot influence in that sense. So even if you specify fixed versions of your “user-supplied” Ansible collections, it doesn’t mean that your EE is 100% reproducible.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">collections</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.satellite'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&gt;=3.10.0'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.satellite_operations'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&gt;=1.3.0'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redhat.rhel_system_roles'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&gt;=1.21.1'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.posix'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&gt;=1.5.4'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">community.crypto'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&gt;=2.3.2'</span>

  <span class="c1"># NOTE: Temporarily disabling the official redhat.insights collection and adding</span>
  <span class="c1">#       a temporary publish of the insights collection within my own namespace</span>
  <span class="c1">#       which contains PR https://github.com/RedHatInsights/ansible-collections-insights/pull/90.</span>
  <span class="c1">#       This PR provides required functionality for the insights role (obfuscating)</span>
  <span class="c1">#       and I didn't want to work around this issue.</span>
  <span class="c1">#       Another PR was also cherry-picked to this collection to fix the Insights client</span>
  <span class="c1">#       registration (https://github.com/RedHatInsights/ansible-collections-insights/pull/89)</span>
  <span class="c1">#</span>
  <span class="c1">#  - name: 'redhat.insights'</span>
  <span class="c1">#    version: '&gt;=1.2.0'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sscheib.insights'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0.0.2'</span>

<span class="na">roles</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">rhel_iso_kickstart'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-rhel_iso_kickstart.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v2.0.6'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">user_deployment'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-user_deployment.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.5'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">package_installation'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-package_installation.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.1'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">service_management'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-service_management.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.2'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">generate_ssl_key_pairs'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-generate_ssl_key_pairs.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.1.5'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">register_to_satellite'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-register_to_satellite.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.4'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">satellite_create_host'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-satellite_create_host.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.2'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">satellite_publish_promote_content_views'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-satellite_publish_promote_content_views.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.2'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">satellite_prepare_installation'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-satellite_prepare_installation.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.3'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">satellite_template_synchronization'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-satellite_template_synchronization.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.2'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">satellite_global_parameters'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-satellite_global_parameters.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.1'</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">file_deployment'</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://github.com/sscheib/ansible-role-file_deployment.git'</span>
    <span class="na">scm</span><span class="pi">:</span> <span class="s1">'</span><span class="s">git'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">v1.0.1'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>As you see, I am using both community and certified collections. The roles are all my own <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>To make <code class="language-plaintext highlighter-rouge">ansible-builder</code> aware of this file, we need to specify the following in our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.yml'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>
<h4 id="installing-python-packages">
  
  
    Installing Python packages <a href="#installing-python-packages">#</a>
  
  
</h4>
    

<p>Python package requirements follow also a very specific <a href="https://pip.pypa.io/en/stable/reference/requirements-file-format/">format</a>. Below I’ll made up a random set
of Python packages to install in different versions.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> If you don’t specify a version for a Python package, it’ll default to use the latest possible version.</p>

<p>If you want reproducibility for your EEs (so that it builds the same <em>every time</em>, even months after you created the initial EE), you <em>must</em> specify fixed versions for
Python packages. <code class="language-plaintext highlighter-rouge">&gt;=</code> means “bigger than or equal to” (as seen in the code block below), which results in the installation of new versions of the
respective Python packages if they are available and <code class="language-plaintext highlighter-rouge">pip</code> dependency resolution finds it will not cause dependency issues.</p>

<p>This is only for the “user-specified” Python packages. Once you install Ansible collections and Python packages, they come with their own dependencies, which you
cannot influence in that sense. So even if you specify fixed versions of your “user-supplied” Python packages, it doesn’t mean that your EE is 100% reproducible.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytz
python-dateutil&gt;=2.7.0
awxkit
proxmoxer
ansible-pylibssh&gt;=0.2.0
jxmlease
ncclient
netaddr
paramiko
xmltodict
grpcio
protobuf
jsonschema
textfsm
ttp
xmltodict
PyYAML
</code></pre></div></div>

<p>We’ll place the above content into the file <code class="language-plaintext highlighter-rouge">requirements.txt</code>, next to our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>.</p>

<p>To make <code class="language-plaintext highlighter-rouge">ansible-builder</code> aware of this file, we need to specify the following in our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">python</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.txt'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>
<h4 id="installing-system-packages">
  
  
    Installing system packages <a href="#installing-system-packages">#</a>
  
  
</h4>
    

<p>Last but not least, we have the system packages. Also these follow a specific <a href="https://docs.opendev.org/opendev/bindep/latest/readme.html">format</a>.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> If you don’t specify a version for a system package, it’ll default to use the latest possible version.</p>

<p>If you want reproducibility for your EEs (so that it builds the same <em>every time</em>, even months after you created the initial EE), you <em>must</em> specify a fixed version for
your system packages.</p>

<p>This is only for the “user-specified” system packages. Once you install Ansible collections, Python packages and system packages, they can come with their own
dependencies, which you cannot influence in that sense. So even if you specify fixed versions of your “user-supplied” system packages, it doesn’t mean that your EE
is 100% reproducible.</p>

<p>I made up again a random list of system packages to install:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libyaml-devel [test platform:rpm]
libyaml-dev [test platform:dpkg]
python3-devel [test platform:rpm]
python3 [test platform:rpm]
gcc [compile platform:rpm]
libssh-dev [compile platform:dpkg]
libssh-devel [compile platform:rpm]
python3-Cython [compile platform:fedora-35 platform:rhel-9]
python3-six [platform:centos-9 platform:rhel-9]
python39-six [platform:centos-8 platform:rhel-8]
python3-lxml [platform:centos-9 platform:rhel-9]
python39-lxml [platform:centos-8 platform:rhel-8]
findutils [compile platform:centos-8 platform:rhel-8]
gcc [compile platform:centos-8 platform:rhel-8]
make [compile platform:centos-8 platform:rhel-8]
python3-devel [compile platform:centos-9 platform:rhel-9]
python39-devel [compile platform:centos-8 platform:rhel-8]
python3-cffi [platform:centos-9 platform:rhel-9]
jq
grep == 3.3
</code></pre></div></div>

<p>The format is the most complex of the three, and I encourage you to <a href="https://docs.opendev.org/opendev/bindep/latest/readme.html">read up on it</a> to understand it. For basic
requirements, you can simply name the RPM you’d like to have installed - like I did with <code class="language-plaintext highlighter-rouge">jq</code> above.</p>

<p>I’ve also added an example for specifying a fixed version of the package <code class="language-plaintext highlighter-rouge">grep</code>.</p>

<p>We’ll place the above content in the file <code class="language-plaintext highlighter-rouge">bindep.txt</code>, again next to our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>.</p>

<p>To make <code class="language-plaintext highlighter-rouge">ansible-builder</code> aware of this file, we need to specify the following in our <code class="language-plaintext highlighter-rouge">execution-environment.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>
<h4 id="adding-certificates-to-an-ee">
  
  
    Adding certificates to an EE <a href="#adding-certificates-to-an-ee">#</a>
  
  
</h4>
    

<p>Adding certificates is essentially the same as with every RHEL-like system. In the case of EEs, we need to copy the certificates first into our <code class="language-plaintext highlighter-rouge">_build</code>
directory (as with the <code class="language-plaintext highlighter-rouge">ansible.cfg</code>).</p>

<p>Let’s imagine we have a file called <code class="language-plaintext highlighter-rouge">ca.cert.pem</code> and another one <code class="language-plaintext highlighter-rouge">intermediate.cert.pem</code> next to our <code class="language-plaintext highlighter-rouge">execution-environments.yml</code> file.</p>

<p>To add these certificates to the EE, we first need to tell <code class="language-plaintext highlighter-rouge">ansible-builder</code> to copy these files to the <code class="language-plaintext highlighter-rouge">_build</code> directory:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ca.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">intermediate.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>With the above, we’ll copy both <code class="language-plaintext highlighter-rouge">ca.cert.pem</code> and <code class="language-plaintext highlighter-rouge">intermediate.cert.pem</code> to <code class="language-plaintext highlighter-rouge">_build/certs</code> inside the build context directory.</p>

<p>Next we need to copy these files actually to their correct destination. For that, we need to inject build steps into one of the stages we talked about.</p>

<p>Now often the question comes up: Which stage?</p>

<p>The answer is, as so often, it depends <img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">.</p>

<p>If you need the certificates to validate your connection to your private automation hub, then you’ll need them in the <code class="language-plaintext highlighter-rouge">galaxy</code> stage. Do you require certificate validation with
your proxy, and need to access the internet or some internal systems via a proxy, then you’ll probably need the certificates in all stages (but the <code class="language-plaintext highlighter-rouge">base</code> stage, probably).</p>

<p>As you see, the answer really depends on your specific requirement.</p>

<p>Nevertheless, the procedure is always the same when you specify it in the EE definition:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_galaxy</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>In the case above, I added it to the beginning of the <code class="language-plaintext highlighter-rouge">galaxy</code> stage. If you need to use it in another <code class="language-plaintext highlighter-rouge">stage</code>, simply replace <code class="language-plaintext highlighter-rouge">prepend_galaxy</code> with the corresponding
attribute for the <a href="#execution-environment-stages">stage</a> required.</p>
<h4 id="defining-a-proxy">
  
  
    Defining a proxy <a href="#defining-a-proxy">#</a>
  
  
</h4>
    

<p>Defining a proxy really depends on your use case - again. Most commonly, you’d have to run all connections that go outside of your corporate network through the proxy.
This means, every time we install something. Which means, you’ll need it in all <code class="language-plaintext highlighter-rouge">stages</code> <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>Further, we need to differentiate between a system proxy and a proxy only for <code class="language-plaintext highlighter-rouge">pip</code>.</p>

<p>Let’s first go with the system proxy. A system proxy is set via the environment variables <code class="language-plaintext highlighter-rouge">http_proxy</code> and <code class="language-plaintext highlighter-rouge">https_proxy</code>. And if you want to exclude (sub-)domains,
you can make use of <code class="language-plaintext highlighter-rouge">no_proxy</code>.</p>

<p>If you’ve never encountered any of these variables before, you might want to review the <a href="https://www.gnu.org/software/wget/manual/html_node/Proxies.html">documentation</a> of
them prior to using them.</p>

<p>In <code class="language-plaintext highlighter-rouge">ansible-builder</code> we can do it like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://my.proxy.example.com:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://my.proxy.example.com:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">no_proxy=sub.example.org,another.domain.evil.corp'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>When it comes to the <code class="language-plaintext highlighter-rouge">pip</code> proxy, we need to set it independently using the <code class="language-plaintext highlighter-rouge">pip config</code> command:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.proxy</span><span class="nv"> </span><span class="s">http://my.proxy.example.com:3128'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>In which stage you’ll add these, is totally up to you and depends on your <em>specific</em> use case.</p>
<h4 id="custom-python-package-repository">
  
  
    Custom Python package repository <a href="#custom-python-package-repository">#</a>
  
  
</h4>
    

<p>Some users might have their Python packages scanned and published on a custom repository. It is easy to also set that in an EE definition:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.index-url</span><span class="nv"> </span><span class="s">http://custom.repository.example.com/simple'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.trusted-host</span><span class="nv"> </span><span class="s">custom.repository.example.com'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> It is important to note, that you not only need to set the <code class="language-plaintext highlighter-rouge">index-url</code>, but also need to flag the host as trusted. Otherwise <code class="language-plaintext highlighter-rouge">pip</code> will refuse installation.</p>
<h4 id="enabling-and-disabling-repositories">
  
  
    Enabling and disabling repositories <a href="#enabling-and-disabling-repositories">#</a>
  
  
</h4>
    

<p>Sometimes you’ll have the need to enable other repositories than the default <code class="language-plaintext highlighter-rouge">UBI</code> and RHEL repositories within the EE build context. For instance to install a custom package.</p>

<p>If you have read the blog post in its entirety then you know that we need to make use of <code class="language-plaintext highlighter-rouge">microdnf</code> instead of <code class="language-plaintext highlighter-rouge">dnf</code> in an EE context.</p>

<p>Enabling and disabling repositories is as easy as the tasks above, but this time we need to override an existing environment variable: <code class="language-plaintext highlighter-rouge">PKGMGR_OPTS</code>.</p>

<p>By default, the environment variable <code class="language-plaintext highlighter-rouge">PKGMGR_OPTS</code> has the following value (at the time of this writing):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--nodocs --setopt=install_weak_deps=0
</code></pre></div></div>

<p>We’ll simply extend that by adding our <code class="language-plaintext highlighter-rouge">--disablerepo=</code> and <code class="language-plaintext highlighter-rouge">--enablerepo=</code> switches to it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--nodocs --setopt=install_weak_deps=0 --disablerepo=* --enablerepo=ubi-8-*"
</code></pre></div></div>

<p>In the above code, we’ll disable all repositories and only enable the <code class="language-plaintext highlighter-rouge">UBI</code> 8 repositories.</p>

<p>We’ll define that like the following in the EE definition:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">PKGMGR_OPTS="--nodocs</span><span class="nv"> </span><span class="s">--setopt=install_weak_deps=0</span><span class="nv"> </span><span class="s">--disablerepo=*</span><span class="nv"> </span><span class="s">--enablerepo=ubi-8-*"'</span>
</code></pre></div></div>
<h4 id="the-complete-complex-execution-environment-making-use-of-advanced-yaml-syntax">
  
  
    The complete complex execution environment: Making use of advanced <code class="language-plaintext highlighter-rouge">YAML</code> syntax <a href="#the-complete-complex-execution-environment-making-use-of-advanced-yaml-syntax">#</a>
  
  
</h4>
    

<p>If we combine all the previously discussed modifications into one EE definition, we’ll end up with something like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.yml'</span>
  <span class="na">python</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.txt'</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/microdnf'</span>

<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.cfg'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">configs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ca.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">intermediate.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_base</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.index-url</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me/simple'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.trusted-host</span><span class="nv"> </span><span class="s">lab-development-rhel8.core.rh.scheib.me'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.proxy</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me:3128'</span>

  <span class="na">prepend_galaxy</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/configs/ansible.cfg</span><span class="nv"> </span><span class="s">/home/runner/.ansible.cfg'</span>

  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.index-url</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me/simple'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.trusted-host</span><span class="nv"> </span><span class="s">lab-development-rhel8.core.rh.scheib.me'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.proxy</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">PKGMGR_OPTS="--nodocs</span><span class="nv"> </span><span class="s">--setopt=install_weak_deps=0</span><span class="nv"> </span><span class="s">--disablerepo=*</span><span class="nv"> </span><span class="s">--enablerepo=ubi-8-*"'</span>

  <span class="na">prepend_final</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.index-url</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me/simple'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.trusted-host</span><span class="nv"> </span><span class="s">lab-development-rhel8.core.rh.scheib.me'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.proxy</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">PKGMGR_OPTS="--nodocs</span><span class="nv"> </span><span class="s">--setopt=install_weak_deps=0</span><span class="nv"> </span><span class="s">--disablerepo=*</span><span class="nv"> </span><span class="s">--enablerepo=ubi-8-*"'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>As you surely noticed, we are doing the same things often multiple times. That’s due to the different images we build.</p>

<p>There is a little something, that can make this a lot more tidy than it is currently: <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_advanced_syntax.html#yaml-anchors-and-aliases-sharing-variable-values"><code class="language-plaintext highlighter-rouge">YAML anchors and aliases</code></a>.</p>

<p>It is not used <em>that</em> widely with Ansible to my knowledge, as it can make things pretty quickly, pretty messy, so be careful when using it.</p>

<p>With <code class="language-plaintext highlighter-rouge">YAML</code> anchors and aliases, you can include repetitive definitions in place. This not only looks tidier, but it has the benefit that you’ll only need to update <em>one</em>
reference if you, for instance, change your proxy - instead of updating all of the occurrences.</p>

<p>Let’s look into what it looks like when using it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.yml'</span>
  <span class="na">python</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.txt'</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/microdnf'</span>

<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.cfg'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">configs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ca.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">intermediate.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_base</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nl">&amp;copy-certs</span> <span class="pi">|-</span>
         <span class="s">COPY _build/certs/ca.cert.pem /etc/pki/ca-trust/source/anchors/</span>
         <span class="s">COPY _build/certs/intermediate.cert.pem /etc/pki/ca-trust/source/anchors</span>
         <span class="s">RUN update-ca-trust</span>

    <span class="pi">-</span> <span class="nl">&amp;system-proxy</span> <span class="pi">|-</span>
        <span class="s">ENV https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128</span>
        <span class="s">ENV http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128</span>
    <span class="pi">-</span> <span class="nl">&amp;pip</span> <span class="pi">|-</span>
        <span class="s">RUN pip3 config --user set global.index-url http://lab-development-rhel8.core.rh.scheib.me/simple</span>
        <span class="s">RUN pip3 config --user set global.trusted-host lab-development-rhel8.core.rh.scheib.me</span>
        <span class="s">RUN pip3 config --user set global.proxy http://lab-development-rhel8.core.rh.scheib.me:3128</span>

  <span class="na">prepend_galaxy</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/configs/ansible.cfg</span><span class="nv"> </span><span class="s">/home/runner/.ansible.cfg'</span>

  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="nv">*pip</span>
    <span class="pi">-</span> <span class="nl">&amp;disable-repos</span> <span class="pi">&gt;-</span>
       <span class="s">ENV PKGMGR_OPTS="--nodocs --setopt=install_weak_deps=0 --disablerepo=* --enablerepo=ubi-8-*"</span>

  <span class="na">prepend_final</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="nv">*pip</span>
    <span class="pi">-</span> <span class="nv">*disable-repos</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>Doesn’t that look <strong>much</strong> cleaner now? <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>
<h3 id="using-custom-base-images">
  
  
    Using custom base images <a href="#using-custom-base-images">#</a>
  
  
</h3>
    

<p>The last topic I’d like to cover is using your very own <code class="language-plaintext highlighter-rouge">base</code> images. As you’ve seen in the above EE definition we often repeat the same steps. Such things as copying the
certificates, and setting the system proxy.</p>

<p>If you know that you <strong>always</strong> need certain things in your EE, we can apply a simple concept: Build your own <code class="language-plaintext highlighter-rouge">base</code> image, based on one of the official EEs.</p>

<p>Things that you might always need are, for instance:</p>

<ul>
  <li>Specific system proxy</li>
  <li>Specific EE modifications you need to perform always</li>
  <li>Adding your corporate certificates</li>
</ul>

<p>Again, this <em>only</em> applies to things that you need in <em>all</em> your EEs.</p>

<p>The process itself is straight forward. We’ll define a EE as we used to do, but with the bare minimum of options, and leaving out <em>everything</em> that we don’t need <em>always</em>.
In my case that’s Python packages as well as Ansible content:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/microdnf'</span>

<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.cfg'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">configs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ca.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">intermediate.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_base</span><span class="pi">:</span>
    <span class="c1"># copy files</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/ca.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors/'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/certs/intermediate.cert.pem</span><span class="nv"> </span><span class="s">/etc/pki/ca-trust/source/anchors'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/configs/ansible.cfg</span><span class="nv"> </span><span class="s">/home/runner/.ansible.cfg'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">update-ca-trust'</span>

    <span class="c1"># override pip proxy and package repository</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.index-url</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me/simple'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.trusted-host</span><span class="nv"> </span><span class="s">lab-development-rhel8.core.rh.scheib.me'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">RUN</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">--user</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">global.proxy</span><span class="nv"> </span><span class="s">http://lab-development-rhel8.core.rh.scheib.me:3128'</span>

    <span class="c1"># set the system proxy</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128'</span>

    <span class="c1"># disable all repositories but the UBI ones</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">ENV</span><span class="nv"> </span><span class="s">PKGMGR_OPTS="--nodocs</span><span class="nv"> </span><span class="s">--setopt=install_weak_deps=0</span><span class="nv"> </span><span class="s">--disablerepo=*</span><span class="nv"> </span><span class="s">--enablerepo=ubi-8-*"'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>In my imaginary scenario above I <em>always</em> need:</p>

<ul>
  <li>The certificates of my public key infrastructure inside my EE</li>
  <li>Proxy configuration, for both the system itself and <code class="language-plaintext highlighter-rouge">pip</code>
</li>
  <li>We are also going to use a custom Python package repository</li>
  <li>I need one package, that is defined in <code class="language-plaintext highlighter-rouge">bindep.txt</code>: <code class="language-plaintext highlighter-rouge">socat [platform:rpm]</code>
</li>
  <li>Also I want to ensure that only <code class="language-plaintext highlighter-rouge">UBI</code> repositories are enabled</li>
</ul>

<p>You can also include Ansible content and as well Python packages you always want to have in <em>each</em> EE. But please remember: If you don’t require it <em>always</em>,
but only in specific EEs, you should not consider adding that to your custom <code class="language-plaintext highlighter-rouge">base image</code>.</p>

<p>Let’s build the <code class="language-plaintext highlighter-rouge">base</code> image:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-builder build <span class="nt">-f</span> base.yml <span class="nt">-t</span> ee-base-rhel-8:latest <span class="nt">-v3</span>
<span class="o">[</span>..]
<span class="o">[</span>3/3] COMMIT ee-base-rhel-8:latest
<span class="nt">--</span><span class="o">&gt;</span> ff13573ab020
Successfully tagged localhost/ee-base-rhel-8:latest
ff13573ab0209bdbc8cdcee3d0aaae4d8d643d91d87f1c38449806e983a15e46
</code></pre></div></div>

<p>Now we have the EE on our local machine and <code class="language-plaintext highlighter-rouge">ansible-navigator images</code> knows about it:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Image                                                                            Tag         Execution environment                 Created                          Size
 1│ee-base-rhel-8                                                                   latest      True                                  About a minute ago               359 MB
 2│ee-minimal-rhel8                                                                 2.16        True                                  4 weeks ago                      345 MB
 3│ee-satellite-rhel-8                                                              latest      True                                  3 days ago                       446 MB
</code></pre></div></div>

<p>Perfect. How do we utilize it now in <code class="language-plaintext highlighter-rouge">ee-satellite-rhel-8</code>?</p>

<p>That’s easy: Can you recall the following section of the EE definition?</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>
<span class="pi">[</span><span class="nv">..</span><span class="pi">]</span>
</code></pre></div></div>

<p>Guess what? We’ll replace that now with our just created image <code class="language-plaintext highlighter-rouge">localhost/ee-base-rhel-8:latest</code> <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p>The final <code class="language-plaintext highlighter-rouge">execution-environment.yml</code> for our EE <code class="language-plaintext highlighter-rouge">ee-satellite-rhel-8:latest</code> will look like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost/ee-base-rhel-8:latest'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.yml'</span>
  <span class="na">python</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.txt'</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/microdnf'</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>We handle all the necessary extra steps already (certificates, proxy, etc.) in our own <code class="language-plaintext highlighter-rouge">base</code> image, so you don’t have to worry about that anymore when building your
“real” EE. This also has the benefit we only need to do it <em>once</em>, compared to the previous multiple times - depending on your use case, of course.</p>

<p>You can push the new <code class="language-plaintext highlighter-rouge">base</code> EE now to your Automation Hub, or any other container registry you have in your company. That way everybody can use this new corporate
base EE <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">.</p>

<p>Easy, wasn’t it? <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20"></p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20">
<strong>A word of caution</strong>: Since we now effectively decoupled pulling Red Hat’s certified EE of our “real” EE, you <strong>need</strong> to update your custom <code class="language-plaintext highlighter-rouge">base</code> EE
<strong>regularly</strong> as well. Otherwise you don’t receive updates of the certified EEs.</p>
<h3 id="enabling-non-red-hat-repositories">
  
  
    Enabling non-Red Hat repositories <a href="#enabling-non-red-hat-repositories">#</a>
  
  
</h3>
    

<p>There might be a need for you to enable custom <code class="language-plaintext highlighter-rouge">RPM</code> repositories, which are not distributed by Red Hat.</p>

<p><code class="language-plaintext highlighter-rouge">microdnf</code> is, unfortunately, not up for that task - at least I couldn’t find a way to make this work with <code class="language-plaintext highlighter-rouge">microdnf</code>.</p>

<p>The difference of official Red Hat repositories and custom repositories with regards to <code class="language-plaintext highlighter-rouge">GPG</code> key signing, is the fact that <code class="language-plaintext highlighter-rouge">UBI</code> knows about the <code class="language-plaintext highlighter-rouge">GPG</code> keys Red Hat signs
the <code class="language-plaintext highlighter-rouge">RPM</code> packages with. The <code class="language-plaintext highlighter-rouge">GPG</code> key of Red Hat is certainly different to a custom repository, where you - or a different vendor - signs the packages with a different
<code class="language-plaintext highlighter-rouge">GPG</code> key.</p>

<p>In ‘usual’ operating system usage (on RHEL), there is not much magic to importing a custom <code class="language-plaintext highlighter-rouge">GPG</code> key for a custom <code class="language-plaintext highlighter-rouge">RPM</code> repository. It starts to get complicated with <code class="language-plaintext highlighter-rouge">microdnf</code>
in <code class="language-plaintext highlighter-rouge">UBI</code>.</p>
<h4 id="the-issue">
  
  
    The issue <a href="#the-issue">#</a>
  
  
</h4>
    

<p>When trying to enable a custom <code class="language-plaintext highlighter-rouge">RPM</code> repository (in my case <code class="language-plaintext highlighter-rouge">org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8-8-x86_64</code>) which is provided by my Red Hat Satellite to
the system which is building the EE, I always receive the following error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error: failed to parse public key for /var/cache/yum/metadata/org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8-8-x86_64/gpg_key_content
</code></pre></div></div>

<p>I started digging around in my EE by spinning up a container using the image <code class="language-plaintext highlighter-rouge">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16</code> with <code class="language-plaintext highlighter-rouge">podman</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman run --rm -it registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16 /bin/bash
</code></pre></div></div>

<p>When inspecting <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/redhat.repo</code>, which is the repository configuration file for all repositories provided by a Red Hat Satellite (to which the system needs
to be subscribed to), we can see the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[satellite-client-6-for-rhel-8-x86_64-rpms]
name=Red Hat Satellite Client 6 for RHEL 8 x86_64 (RPMs)
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/content/dist/layered/rhel8/x86_64/sat-client/6/os
enabled=false
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8]
name=repo-zabbix-zabbix-6_0-rhel-8
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/custom/prd-zabbix-zabbix/repo-zabbix-zabbix-6_0-rhel-8
enabled=false
gpgkey=https://satellite.example.com/katello/api/v2/repositories/14/gpg_key_content
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[org-core_prd-elastic-elastic_repo-elastic-elastic-8-el-8]
name=repo-elastic-elastic-8-el-8
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/custom/prd-elastic-elastic/repo-elastic-elastic-8-el-8
enabled=false
gpgkey=https://satellite.example.com/katello/api/v2/repositories/13/gpg_key_content
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[rhel-8-for-x86_64-appstream-rpms]
name=Red Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/content/dist/rhel8/$releasever/x86_64/appstream/os
enabled=true
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[rhel-8-for-x86_64-baseos-rpms]
name=Red Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs)
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/content/dist/rhel8/$releasever/x86_64/baseos/os
enabled=true
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true
</code></pre></div></div>

<p>According to the above repository configuration file, I should be able to retrieve the <code class="language-plaintext highlighter-rouge">GPG</code> key for the repository <code class="language-plaintext highlighter-rouge">org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8</code>
via the URL <code class="language-plaintext highlighter-rouge">https://satellite.example.com/katello/api/v2/repositories/14/gpg_key_content</code>.</p>

<p>Let’s download it, and parse it with <code class="language-plaintext highlighter-rouge">gpg</code> to check if it actually is a valid <code class="language-plaintext highlighter-rouge">GPG</code> public key:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-4.4#</span><span class="w"> </span>curl <span class="nt">-k</span> https://satellite.example.com/katello/api/v2/repositories/14/gpg_key_content <span class="nt">-o</span> /tmp/zabbix-gpg
<span class="go">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  2938  100  2938    0     0   1438      0  0:00:02  0:00:02 --:--:--  1438
</span><span class="gp">bash-4.4#</span><span class="w"> </span>gpg <span class="nt">--show-keys</span> <span class="nt">--with-fingerprint</span> /tmp/zabbix-gpg  
<span class="go">pub   dsa1024 2012-10-28 [SC]
      FBAB D5FB 2025 5ECA B22E  E194 D13D 58E4 79EA 5ED4
</span><span class="gp">uid                      Zabbix SIA &lt;packager@zabbix.com&gt;</span><span class="w">
</span><span class="go">sub   elg1024 2012-10-28 [E]

pub   rsa2048 2016-07-15 [SC]
      A184 8F53 52D0 22B9 471D  83D0 082A B56B A14F E591
</span><span class="gp">uid                      Zabbix LLC &lt;packager@zabbix.com&gt;</span><span class="w">
</span><span class="go">sub   rsa2048 2016-07-15 [E]
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The <code class="language-plaintext highlighter-rouge">-k</code> option of <code class="language-plaintext highlighter-rouge">curl</code> allows for insecure connections to my Satellite. The reason being, that the EE does not trust the certificate authority I have
signed the Satellite’s certificate with. This can, of course, be circumvented by adding the appropriate certificate authority certificates to <code class="language-plaintext highlighter-rouge">/etc/pki/ca-trust/source/anchors</code>
and update the certificate authority database using <code class="language-plaintext highlighter-rouge">update-ca-trust</code>.</p>

<p>That looks good, let’s try to import the downloaded <code class="language-plaintext highlighter-rouge">GPG</code> key with the <code class="language-plaintext highlighter-rouge">rpm</code> command:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-4.4#</span><span class="w"> </span>rpm <span class="nt">--import</span> /etc/pki/rpm-gpg/zabbix-gpg
<span class="gp">bash-4.4#</span><span class="w"> </span><span class="nb">echo</span> <span class="nv">$?</span>
<span class="go">0
</span><span class="gp">bash-4.4#</span><span class="w"> </span>rpm <span class="nt">-q</span> <span class="nt">--queryformat</span> <span class="s2">"%{SUMMARY}</span><span class="se">\n</span><span class="s2">"</span> <span class="si">$(</span>rpm <span class="nt">-q</span> gpg-pubkey<span class="si">)</span>
<span class="gp">gpg(Red Hat, Inc. (release key 2) &lt;security@redhat.com&gt;</span><span class="o">)</span>
<span class="gp">gpg(Red Hat, Inc. (auxiliary key) &lt;security@redhat.com&gt;</span><span class="o">)</span>
<span class="gp">gpg(Zabbix SIA &lt;packager@zabbix.com&gt;</span><span class="o">)</span>
<span class="gp">gpg(Zabbix LLC &lt;packager@zabbix.com&gt;</span><span class="o">)</span>
</code></pre></div></div>

<p>Okay, great, let’s try to install a package from that repository: <code class="language-plaintext highlighter-rouge">zabbix-sender</code></p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-4.4#</span><span class="w"> </span>microdnf <span class="nb">install</span> <span class="nt">--enablerepo</span><span class="o">=</span><span class="k">*</span>zabbix<span class="k">*</span> zabbix-sender
<span class="go">Downloading metadata...
Downloading metadata...
Downloading metadata...
Package                                                                                                                         Repository                                Size
Installing:
 zabbix-sender-6.0.27-release1.el8.x86_64                                                                                       org-core_prd-zabbix-zabbix_repo-zabb     457.5 kB
Transaction Summary:
 Installing:        1 packages
 Reinstalling:      0 packages
 Upgrading:         0 packages
 Obsoleting:        0 packages
 Removing:          0 packages
 Downgrading:       0 packages
Downloading packages...
error: failed to parse public key for /var/cache/yum/metadata/org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8-8-x86_64/gpg_key_content
</span></code></pre></div></div>

<p>Even when downloading the <code class="language-plaintext highlighter-rouge">GPG</code> key and specifying it as file in <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/redhat.repo</code>, the same error would persist:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-4.4#</span><span class="w"> </span><span class="nb">cat</span> /etc/yum.repos.d/redhat.repo
<span class="go">[..]

[org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8]
name=repo-zabbix-zabbix-6_0-rhel-8
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/custom/prd-zabbix-zabbix/repo-zabbix-zabbix-6_0-rhel-8
enabled=false
gpgkey=file:///tmp/zabbix-gpg
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[..]
</span><span class="gp">bash-4.4#</span><span class="w"> </span>microdnf clean all
<span class="go">Complete.
</span><span class="gp">bash-4.4#</span><span class="w"> </span>microdnf <span class="nb">install</span> <span class="nt">--enablerepo</span><span class="o">=</span><span class="k">*</span>zabbix<span class="k">*</span> zabbix-sender
<span class="go">Downloading metadata...
Downloading metadata...
Downloading metadata...
Package                                                                                                                         Repository                                Size
Installing:
 zabbix-sender-6.0.27-release1.el8.x86_64                                                                                       org-core_prd-zabbix-zabbix_repo-zabb     457.5 kB
Transaction Summary:
 Installing:        1 packages
 Reinstalling:      0 packages
 Upgrading:         0 packages
 Obsoleting:        0 packages
 Removing:          0 packages
 Downgrading:       0 packages
Downloading packages...
error: failed to parse public key for /var/cache/yum/metadata/org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8-8-x86_64/gpg_key_content
</span></code></pre></div></div>

<p>I <strong>think</strong> that is because <code class="language-plaintext highlighter-rouge">microdnf</code> updates the contents of <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/*</code> <em>every time</em> <code class="language-plaintext highlighter-rouge">microdnf</code> is invoked. Let’s see if we can spot the update while watching
the file <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/redhat.repo</code> in a <code class="language-plaintext highlighter-rouge">tmux</code> session.</p>

<p>First, we need to install <code class="language-plaintext highlighter-rouge">tmux</code> and <code class="language-plaintext highlighter-rouge">procps-ng</code> - the latter provides the <code class="language-plaintext highlighter-rouge">watch</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>microdnf install tmux procps-ng
</code></pre></div></div>

<p>Then create a new <code class="language-plaintext highlighter-rouge">tmux</code> session by running <code class="language-plaintext highlighter-rouge">tmux</code> followed by creating a horizontal split of the current <code class="language-plaintext highlighter-rouge">tmux</code> window using <code class="language-plaintext highlighter-rouge">CTRL</code> + <code class="language-plaintext highlighter-rouge">b</code> <code class="language-plaintext highlighter-rouge">"</code>.</p>

<p>In either of the so-called <code class="language-plaintext highlighter-rouge">panes</code>, first, we’ll update <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/redhat.repo</code> to specify the <code class="language-plaintext highlighter-rouge">GPG</code> key as local file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[..]

[org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8]
name=repo-zabbix-zabbix-6_0-rhel-8
baseurl=https://satellite.example.com/pulp/content//org-core/lce-default-prod/ccv-default-rhel-8/custom/prd-zabbix-zabbix/repo-zabbix-zabbix-6_0-rhel-8
enabled=false
gpgkey=file:///tmp/zabbix-gpg
gpgcheck=true
metadata_expire=1
sslclientcert=/etc/pki/entitlement-host/3057439186715165628.pem
sslclientkey=/etc/pki/entitlement-host/3057439186715165628-key.pem
sslcacert=/etc/rhsm-host/ca/katello-server-ca.pem
sslverify=true

[..]
</code></pre></div></div>

<p>Next, we’ll create a copy of the file to <code class="language-plaintext highlighter-rouge">/tmp/redhat.repo</code>. We’ll use that together with <code class="language-plaintext highlighter-rouge">diff</code> to find any possible differences:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[root@612c8f7fbb1e runner]#</span><span class="w"> </span><span class="nb">cp</span> /etc/yum.repos.d/redhat.repo /tmp/redhat.repo
<span class="gp">[root@612c8f7fbb1e runner]#</span><span class="w"> </span>diff /etc/yum.repos.d/redhat.repo /tmp/redhat.repo
<span class="gp">[root@612c8f7fbb1e runner]#</span><span class="w">
</span></code></pre></div></div>

<p>The files are, of course, equal at this point.</p>

<p>Let’s run <code class="language-plaintext highlighter-rouge">watch</code> and switch to our other <code class="language-plaintext highlighter-rouge">pane</code> to run <code class="language-plaintext highlighter-rouge">microdnf</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">watch -n1 diff /etc/yum.repos.d/redhat.repo /tmp/redhat.repo
</span></code></pre></div></div>

<p>Next, switch the <code class="language-plaintext highlighter-rouge">pane</code> by using <code class="language-plaintext highlighter-rouge">CTRL</code> + <code class="language-plaintext highlighter-rouge">b</code> <code class="language-plaintext highlighter-rouge">o</code> and try installing the <code class="language-plaintext highlighter-rouge">zabbix-sender</code> package again:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[root@612c8f7fbb1e runner]#</span><span class="w">  </span>microdnf <span class="nb">install</span> <span class="nt">--enablerepo</span><span class="o">=</span><span class="k">*</span>zabbix<span class="k">*</span> zabbix-sender
<span class="go">
[..]

error: failed to parse public key for /var/cache/yum/metadata/org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8-8-x86_64/gpg_key_content
</span></code></pre></div></div>

<p>The outcome is the same - as expected. But now, look at what the other command captured:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Every 1.0s: diff /etc/yum.repos.d/redhat.repo /tmp/redhat.repo

17c17
&lt; gpgkey=https://satellite.example.com/katello/api/v2/repositories/14/gpg_key_content
---
</span><span class="gp">&gt;</span><span class="w"> </span><span class="nv">gpgkey</span><span class="o">=</span>file:///tmp/zabbix-gpg
</code></pre></div></div>

<p>Immediately at the start of <code class="language-plaintext highlighter-rouge">microdnf</code>, the file content changed and was reverted to the original <code class="language-plaintext highlighter-rouge">gpgkey</code> line.</p>

<p>As I said, I couldn’t figure out a way to make this work with <code class="language-plaintext highlighter-rouge">microdnf</code>. <img class="emoji" title=":pensive:" alt=":pensive:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f614.png" height="20" width="20"></p>
<h4 id="solutions-to-the-problem">
  
  
    Solutions to the problem <a href="#solutions-to-the-problem">#</a>
  
  
</h4>
    

<p>So what’s the solution to the problem then, I hear you ask. Well, there are two ways we can make this work:</p>

<ol>
  <li>Disable <code class="language-plaintext highlighter-rouge">GPG</code> key checking for that specific repository</li>
  <li>Think a little outside the box</li>
</ol>

<p>I dislike the first option, as disabling <code class="language-plaintext highlighter-rouge">GPG</code> key checking is <em>never</em> a good idea - plus I like the idea of the second option (bear with me, we’ll get to it in a minute)
<img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">.</p>

<p>Let’s briefly look into disabling <code class="language-plaintext highlighter-rouge">GPG</code> key checking for a specific repository. We’ll utilize the <code class="language-plaintext highlighter-rouge">--setopt</code> parameter of <code class="language-plaintext highlighter-rouge">microdnf</code> to set the option <code class="language-plaintext highlighter-rouge">gpgcheck</code> to <code class="language-plaintext highlighter-rouge">0</code> for
the specific repository that fails <code class="language-plaintext highlighter-rouge">GPG</code> validation: <code class="language-plaintext highlighter-rouge">org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8</code>.</p>

<p>This will look something like this:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[root@612c8f7fbb1e runner]#</span><span class="w"> </span>microdnf <span class="nb">install </span>zabbix-sender <span class="nt">--enablerepo</span><span class="o">=</span><span class="k">*</span>zabbix<span class="k">*</span> <span class="nt">--setopt</span> org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8.gpgcheck<span class="o">=</span>0
<span class="go">Downloading metadata...
Downloading metadata...
Downloading metadata...
Package                                                                                                                         Repository                            Size
Installing:
 zabbix-sender-6.0.27-release1.el8.x86_64                                                                                       org-core_prd-zabbix-zabbix_repo-zabb  457.5 kB
Transaction Summary:
 Installing:        1 packages
 Reinstalling:      0 packages
 Upgrading:         0 packages
 Obsoleting:        0 packages
 Removing:          0 packages
 Downgrading:       0 packages
Running transaction test...
</span><span class="gp">Installing: zabbix-sender;</span>6.0.27-release1.el8<span class="p">;</span>x86_64<span class="p">;</span>org-core_prd-zabbix-zabbix_repo-zabbix-zabbix-6_0-rhel-8
<span class="go">Complete.
</span></code></pre></div></div>

<p>Perfect, <code class="language-plaintext highlighter-rouge">zabbix-sender</code> is installed.</p>

<p>This can be set during EE build with the environment variable <code class="language-plaintext highlighter-rouge">PKGMGR_OPTS</code>. It’s exactly the same as described in the
<a href="#enabling-and-disabling-repositories">Enabling and disabling repositories</a> section.</p>

<p>Again, I dislike the option of disabling <code class="language-plaintext highlighter-rouge">GPG</code> validation for security reasons.</p>

<p>So, what’s the other option then?</p>

<p>While playing around in the EE, I thought: What about I try installing the package with <code class="language-plaintext highlighter-rouge">dnf</code> instead of <code class="language-plaintext highlighter-rouge">microdnf</code>?!</p>

<p>As it turns out: This seems to work perfectly fine. No disabling of <code class="language-plaintext highlighter-rouge">GPG</code> validation or anything fancy required - just a <code class="language-plaintext highlighter-rouge">microdnf install -y dnf</code> followed by
<code class="language-plaintext highlighter-rouge">dnf install -y zabbix-sender</code>.</p>

<p>Let’s see if we can implement that into an EE definition.</p>

<p>We <em>need</em> to change two things:</p>

<ol>
  <li>Adjust the option <code class="language-plaintext highlighter-rouge">package_manager_path</code> to use <code class="language-plaintext highlighter-rouge">dnf</code> instead of <code class="language-plaintext highlighter-rouge">microdnf</code> - or leave it in fact on it’s default value, which will use <code class="language-plaintext highlighter-rouge">dnf</code>
</li>
  <li>Prepend a step to each build step that utilizes <code class="language-plaintext highlighter-rouge">dnf</code>, to install <code class="language-plaintext highlighter-rouge">dnf</code>. That is to ensure <code class="language-plaintext highlighter-rouge">dnf</code> is available</li>
  <li>Optionally, append a step after each build step that utilizes <code class="language-plaintext highlighter-rouge">dnf</code> to remove <code class="language-plaintext highlighter-rouge">dnf</code> again, as we do not need it anymore. This saves a little space <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">
</li>
</ol>

<p>Based on the above <a href="#the-complete-complex-execution-environment-making-use-of-advanced-yaml-syntax">EE definition</a>, and adding additionally the installation of <code class="language-plaintext highlighter-rouge">zabbix-sender</code>
from a custom 3rd-party repository, as well as incorporating the above steps, an example EE definition can look something like this:</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> Please read the notes after the EE definition example. Removing <code class="language-plaintext highlighter-rouge">dnf</code> is not as straight forward as one would imagine and is certainly not without risk. I am just
showcasing that it <em>can</em> be done - but it is certainly nothing I’d recommend doing.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">3</span>

<span class="na">images</span><span class="pi">:</span>
  <span class="na">base_image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.yml'</span>
  <span class="na">python</span><span class="pi">:</span> <span class="s1">'</span><span class="s">requirements.txt'</span>
  <span class="na">system</span><span class="pi">:</span> <span class="s1">'</span><span class="s">bindep.txt'</span>

<span class="na">options</span><span class="pi">:</span>
  <span class="na">package_manager_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/usr/bin/dnf'</span>

<span class="na">additional_build_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ansible.cfg'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">configs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ca.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

    <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s1">'</span><span class="s">intermediate.cert.pem'</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">certs/'</span>

<span class="na">additional_build_steps</span><span class="pi">:</span>
  <span class="na">prepend_base</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nl">&amp;copy-certs</span> <span class="pi">|-</span>
        <span class="s">COPY _build/certs/* /etc/pki/ca-trust/source/anchors/</span>
        <span class="s">RUN update-ca-trust</span>

    <span class="pi">-</span> <span class="nl">&amp;system-proxy</span> <span class="pi">|-</span>
        <span class="s">ENV https_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128</span>
        <span class="s">ENV http_proxy=http://lab-development-rhel8.core.rh.scheib.me:3128</span>
    <span class="pi">-</span> <span class="nl">&amp;pip</span> <span class="pi">|-</span>
        <span class="s">RUN pip3 config --user set global.index-url http://lab-development-rhel8.core.rh.scheib.me/simple</span>
        <span class="s">RUN pip3 config --user set global.trusted-host lab-development-rhel8.core.rh.scheib.me</span>
        <span class="s">RUN pip3 config --user set global.proxy http://lab-development-rhel8.core.rh.scheib.me:3128</span>

  <span class="na">prepend_galaxy</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">COPY</span><span class="nv"> </span><span class="s">_build/configs/ansible.cfg</span><span class="nv"> </span><span class="s">/home/runner/.ansible.cfg'</span>

  <span class="na">prepend_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="nv">*pip</span>
    <span class="pi">-</span> <span class="nl">&amp;enable-ubi</span> <span class="pi">|-</span>
       <span class="s">ENV PKGMGR_OPTS="--nodocs --setopt=install_weak_deps=0 --disablerepo=* --enablerepo=ubi-8-*"</span>

    <span class="pi">-</span> <span class="nl">&amp;install-dnf</span> <span class="pi">|-</span>
        <span class="s">RUN rpm -qa | sort &gt; /tmp/before</span>
        <span class="s">RUN microdnf install -y dnf</span>
        <span class="s">RUN rpm -qa | sort &gt; /tmp/after</span>

    <span class="pi">-</span> <span class="nl">&amp;manage-repos</span> <span class="pi">&gt;-</span>
       <span class="s">ENV PKGMGR_OPTS="--nodocs --setopt=install_weak_deps=0 --disablerepo=* --enablerepo=ubi-8-* --enablerepo=*zabbix*"</span>

  <span class="na">append_builder</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nl">&amp;remove-dnf</span> <span class="pi">|-</span>
        <span class="s">RUN dnf clean all</span>
        <span class="s">RUN dnf --setopt=protected_packages="" --setopt=protect_running_kernel=false \</span>
            <span class="s">remove -y $(comm -13 /tmp/before /tmp/after)</span>

    <span class="pi">-</span> <span class="nl">&amp;clean-dnf</span> <span class="pi">|-</span>
        <span class="s">RUN rm -rf /tmp/before /tmp/after</span>
        <span class="s">RUN rm -rf /var/cache/dnf /var/cache/yum</span>
        <span class="s">RUN rm -rf /var/lib/dnf/history.sqlite /var/lib/dnf/history.sqlite-shm /var/lib/dnf/history.sqlite-wal</span>
        <span class="s">RUN rm -rf /var/log/dnf.librepo.log /var/log/dnf.log /var/log/dnf.rpm.log /var/log/hawkey.log</span>

  <span class="na">prepend_final</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*copy-certs</span>
    <span class="pi">-</span> <span class="nv">*system-proxy</span>
    <span class="pi">-</span> <span class="nv">*pip</span>
    <span class="pi">-</span> <span class="nv">*enable-ubi</span>
    <span class="pi">-</span> <span class="nv">*install-dnf</span>
    <span class="pi">-</span> <span class="nv">*manage-repos</span>

  <span class="na">append_final</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="nv">*remove-dnf</span>
    <span class="pi">-</span> <span class="nv">*clean-dnf</span>
<span class="nn">...</span>
</code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> The file <code class="language-plaintext highlighter-rouge">bindep.txt</code> merely contains <code class="language-plaintext highlighter-rouge">zabbix-sender</code> as package.</p>

<p>You might notice that in the above EE definition we do some ‘fancy’ things. Let me break them down one by one:</p>

<ol>
  <li>
    <p>Removing <code class="language-plaintext highlighter-rouge">dnf</code> again after we are done using it</p>

    <p>Unfortunately, <code class="language-plaintext highlighter-rouge">microdnf</code> <a href="https://github.com/rpm-software-management/microdnf/issues/45">does not support</a> something like the <code class="language-plaintext highlighter-rouge">dnf</code> option <code class="language-plaintext highlighter-rouge">autoremove</code>.
 For that reason we need to save the installed packages <em>before</em> we install <code class="language-plaintext highlighter-rouge">dnf</code> and <em>after</em> we installed <code class="language-plaintext highlighter-rouge">dnf</code>. This allows us to compare what was installed
 as dependencies with <code class="language-plaintext highlighter-rouge">dnf</code>, so that we are able to remove those dependencies later again.</p>

    <p>By default, both <code class="language-plaintext highlighter-rouge">dnf</code> and <code class="language-plaintext highlighter-rouge">microdnf</code> will prevent us from removing <code class="language-plaintext highlighter-rouge">dnf</code>, as it is considered a
 <a href="https://rpm-software-management.github.io/dnf-plugins-core/protected_packages.html"><code class="language-plaintext highlighter-rouge">protected</code> package</a> - and rightfully so. According to the
 <a href="https://rpm-software-management.github.io/dnf-plugins-core/protected_packages.html">documentation</a> of the <code class="language-plaintext highlighter-rouge">protected_packages</code> <code class="language-plaintext highlighter-rouge">dnf</code> plugin, disabling the plugin <em>should</em>
 work by providing <code class="language-plaintext highlighter-rouge">--disableplugin=protected_packages</code> to <code class="language-plaintext highlighter-rouge">dnf</code>, but I couldn’t make it work.</p>

    <p>Instead, we set the <code class="language-plaintext highlighter-rouge">protected_packages</code> to an empty list. Further, the other required option is <code class="language-plaintext highlighter-rouge">protect_running_kernel=false</code>, otherwise we would not be able
 to remove <code class="language-plaintext highlighter-rouge">dnf</code>.</p>

    <p>Finally, we pass the the differences of <code class="language-plaintext highlighter-rouge">/tmp/before</code> and <code class="language-plaintext highlighter-rouge">/tmp/after</code> using <a href="https://www.gnu.org/software/coreutils/manual/html_node/comm-invocation.html"><code class="language-plaintext highlighter-rouge">comm</code></a> to the
 <code class="language-plaintext highlighter-rouge">dnf</code> remove command to remove the leftover dependencies.</p>

    <p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> Removing <code class="language-plaintext highlighter-rouge">dnf</code> is <strong>dangerous</strong>. We risk breaking other packages’ dependencies when forcefully removing the dependencies of <code class="language-plaintext highlighter-rouge">dnf</code>. I recommend to leaving <code class="language-plaintext highlighter-rouge">dnf</code> and
 its dependencies installed, although this results in a <em>slightly</em> larger image.</p>
  </li>
  <li>
    <p>Removing left over log files</p>

    <p>Additionally to removing <code class="language-plaintext highlighter-rouge">dnf</code>, we should clean up all log files of <code class="language-plaintext highlighter-rouge">dnf</code> and <code class="language-plaintext highlighter-rouge">microdnf</code>. This is usually done by default, but since we are appending something to the end of
  a build stage and are invoking <code class="language-plaintext highlighter-rouge">microdnf</code> again, we should once more ensure that unnecessary log files are removed.</p>

    <p>Finally, we remove the two temporary files we needed to compare the before and after <code class="language-plaintext highlighter-rouge">RPMs</code>.</p>
  </li>
</ol>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> <strong>Another word of caution</strong>: Removing protected packages is something I <strong>cannot</strong> recommend to do, as it might have unexpected consequences. I don’t know of any at
the moment, but I imagine there is a risk of breaking <em>something</em>. After all, the size difference before and after installing <code class="language-plaintext highlighter-rouge">dnf</code> was roughly 80 megabytes. Given that the
image is already roughly ~900+ megabytes big, the additional 80 will not make a big difference, in my opinion.</p>

<p>Of course, you can build your very own <a href="#using-custom-base-images">base image</a> and incorporate the installation of <code class="language-plaintext highlighter-rouge">dnf</code> in the base image. This would remove the need of
installing and removing <code class="language-plaintext highlighter-rouge">dnf</code> at every build stage where packages are installed.</p>

<p>You could add the installation to your base image and the removal as the very last step in your actual EE. That way you’d still save some space.</p>

<p>But again: <strong>I strongly recommend not removing <code class="language-plaintext highlighter-rouge">dnf</code> again, as it can possibly break <em>something</em>.</strong></p>
<h2 id="conclusion">
  
  
    Conclusion <a href="#conclusion">#</a>
  
  
</h2>
    

<p>I <em>think</em> I am done. Honestly, I kind of lost the overview with all the topics - it turned out to be longer than I anticipated <img class="emoji" title=":rofl:" alt=":rofl:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f923.png" height="20" width="20">.</p>

<p>I hope you learned something new <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">. Please let me know if you find anything to be incorrect!</p>

<p>If you have any questions, just leave a comment and I might be able to incorporate your use-case in this post.</p>

<p>.. until next time,</p>

<p>Steffen</p>
<h2 id="change-log">
  
  
    Change log <a href="#change-log">#</a>
  
  
</h2>
    
<h3 id="2024-04-25">
  
  
    2024-04-25 <a href="#2024-04-25">#</a>
  
  
</h3>
    

<ul>
  <li>Adding a section about <a href="#mounting-certificates-inside-the-ee-while-using-ansible-navigator">mounting certificates into an <code class="language-plaintext highlighter-rouge">EE</code></a>. Thanks to my colleague
<a href="https://github.com/tuxpreacher">Jason Breitweg</a> for discussing this with me!</li>
</ul>
<h3 id="2024-04-01">
  
  
    2024-04-01 <a href="#2024-04-01">#</a>
  
  
</h3>
    

<ul>
  <li>Adding a section about <a href="#enabling-non-red-hat-repositories">enabling custom repositories</a>
</li>
  <li>Spelling fixes</li>
</ul>
<h3 id="2024-03-12">
  
  
    2024-03-12 <a href="#2024-03-12">#</a>
  
  
</h3>
    

<ul>
  <li>Fixing the initial change log date</li>
</ul>
<h3 id="2024-03-11">
  
  
    2024-03-11 <a href="#2024-03-11">#</a>
  
  
</h3>
    

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">markdownlint</code> fixes</li>
  <li>Spelling fixes</li>
</ul>
<h3 id="2024-03-10">
  
  
    2024-03-10 <a href="#2024-03-10">#</a>
  
  
</h3>
    

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">markdownlint</code> fixes</li>
</ul>
<h3 id="2024-03-02">
  
  
    2024-03-02 <a href="#2024-03-02">#</a>
  
  
</h3>
    

<ul>
  <li>Adding Section about custom <code class="language-plaintext highlighter-rouge">base</code> images</li>
  <li>Adding <code class="language-plaintext highlighter-rouge">SHA</code> digest image “pinning” -
Thanks to my colleague <a href="https://github.com/michaelalang">Michaela Lang</a> for pointing this out!</li>
  <li>Clarification about reproducibility with regards to Ansible content, Python and system packages -
Thanks to my colleague <a href="https://github.com/michaelalang">Michaela Lang</a> for pointing this out!</li>
</ul>

  </div>

  <script src="https://utteranc.es/client.js" repo="sscheib/sscheib.github.io-comments" issue-term="title" label="comment" theme="github-light" crossorigin="anonymous" async>
  </script>

  <a class="u-url" href="/2024/02/17/execution-environments.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://blog.scheib.me/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          
        </ul>
      </div>
      <div class="footer-col">
        <p>This my personal blog, where I post about things that I do and find interesting. All posts and thoughts on this blog are solely my opinion and are not related to my employer.</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list"><li><a href="https://github.com/sscheib"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sscheib</span></a></li></ul>
</div>
    <div class="datenschutzerklaerung">
    <a style="font-size:10px" href="https://blog.scheib.me/datenschutzerklaerung.html">Datenschutzerklärung</a> <a style="font-size:10px" href="https://blog.scheib.me/impressum.html">Impressum</a>
    </div>

  </div>
</footer>
</body>

</html>
