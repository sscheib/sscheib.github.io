<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Manually installing Debian 12 (Bookworm) with fully encrypted LUKS (besides /boot) using debootstrap | Steffen’s random thoughts</title>
<meta name="generator" content="Jekyll v3.9.5">
<meta property="og:title" content="Manually installing Debian 12 (Bookworm) with fully encrypted LUKS (besides /boot) using debootstrap">
<meta name="author" content="Steffen Scheib">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction">
<meta property="og:description" content="Introduction">
<link rel="canonical" href="https://blog.scheib.me/2023/08/28/debootstrapping-debian-bookworm.html">
<meta property="og:url" content="https://blog.scheib.me/2023/08/28/debootstrapping-debian-bookworm.html">
<meta property="og:site_name" content="Steffen’s random thoughts">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-08-28T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Manually installing Debian 12 (Bookworm) with fully encrypted LUKS (besides /boot) using debootstrap">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Steffen Scheib"},"dateModified":"2024-04-01T00:00:00+00:00","datePublished":"2023-08-28T00:00:00+00:00","description":"Introduction","headline":"Manually installing Debian 12 (Bookworm) with fully encrypted LUKS (besides /boot) using debootstrap","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.scheib.me/2023/08/28/debootstrapping-debian-bookworm.html"},"url":"https://blog.scheib.me/2023/08/28/debootstrapping-debian-bookworm.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://blog.scheib.me/feed.xml" title="Steffen's random thoughts">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Steffen's random thoughts</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">/about</a></div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Manually installing Debian 12 (Bookworm) with fully encrypted LUKS (besides /boot) using debootstrap</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-08-28T00:00:00+00:00" itemprop="datePublished">Published: Aug 28, 2023
      </time>
      <time class="dt-modified" datetime="2024-04-01T00:00:00+00:00" itemprop="dateModified">• Last modified: Apr 1, 2024
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Steffen Scheib </span></span>• <span itemprop="readingTime" itemscope><span class="h-card" itemprop="readingTime">

101 minutes to read
</span></span></p>
  </header>

  <div class="toc">
    <h2>Table of contents</h2>
    <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#preparing-the-disks-of-the-server-partitioning-the-drives">Preparing the disks of the server: Partitioning the drives</a></li>
<li><a href="#optional-creating-a-raid-1-using-mdadm">Optional: Creating a RAID 1 using <code class="language-plaintext highlighter-rouge">mdadm</code></a></li>
<li><a href="#optional-partition-another-drive-to-store-your-application-data-to-keep-it-separate-from-the-system-disk">Optional: Partition another drive to store your (application) data to keep it separate from the system disk</a></li>
<li><a href="#formatting-partitions-and-setting-up-the-encrypted-lvm">Formatting partitions and setting up the encrypted <code class="language-plaintext highlighter-rouge">LVM</code></a></li>
<li><a href="#formatting-boot">Formatting /boot</a></li>
<li>
<a href="#creating-a-luks-partition-to-hold-our-system-partitions">Creating a <code class="language-plaintext highlighter-rouge">LUKS</code> partition to hold our system partitions</a><ul><li><a href="#optional-creating-luks-partition-for-the-data-partition">Optional: Creating <code class="language-plaintext highlighter-rouge">LUKS</code> partition for the data partition</a></li></ul>
</li>
<li><a href="#setting-up-lvm-creating-a-physical-volume-a-volume-group-and-several-logical-volumes-for-the-encrypted-luks-partition">Setting up <code class="language-plaintext highlighter-rouge">LVM</code>: Creating a physical volume, a volume group and several logical volumes for the encrypted <code class="language-plaintext highlighter-rouge">LUKS</code> partition</a></li>
<li><a href="#creating-a-physical-volume-on-top-of-the-luks-partition">Creating a physical volume on top of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition</a></li>
<li><a href="#creating-a-volume-group-on-top-of-the-physical-volume">Creating a volume group on top of the physical volume</a></li>
<li>
<a href="#creating-logical-volumes-on-top-of-the-volume-group">Creating logical volumes on top of the volume group</a><ul><li><a href="#optional-create-lvm-for-the-data-disk">Optional: Create <code class="language-plaintext highlighter-rouge">LVM</code> for the data disk</a></li></ul>
</li>
<li><a href="#create-filesystems-on-logical-volumes">Create filesystems on logical volumes</a></li>
<li>
<a href="#prepare-for-the-installation">Prepare for the installation</a><ul>
<li><a href="#mounting-the-partitions">Mounting the partitions</a></li>
<li><a href="#starting-the-installation">Starting the installation</a></li>
<li><a href="#downloading-debootstrap-and-modify-it">Downloading <code class="language-plaintext highlighter-rouge">Debootstrap</code> and modify it</a></li>
</ul>
</li>
<li><a href="#installation-of-the-system">Installation of the system</a></li>
<li><a href="#base-configuration">Base configuration</a></li>
<li>
<a href="#configuring-etccrypttab-and-etcfstab">Configuring <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> and <code class="language-plaintext highlighter-rouge">/etc/fstab</code></a><ul><li><a href="#optional-configuring-automatical-unlock-of-the-data-partition">Optional: Configuring automatical unlock of the data partition</a></li></ul>
</li>
<li><a href="#installing-additional-software">Installing additional software</a></li>
<li>
<a href="#post-installation-tasks">Post-installation tasks</a><ul>
<li><a href="#configuring-vim">Configuring vim</a></li>
<li><a href="#adding-an-additional-user">Adding an additional user</a></li>
<li><a href="#hardening-the-system">“Hardening” the system</a></li>
</ul>
</li>
<li>
<a href="#preparing-the-remote-unlock-via-ssh-of-the-luks-partition">Preparing the remote unlock via SSH of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition</a><ul>
<li><a href="#configure-dropbear">Configure <code class="language-plaintext highlighter-rouge">Dropbear</code></a></li>
<li><a href="#configure-grub">Configure GRUB</a></li>
<li><a href="#adding-drivers-to-initramfs">Adding drivers to <code class="language-plaintext highlighter-rouge">initramfs</code></a></li>
<li><a href="#optional-updating-the-mdadm-configuration">Optional: Updating the <code class="language-plaintext highlighter-rouge">mdadm</code> configuration</a></li>
<li><a href="#installing-grub-generating-new-initramfs-and-updating-grub">Installing GRUB, generating new <code class="language-plaintext highlighter-rouge">initramfs</code> and updating GRUB</a></li>
</ul>
</li>
<li><a href="#troubleshooting-the-installation">Troubleshooting the installation</a></li>
<li>
<a href="#change-log">Change log</a><ul>
<li><a href="#2025-01-23">2025-01-23</a></li>
<li><a href="#2024-04-01">2024-04-01</a></li>
<li><a href="#2024-03-11">2024-03-11</a></li>
<li><a href="#2024-03-10">2024-03-10</a></li>
<li><a href="#2024-02-02">2024-02-02</a></li>
</ul>
</li>
</ul>
  </div>
  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">
  
  
    Introduction <a href="#introduction">#</a>
  
  
</h2>
    

<p>In this post, we’ll cover the installation and configuration of a Debian 12 (Bookworm) system within a live environment.
Such a live system could be the <a href="https://docs.hetzner.com/robot/dedicated-server/troubleshooting/hetzner-rescue-system/">Hetzner rescue mode</a>, or any other live CD based
on Debian, such as <a href="https://www.system-rescue.org/">SystemRescue</a> [formerly known as <em>SystemRescueCd</em>]).
In this example we are going to use the Hetzner rescue mode.</p>

<p>In this post I’ll create three <a href="https://wiki.debian.org/SoftwareRAID">software RAIDs</a> based on <a href="https://packages.debian.org/de/sid/mdadm"><code class="language-plaintext highlighter-rouge">mdadm</code></a>. I’ll create a RAID 1 for
the dedicated <code class="language-plaintext highlighter-rouge">/boot</code> partition, another RAID 1 for the operating system (both the <code class="language-plaintext highlighter-rouge">/boot</code> partition and the OS get installed on NVMe drives) and a RAID 6 which will
consist of all the HDDs in my server.</p>

<p>You do <em>not</em> have to have the very same setup as I do, but please keep in mind, that you might need to adapt certain commands. To ease the process for people with a
different setup than mine, I’ll add an information block on each of those commands that are specific to my use case - similar to the one below:</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> This is an information block <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20"></p>

<p>In my blog post
<a href="https://blog.scheib.me/2023/05/01/debootstrapping-debian.html">Manually installing Debian 11 (Bullseye) with fully encrypted <code class="language-plaintext highlighter-rouge">LUKS</code> (besides /boot) using <code class="language-plaintext highlighter-rouge">debootstrap</code></a> I am
describing the partitioning process with no software RAID. This might be helpful for those folks that do not want to use a RAID.</p>

<p>With that being set, let’s jump right into it.</p>
<h2 id="prerequisites">
  
  
    Prerequisites <a href="#prerequisites">#</a>
  
  
</h2>
    

<p>The only real prerequisite is, that you have booted your server and are logged in to your live CD environment as root.</p>
<h2 id="preparing-the-disks-of-the-server-partitioning-the-drives">
  
  
    Preparing the disks of the server: Partitioning the drives <a href="#preparing-the-disks-of-the-server-partitioning-the-drives">#</a>
  
  
</h2>
    

<p>The first step is to partition the drives we are going to use using <code class="language-plaintext highlighter-rouge">gdisk</code> (in this example), <code class="language-plaintext highlighter-rouge">fdisk</code> or anything similar.</p>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> I am going to use the partition type <code class="language-plaintext highlighter-rouge">fd00</code> (Linux RAID) for the second and third partition. If you do not want to RAID your disks, simply
use <code class="language-plaintext highlighter-rouge">8300</code> (Linux Filesystem).</p>

<p>We are going to configure three partitions:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">BIOS boot partition</code> (<strong>32 MB</strong>, although 1 MB would be theoretically enough, type <code class="language-plaintext highlighter-rouge">EF02</code>).
This partition is necessary for <code class="language-plaintext highlighter-rouge">GPT</code> partitions in order to load the second stage of GRUB.</li>
  <li>
<code class="language-plaintext highlighter-rouge">/boot partition</code> (<strong>1024 MB - 4096MB</strong>, type <code class="language-plaintext highlighter-rouge">FD00</code>):
In this partition the boot files will be stored. In order to be able to boot a machine, this partition needs to be unencrypted.
If you are not planning on rebooting very frequently (to apply kernel updates), consider using 4096MB for the partition size;
Otherwise you may need to do manual cleanups in order to install new kernel versions. I have used 8192MB to be able to run the system <em>very</em> long until I need to reboot to
apply kernels. Your mileage may very, of course.</li>
  <li>The remaining space will be put in this partition (type <code class="language-plaintext highlighter-rouge">FD00</code> as well), which is later holding all our <strong>encrypted</strong> data</li>
</ol>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> If you only have one disk or simply don’t want to create a RAID of your disks, you need to adjust the types accordingly (usually, type <code class="language-plaintext highlighter-rouge">ef02</code>).</p>

<!-- markdownlint-disable MD033 -->
<details>
<summary>Example output of <code>gdisk</code>:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue ~ #</span><span class="w"> </span>gdisk /dev/nvme0n1
<span class="go">GPT fdisk (gdisk) version 1.0.9

Partition table scan:
  MBR: not present
  BSD: not present
  APM: not present
  GPT: not present

Creating new GPT entries in memory.

Command (? for help): n
Partition number (1-128, default 1):
First sector (34-1875384974, default = 2048) or {+-}size{KMGTP}:
Last sector (2048-1875384974, default = 1875384319) or {+-}size{KMGTP}: +32M
Current type is 8300 (Linux filesystem)
Hex code or GUID (L to show codes, Enter = 8300): EF02
Changed type of partition to 'BIOS boot partition'

Command (? for help): n
Partition number (2-128, default 2):
First sector (34-1875384974, default = 67584) or {+-}size{KMGTP}:
Last sector (67584-1875384974, default = 1875384319) or {+-}size{KMGTP}: +8192M
Current type is 8300 (Linux filesystem)
Hex code or GUID (L to show codes, Enter = 8300): fd00
Changed type of partition to 'Linux RAID'

Command (? for help): n
Partition number (3-128, default 3):
First sector (34-1875384974, default = 16844800) or {+-}size{KMGTP}:
Last sector (16844800-1875384974, default = 1875384319) or {+-}size{KMGTP}:
Current type is 8300 (Linux filesystem)
Hex code or GUID (L to show codes, Enter = 8300): fd00
Changed type of partition to 'Linux RAID'

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
</span><span class="gp">OK;</span><span class="w"> </span>writing new GUID partition table <span class="o">(</span>GPT<span class="o">)</span> to /dev/nvme0n1.
<span class="go">The operation has completed successfully.</span></code></pre></figure>


</details>
<p><br>
<!-- markdownlint-enable MD033 --></p>

<p>At the end we will have partitions, which should look similar to the following output (besides the last partition size, which depends - of course - on the overall disk size):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>gdisk <span class="nt">-l</span> /dev/nvme0n1
<span class="go">GPT fdisk (gdisk) version 1.0.9
[..]
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048           67583   32.0 MiB    EF02  BIOS boot partition
   2           67584        16844799   8.0 GiB     FD00  Linux RAID
   3        16844800      1875384319   886.2 GiB   FD00  Linux RAID
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Below part concerns RAIDs in particular. You need to adjust it to your use case.</p>

<p>As I said in my introduction, I’ll be utilizing a software RAID 1 for my operating system. We could either go ahead and rerun the same <code class="language-plaintext highlighter-rouge">gdisk</code> commands from above, or make
use of <code class="language-plaintext highlighter-rouge">sgdisk</code>, which is part of <code class="language-plaintext highlighter-rouge">gdisk</code>. <code class="language-plaintext highlighter-rouge">sgdisk</code> allows us to copy a partition table from one drive to another and also lets us randomize
the <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier"><code class="language-plaintext highlighter-rouge">GUIDs</code></a> of the partition table.</p>

<p>While for one additional disk this doesn’t make much of a difference in terms of work, it certainly is much easier for a whole bunch of disks.</p>

<p>Now, let’s continue with the procedure.</p>

<p>First, we need to copy the partition table to our additional disk using <code class="language-plaintext highlighter-rouge">sgdisk -R /dev/nvme1n1 /dev/nvme0n1</code>. <code class="language-plaintext highlighter-rouge">nvme0n1</code> is the disk we modified manually above,
and <code class="language-plaintext highlighter-rouge">nvme1n1</code> is the additional disk:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>sgdisk <span class="nt">-R</span> /dev/nvme1n1 /dev/nvme0n1
<span class="go">The operation has completed successfully.
</span></code></pre></div></div>

<p>This will leave us with the following two <strong>identical</strong> partition tables:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>gdisk <span class="nt">-l</span> /dev/nvme0n1
<span class="go">GPT fdisk (gdisk) version 1.0.9
[..]
Disk identifier (GUID): C26C13FA-CEF0-4FBC-AA0C-239E093CAAAA
[..]
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048           67583   32.0 MiB    EF02  BIOS boot partition
   2           67584        16777216   8.0 GiB     FD00  Linux RAID
   3        16779264      1875384319   886.3 GiB   FD00  Linux RAID
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>gdisk <span class="nt">-l</span> /dev/nvme1n1
<span class="go">GPT fdisk (gdisk) version 1.0.9
[..]
Disk identifier (GUID): C26C13FA-CEF0-4FBC-AA0C-239E093CAAAA
[..]
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048           67583   32.0 MiB    EF02  BIOS boot partition
   2           67584        16777216   8.0 GiB     FD00  Linux RAID
   3        16779264      1875384319   886.3 GiB   FD00  Linux RAID
</span></code></pre></div></div>

<p>I want you to pay close attention to the <code class="language-plaintext highlighter-rouge">Disk identifier (GUID)</code> column: They are <strong>the same</strong>.
What we now need to do, is to randomize the newly created partition table (in terms of its <code class="language-plaintext highlighter-rouge">GUID</code>) using <code class="language-plaintext highlighter-rouge">sgdisk -G /dev/nvme1n1</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>sgdisk <span class="nt">-G</span> /dev/nvme1n1
<span class="go">The operation has completed successfully.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>gdisk <span class="nt">-l</span> /dev/nvme1n1
<span class="go">GPT fdisk (gdisk) version 1.0.9
[..]
Disk identifier (GUID): BFE9B394-88A2-4A76-A123-1D65749AFFFF
[..]

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048           67583   32.0 MiB    EF02  BIOS boot partition
   2           67584        16777216   8.0 GiB     FD00  Linux RAID
   3        16779264      1875384319   886.3 GiB   FD00  Linux RAID
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>As you can see, now the <code class="language-plaintext highlighter-rouge">GUID</code> is different, perfect <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20"></p>
<h2 id="optional-creating-a-raid-1-using-mdadm">
  
  
    Optional: Creating a RAID 1 using <code class="language-plaintext highlighter-rouge">mdadm</code> <a href="#optional-creating-a-raid-1-using-mdadm">#</a>
  
  
</h2>
    

<p>Let’s move on to creating the RAID 1s with those NVMe disks.</p>

<p>Creating a RAID 1 is super easy with <code class="language-plaintext highlighter-rouge">mdadm</code>. We need four things for that:</p>

<ul>
  <li>A RAID label (common would be <code class="language-plaintext highlighter-rouge">md0</code> for the first array, <code class="language-plaintext highlighter-rouge">md1</code> for the second, etc.)</li>
  <li>The RAID level (e.g. 1, 5, 6, 60, etc.)</li>
  <li>The number of RAID devices (in our case 2)</li>
  <li>The RAID devices, which are the partitions we created earlier</li>
</ul>

<p>Here is the deal: We need two RAID 1 arrays. One, which will hold our <code class="language-plaintext highlighter-rouge">/boot</code> partition (which is the second partition we created on the NVMe devices) and the second one
will be holding all our encrypted data (which is the third partition on the NVMe devices).</p>

<p>The command to run would look something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mdadm --create /dev/md/&lt;LABEL&gt; --level=&lt;RAID_LEVEL&gt; --raid-devices=&lt;RAID_DEVICES_NUMBER&gt; &lt;PATH_TO_PARTITION_OF_RAID_DEVICE_1&gt; &lt;PATH_TO_PARTITION_OF_RAID_DEVICE_2&gt; &lt;PATH_TO_PARTITION_OF_RAID_DEVICE_n&gt; [--metadata=N]
</code></pre></div></div>

<p>In my case, it looks like this for the first RAID (<code class="language-plaintext highlighter-rouge">/boot</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/nvme0n1p2 /dev/nvme1n1p2 --metadata=0.90
</code></pre></div></div>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> The <code class="language-plaintext highlighter-rouge">--metadata=0.90</code> is necessary for an array to be <code class="language-plaintext highlighter-rouge">bootable</code> - at least to my knowledge.  I am not 100% certain that 0.90 is <em>still</em> required, but in
earlier days it was for sure. Feel free to try it out and let me know! <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

<p>Next, we’ll create the second RAID for our encrypted data:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/nvme0n1p3 /dev/nvme1n1p3 --metadata=1.2
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> This time we are passing <code class="language-plaintext highlighter-rouge">--metadata=1.2</code> as we do not need our array to be bootable. The older 0.9 metadata format has some limitations compared
to 1.2. You can read up on them on the <a href="https://linux.die.net/man/8/mdadm">manpage of <code class="language-plaintext highlighter-rouge">mdadm</code></a>.</p>

<p>Now we can check on the progress of the RAID re-synchronization via <code class="language-plaintext highlighter-rouge">/proc/mdstat</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">cat</span> /proc/mdstat
<span class="go">Personalities : [raid1]
md1 : active raid1 nvme1n1p3[1] nvme0n1p3[0]
      929170432 blocks super 1.2 [2/2] [UU]
</span><span class="gp">      [==&gt;</span>..................]  resync <span class="o">=</span> 11.1% <span class="o">(</span>103223424/929170432<span class="o">)</span> <span class="nv">finish</span><span class="o">=</span>66.8min <span class="nv">speed</span><span class="o">=</span>205925K/sec
<span class="go">      bitmap: 7/7 pages [28KB], 65536KB chunk

md0 : active raid1 nvme1n1p2[1] nvme0n1p2[0]
      8354752 blocks [2/2] [UU]

</span><span class="gp">unused devices: &lt;none&gt;</span><span class="w">
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>You can greatly speed up the RAID re-synchronization using the following parameters:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">sysctl -w dev.raid.speed_limit_min=&lt;NUMBER&gt;</code>, e.g. <code class="language-plaintext highlighter-rouge">sysctl -w dev.raid.speed_limit_min=500000</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">sysctl -w dev.raid.speed_limit_max=&lt;NUMBER&gt;</code>, e.g. <code class="language-plaintext highlighter-rouge">sysctl -w dev.raid.speed_limit_max=500000</code>
</li>
</ul>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> This will have a significant performance impact on your system!</p>

<p>With the above I could speed up my RAID re-synchronization a lot <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20">:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">cat</span> /proc/mdstat
<span class="go">Personalities : [raid1]
md1 : active raid1 nvme1n1p3[1] nvme0n1p3[0]
      929170432 blocks super 1.2 [2/2] [UU]
</span><span class="gp">      [=======&gt;</span>.............]  resync <span class="o">=</span> 36.0% <span class="o">(</span>334924032/929170432<span class="o">)</span> <span class="nv">finish</span><span class="o">=</span>6.6min <span class="nv">speed</span><span class="o">=</span>1498608K/sec
<span class="go">      bitmap: 5/7 pages [20KB], 65536KB chunk

md0 : active raid1 nvme1n1p2[1] nvme0n1p2[0]
      8354752 blocks [2/2] [UU]

</span><span class="gp">unused devices: &lt;none&gt;</span><span class="w">
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="optional-partition-another-drive-to-store-your-application-data-to-keep-it-separate-from-the-system-disk">
  
  
    Optional: Partition another drive to store your (application) data to keep it separate from the system disk <a href="#optional-partition-another-drive-to-store-your-application-data-to-keep-it-separate-from-the-system-disk">#</a>
  
  
</h2>
    

<p>I have a server that has a few HDDs, 10 namely. I am going to format each of those drives with only a single partition of type <code class="language-plaintext highlighter-rouge">fd00</code>. I only did the setup on one
HDD (<code class="language-plaintext highlighter-rouge">/dev/sda</code>) manually and copied the partition table to the other HDDs as described in the section above.</p>

<p>With the help of a little BASH, I could apply the same partition table to each of the HDDs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>d <span class="k">in</span> <span class="s2">"/dev/sd"</span><span class="k">*</span><span class="p">;</span> <span class="k">do</span>
  <span class="o">[[</span> <span class="o">!</span> <span class="s2">"</span><span class="k">${</span><span class="nv">d</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span>~ ^<span class="se">\/</span>dev<span class="se">\/</span>sda <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">d</span><span class="k">}</span><span class="s2">"</span>
  sgdisk <span class="nt">-R</span> <span class="s2">"</span><span class="k">${</span><span class="nv">d</span><span class="k">}</span><span class="s2">"</span> /dev/sda <span class="o">&amp;&amp;</span> sgdisk <span class="nt">-G</span> <span class="s2">"</span><span class="k">${</span><span class="nv">d</span><span class="k">}</span><span class="s2">"</span>
<span class="k">done</span>
</code></pre></div></div>
<h2 id="formatting-partitions-and-setting-up-the-encrypted-lvm">
  
  
    Formatting partitions and setting up the encrypted <code class="language-plaintext highlighter-rouge">LVM</code> <a href="#formatting-partitions-and-setting-up-the-encrypted-lvm">#</a>
  
  
</h2>
    

<p>The goal of this section is to end up with a partition layout using the <a href="https://en.wikipedia.org/wiki/Logical_volume_management">Logical Volume Manager</a> (<code class="language-plaintext highlighter-rouge">LVM</code>).
In order to achieve this we are going to create an encrypted <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">Linux Unified Key Setup</a> (<code class="language-plaintext highlighter-rouge">LUKS</code>) partition on which we
will create our <code class="language-plaintext highlighter-rouge">LVM</code>.
The partition table should look ideally similar to the one in the table below. As I am currently setting up a server to use
with <a href="https://www.proxmox.com">Proxmox</a> the sizing might be different from your choice.</p>

<p>I inserted an additional column where I set an <strong>X</strong> whether the partition is recommended to create on any system or whether the partition is specific for the usage
with Proxmox.
In my case the disk, where my system is going to get installed on (<code class="language-plaintext highlighter-rouge">/dev/md2</code>) is roughly 890GB big. So it is easily possible at any time to extend the current
partition layout or even extend the size of the different point mounts - thanks to <code class="language-plaintext highlighter-rouge">LVM</code>!</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">mount point</th>
      <th style="text-align: center">filesystem type</th>
      <th style="text-align: center">size</th>
      <th style="text-align: center">recommended</th>
      <th style="text-align: center">volume group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">16 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/home</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">4 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/tmp</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">4 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">32 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/tmp</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">4 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/log</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">8 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/log/audit</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">2 GB</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">swap</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">swap</code></td>
      <td style="text-align: center">16 GB</td>
      <td style="text-align: center">X</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_system</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/lib/vz</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">XFS</code></td>
      <td style="text-align: center">5 TB</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">vg_data</code></td>
    </tr>
  </tbody>
</table>
<h2 id="formatting-boot">
  
  
    Formatting /boot <a href="#formatting-boot">#</a>
  
  
</h2>
    

<p>After creating the partitions on the system disk (<code class="language-plaintext highlighter-rouge">/dev/md0</code>) earlier, we are going to format the partition (which we will use as <code class="language-plaintext highlighter-rouge">/boot</code>) using <code class="language-plaintext highlighter-rouge">XFS</code> as filesystem. For
that we’ll use <code class="language-plaintext highlighter-rouge">mkfs.xfs /dev/md0</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>mkfs.xfs /dev/md0
<span class="go">meta-data=/dev/md0               isize=512    agcount=8, agsize=261088 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=2088688, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Discarding blocks...Done.
</span></code></pre></div></div>
<h2 id="creating-a-luks-partition-to-hold-our-system-partitions">
  
  
    Creating a <code class="language-plaintext highlighter-rouge">LUKS</code> partition to hold our system partitions <a href="#creating-a-luks-partition-to-hold-our-system-partitions">#</a>
  
  
</h2>
    

<p>Next, we want to have all remaining partitions (e.g. <code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">/home</code>, <code class="language-plaintext highlighter-rouge">/tmp</code>, etc.) within an encrypted <code class="language-plaintext highlighter-rouge">LUKS</code> partition. For that we have created the second RAID <code class="language-plaintext highlighter-rouge">md1</code>.</p>

<p>In order to encrypt the partition, following command is executed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cryptsetup -s 512 -c aes-xts-plain64 luksFormat /dev/md1
</code></pre></div></div>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> First, you need to confirm, that <strong>all data on this partition will be lost</strong>.
After you confirmed it, you will be prompted to enter a password for the encryption (please use a <strong>complex</strong> and <strong>unique</strong> password!) and repeat the password.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> Make sure to save the password in your password safe (or remember it <img class="emoji" title=":open_mouth:" alt=":open_mouth:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png" height="20" width="20"> ), otherwise you will not be able to access the system ever again - all data
will be lost. <strong>There is no way to recover them</strong>.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup <span class="nt">-s</span> 512 <span class="nt">-c</span> aes-xts-plain64 luksFormat /dev/md1
<span class="go">
WARNING!
========
This will overwrite data on /dev/md1 irrevocably.

Are you sure? (Type 'yes' in capital letters): YES
Enter passphrase for /dev/md1:
Verify passphrase:
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>Quickly verify, whether the encrypted <code class="language-plaintext highlighter-rouge">LUKS</code> partition is setup properly using the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cryptsetup luksOpen /dev/md1 crypted_system
</code></pre></div></div>

<p>The system will ask you for the password to decrypt the <code class="language-plaintext highlighter-rouge">LUKS</code> partition. After you entered the correct password, you will be able to see a new
device: <code class="language-plaintext highlighter-rouge">/dev/mapper/crypted_system</code></p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksOpen /dev/md1 crypted_system
<span class="go">Enter passphrase for /dev/md1:
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /dev/mapper/
<span class="go">total 0
drwxr-xr-x  2 root root      80 Aug 28 21:23 .
drwxr-xr-x 15 root root    8.3K Aug 28 21:23 ..
crw-------  1 root root 10, 236 Aug 28 15:06 control
</span><span class="gp">lrwxrwxrwx  1 root root       7 Aug 28 21:23 crypted_system -&gt;</span><span class="w"> </span>../dm-0
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h3 id="optional-creating-luks-partition-for-the-data-partition">
  
  
    Optional: Creating <code class="language-plaintext highlighter-rouge">LUKS</code> partition for the data partition <a href="#optional-creating-luks-partition-for-the-data-partition">#</a>
  
  
</h3>
    

<p>Basically, the same steps as we used for the <code class="language-plaintext highlighter-rouge">LUKS</code> partition that holds our system partitions have to be applied for the data partitions.
The differences are only a few simple things:</p>

<ul>
  <li>The device is now <code class="language-plaintext highlighter-rouge">/dev/md2</code>
</li>
  <li>We will encrypt the device as a whole and not creating partitions before hand - simply because we don’t need to.</li>
  <li>With <code class="language-plaintext highlighter-rouge">cryptsetup luksOpen</code> we need to specify a different name for the device, which holds the decrypted data: <code class="language-plaintext highlighter-rouge">crypted_data</code>
</li>
  <li>
<strong>Ideally</strong> you want to use a different password as for the system <code class="language-plaintext highlighter-rouge">LUKS</code> partition. We will later replace the password with a key file on the encrypted root file
system in order to make the unlocking of the system during the boot easier</li>
</ul>
<h2 id="setting-up-lvm-creating-a-physical-volume-a-volume-group-and-several-logical-volumes-for-the-encrypted-luks-partition">
  
  
    Setting up <code class="language-plaintext highlighter-rouge">LVM</code>: Creating a physical volume, a volume group and several logical volumes for the encrypted <code class="language-plaintext highlighter-rouge">LUKS</code> partition <a href="#setting-up-lvm-creating-a-physical-volume-a-volume-group-and-several-logical-volumes-for-the-encrypted-luks-partition">#</a>
  
  
</h2>
    

<p>In order to implement and use <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html-single/configuring_and_managing_logical_volumes/index#lvm-architecture_overview-of-logical-volume-management"><code class="language-plaintext highlighter-rouge">LVM</code></a>
we need to follow the following approach:</p>

<ol>
  <li>Create a physical volume (<code class="language-plaintext highlighter-rouge">PV</code>) using <code class="language-plaintext highlighter-rouge">pvcreate</code> on top of the decrypted <code class="language-plaintext highlighter-rouge">LUKS</code> partition</li>
  <li>Create a volume group (<code class="language-plaintext highlighter-rouge">VG</code>) using <code class="language-plaintext highlighter-rouge">vgcreate</code> on top of the physical volume</li>
  <li>Create several logical volumes (<code class="language-plaintext highlighter-rouge">LV</code>) using <code class="language-plaintext highlighter-rouge">lvcreate</code> on top of the volume group</li>
</ol>
<h2 id="creating-a-physical-volume-on-top-of-the-luks-partition">
  
  
    Creating a physical volume on top of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition <a href="#creating-a-physical-volume-on-top-of-the-luks-partition">#</a>
  
  
</h2>
    

<p>The first step is to create a physical volume on top of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition. This is very simple and does not need any further explanation.</p>

<p>Following command is used to create the physical volume:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pvcreate /dev/mapper/crypted_system
</code></pre></div></div>

<p>The output will look similar to the following:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>pvcreate /dev/mapper/crypted_system
<span class="go">  Physical volume "/dev/mapper/crypted_system" successfully created.
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="creating-a-volume-group-on-top-of-the-physical-volume">
  
  
    Creating a volume group on top of the physical volume <a href="#creating-a-volume-group-on-top-of-the-physical-volume">#</a>
  
  
</h2>
    

<p>The second step is to create a volume group on top of the just created physical volume. In this case we are going to use <code class="language-plaintext highlighter-rouge">vg_system</code> as the name of the volume group.
Following command is used to create a volume group:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vgcreate vg_system /dev/mapper/crypted_system
</code></pre></div></div>

<p>The output will look similar to the following:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>vgcreate vg_system /dev/mapper/crypted_system
<span class="go">  Volume group "vg_system" successfully created
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="creating-logical-volumes-on-top-of-the-volume-group">
  
  
    Creating logical volumes on top of the volume group <a href="#creating-logical-volumes-on-top-of-the-volume-group">#</a>
  
  
</h2>
    

<p>The last step is to create logical volumes on top of the just created volume group. Following command is used to create a logical volume:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lvcreate -L &lt;size&gt; -n &lt;name&gt; &lt;volume_group_name&gt;
</code></pre></div></div>

<p>For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lvcreate -L 16G -n root vg_system
</code></pre></div></div>

<p>In the above example a logical volume with the size of <strong>16 GB</strong> and the name <strong>root</strong> in the volume group <strong>vg_system</strong> is created.</p>

<p>This command can be used to create all logical volumes accordingly. Best practice - regarding the naming - is to use the name of the mount
point (e.g. <code class="language-plaintext highlighter-rouge">/</code> = <code class="language-plaintext highlighter-rouge">root</code>, <code class="language-plaintext highlighter-rouge">/tmp</code> = <code class="language-plaintext highlighter-rouge">tmp</code>, etc.).</p>

<p>If the mount point contains slashes, replace them via underscore (e.g. <code class="language-plaintext highlighter-rouge">/var/log</code> = <code class="language-plaintext highlighter-rouge">var_log</code>, <code class="language-plaintext highlighter-rouge">/var/tmp</code> = <code class="language-plaintext highlighter-rouge">var_tmp</code>, <code class="language-plaintext highlighter-rouge">/var/log/audit</code> = <code class="language-plaintext highlighter-rouge">var_log_audit</code>, etc.).
This is the best practice approach, which I have implemented on many servers/infrastructures.</p>

<p>The output will look similar to the following:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 16G <span class="nt">-n</span> root vg_system
<span class="go">  Logical volume "root" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 4G <span class="nt">-n</span> home vg_system
<span class="go">  Logical volume "home" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 4G <span class="nt">-n</span> tmp vg_system
<span class="go">  Logical volume "tmp" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 32G <span class="nt">-n</span> var vg_system
<span class="go">  Logical volume "var" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 4G <span class="nt">-n</span> var_tmp vg_system
<span class="go">  Logical volume "var_tmp" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 8G <span class="nt">-n</span> var_log vg_system
<span class="go">  Logical volume "var_log" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 2G <span class="nt">-n</span> var_log_audit vg_system
<span class="go">  Logical volume "var_log_audit" created.
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 16G <span class="nt">-n</span> swap vg_system
<span class="go">  Logical volume "swap" created.
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>And will leave us with following logical volumes:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvs
<span class="go">  LV            VG        Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  home          vg_system -wi-a-----  4.00g
  root          vg_system -wi-a----- 16.00g
  swap          vg_system -wi-a----- 16.00g
  tmp           vg_system -wi-a-----  4.00g
  var           vg_system -wi-a----- 32.00g
  var_log       vg_system -wi-a-----  8.00g
  var_log_audit vg_system -wi-a-----  2.00g
  var_tmp       vg_system -wi-a-----  4.00g
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>.. and plenty of space left in the volume group:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>vgs
<span class="gp">  VG        #</span>PV <span class="c">#LV #SN Attr   VSize    VFree</span>
<span class="go">  vg_system   1   8   0 wz--n- &lt;886.11g &lt;800.11g
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h3 id="optional-create-lvm-for-the-data-disk">
  
  
    Optional: Create <code class="language-plaintext highlighter-rouge">LVM</code> for the data disk <a href="#optional-create-lvm-for-the-data-disk">#</a>
  
  
</h3>
    

<p>As for the system partition, the same approach needs to be done for the data disk. As I briefly explained the exact approach and implementation above, here just the command
output:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>pvcreate /dev/mapper/crypted_data
<span class="go">  Physical volume "/dev/mapper/crypted_data" successfully created
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>vgcreate vg_data /dev/mapper/crypted_data
<span class="go">  Volume group "vg_data" successfully created
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvcreate <span class="nt">-L</span> 5T <span class="nt">-n</span> var_lib_vz vg_data
<span class="go">  Logical volume "var_lib_vz" created
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="create-filesystems-on-logical-volumes">
  
  
    Create filesystems on logical volumes <a href="#create-filesystems-on-logical-volumes">#</a>
  
  
</h2>
    

<p>In order to use the logical volumes, we need to create file systems on them. To ease this process - and save me some manual work - I wrote a little BASH script.
The purpose of this script is to create <code class="language-plaintext highlighter-rouge">XFS</code> filesystems on all logical volumes on all volume groups specified and create a swap “filesystem” on the logical volume,
which is named <code class="language-plaintext highlighter-rouge">&lt;vg&gt;-swap</code>. Ff you have multiple swaps or a different naming, you can easily modify this script.
I added a semicolon after each command, so one can simply copy/paste the whole script into the terminal.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># define the filesystem to use here</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">filesystem_type</span><span class="o">=</span><span class="s2">"xfs"</span>
<span class="c"># define your volume groups here</span>
<span class="k">for </span>vg <span class="k">in </span>vg_system vg_data<span class="p">;</span> <span class="k">do</span>
  <span class="c"># iterate over all LVs</span>
  <span class="k">for </span>lv <span class="k">in</span> <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">vg</span><span class="k">}</span><span class="s2">-"</span><span class="k">*</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span>~ ^<span class="k">${</span><span class="nv">vg</span><span class="k">}</span><span class="nt">-swap</span><span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="c"># create a swap</span>
      mkswap <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="c"># create filesystem</span>
      mkfs.<span class="s2">"</span><span class="k">${</span><span class="nv">filesystem_type</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">fi</span><span class="p">;</span>
  <span class="k">done</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div></div>

<!-- markdownlint-disable MD022 MD023 MD025 MD033 -->
<details>
<summary>Following a sample output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="c">#!/bin/bash</span>
<span class="gp">#</span><span class="w"> </span>define the filesystem to use here
<span class="go">declare -r filesystem_type="xfs"
</span><span class="gp">#</span><span class="w"> </span>define your volume <span class="nb">groups </span>here
<span class="gp">for vg in vg_system vg_data;</span><span class="w"> </span><span class="k">do</span>
<span class="gp">  #</span><span class="w"> </span>iterate over all LVs
<span class="gp">  for lv in "/dev/mapper/$</span><span class="o">{</span>vg<span class="o">}</span>-<span class="s2">"*; do
</span><span class="gp">    if [[ "$</span><span class="s2">(basename "</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">")"</span> <span class="o">=</span>~ ^<span class="k">${</span><span class="nv">vg</span><span class="k">}</span><span class="nt">-swap</span><span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="gp">      #</span><span class="w"> </span>create a swap
<span class="gp">      mkswap "$</span><span class="o">{</span>lv<span class="o">}</span><span class="s2">";
</span><span class="go">    else
</span><span class="gp">      #</span><span class="w"> </span>create filesystem
<span class="gp">      mkfs."$</span><span class="o">{</span>filesystem_type<span class="o">}</span><span class="s2">" -f "</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">";
</span><span class="gp">    fi;</span><span class="w">
</span><span class="gp">  done;</span><span class="w">
</span><span class="go">done
meta-data=/dev/mapper/vg_system-home isize=512    agcount=8, agsize=131072 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_system-root isize=512    agcount=16, agsize=262144 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=4194304, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Setting up swapspace version 1, size = 16 GiB (17179865088 bytes)
no label, UUID=edf2db0c-5d7f-4a84-9af3-4f842316fb68
meta-data=/dev/mapper/vg_system-tmp isize=512    agcount=8, agsize=131072 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_system-var isize=512    agcount=16, agsize=524288 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=8388608, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_system-var_log isize=512    agcount=8, agsize=262144 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=2097152, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_system-var_log_audit isize=512    agcount=8, agsize=65536 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=524288, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_system-var_tmp isize=512    agcount=8, agsize=131072 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=32     swidth=32 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
meta-data=/dev/mapper/vg_data-var_lib_vz isize=512    agcount=33, agsize=41942912 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=1342177280, imaxpct=5
         =                       sunit=128    swidth=1024 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=521728, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</span><span class="gp">root@rescue ~ #</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD022 MD023 MD025 MD033 -->

<p>Note: If you have volume groups defined in the script, which are non-existent, you will retrieve some error messages, like the following (obviously <code class="language-plaintext highlighter-rouge">vg_data</code> did not exist):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Error accessing specified device /dev/mapper/vg_data-*: No such file or directory
Usage: mkfs.xfs
/* blocksize */         [-b size=num]
/* metadata */          [-m crc=0|1,finobt=0|1,uuid=xxx,rmapbt=0|1,reflink=0|1]
/* data subvol */       [-d agcount=n,agsize=n,file,name=xxx,size=num,
                            (sunit=value,swidth=value|su=num,sw=num|noalign),
                            sectsize=num
/* force overwrite */   [-f]
/* inode size */        [-i log=n|perblock=n|size=num,maxpct=n,attr=0|1|2,
                            projid32bit=0|1,sparse=0|1]
/* no discard */        [-K]
/* log subvol */        [-l agnum=n,internal,size=num,logdev=xxx,version=n
                            sunit=value|su=num,sectsize=num,lazy-count=0|1]
/* label */             [-L label (maximum 12 characters)]
/* naming */            [-n size=num,version=2|ci,ftype=0|1]
/* no-op info only */   [-N]
/* prototype file */    [-p fname]
/* quiet */             [-q]
/* realtime subvol */   [-r extsize=num,size=num,rtdev=xxx]
/* sectorsize */        [-s size=num]
/* version */           [-V]
                        devicename
</span><span class="gp">&lt;devicename&gt;</span><span class="w"> </span>is required unless <span class="nt">-d</span> <span class="nv">name</span><span class="o">=</span>xxx is given.
<span class="gp">&lt;num&gt;</span><span class="w"> </span>is xxx <span class="o">(</span>bytes<span class="o">)</span>, xxxs <span class="o">(</span>sectors<span class="o">)</span>, xxxb <span class="o">(</span>fs blocks<span class="o">)</span>, xxxk <span class="o">(</span>xxx KiB<span class="o">)</span>,
<span class="go">      xxxm (xxx MiB), xxxg (xxx GiB), xxxt (xxx TiB) or xxxp (xxx PiB).
</span><span class="gp">&lt;value&gt;</span><span class="w"> </span>is xxx <span class="o">(</span>512 byte blocks<span class="o">)</span><span class="nb">.</span>
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="prepare-for-the-installation">
  
  
    Prepare for the installation <a href="#prepare-for-the-installation">#</a>
  
  
</h2>
    

<p>After we created our filesystems, we need to prepare the system for the manual installation.</p>
<h3 id="mounting-the-partitions">
  
  
    Mounting the partitions <a href="#mounting-the-partitions">#</a>
  
  
</h3>
    

<p>In order to install our system within our live system, we need to mount the just created partitions under <code class="language-plaintext highlighter-rouge">/mnt</code>.
To easy this process again - and save me some manual work again - I created a script for this purpose.
To be able to use this script, we need to “close”, both the volume group <code class="language-plaintext highlighter-rouge">vg_system</code> and - if you created - the volume group <code class="language-plaintext highlighter-rouge">vg_data</code> and afterwards close the <code class="language-plaintext highlighter-rouge">LUKS</code> partition.
This can be done using the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># "close" the volume groups
lvchange -a n vg_system
lvchange -a n vg_data

# close the LUKS partitions
cryptsetup luksClose /dev/mapper/crypted_system
cryptsetup luksClose /dev/mapper/crypted_data
</code></pre></div></div>

<p>The output (or well, no output) will look similar to this (depending on - as already mentioned - whether you have chosen to create <code class="language-plaintext highlighter-rouge">vg_data</code> or not):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvchange <span class="nt">-a</span> n vg_system
<span class="gp">root@rescue ~ #</span><span class="w"> </span>lvchange <span class="nt">-a</span> n vg_data
<span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksClose /dev/mapper/crypted_system
<span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksClose /dev/mapper/crypted_data
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>You can verify, whether we “closed” the volume group and the <code class="language-plaintext highlighter-rouge">LUKS</code> partition with the following commands:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /dev/mapper/
<span class="go">total 0
drwxr-xr-x  2 root root      60 Aug 28 21:38 .
drwxr-xr-x 15 root root    8.2K Aug 28 21:38 ..
crw-------  1 root root 10, 236 Aug 28 15:06 control
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>To explain the general approach a bit, this is what the following script is doing:</p>

<ul>
  <li>Unlock both the system and data <code class="language-plaintext highlighter-rouge">LUKS</code> partition (if defined) - will ask for a password obviously <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20">
</li>
  <li>In order to install a system within a live system, we need to mount the root <code class="language-plaintext highlighter-rouge">LV</code> somewhere - in our case it’s <code class="language-plaintext highlighter-rouge">/mnt</code>
</li>
  <li>To be able to mount the <code class="language-plaintext highlighter-rouge">LVs</code> we need to create the necessary directories beforehand (e.g. <code class="language-plaintext highlighter-rouge">/mnt/var</code>, <code class="language-plaintext highlighter-rouge">/mnt/var/log</code>, <code class="language-plaintext highlighter-rouge">/mnt/home</code>, etc.)</li>
  <li>Finally the <code class="language-plaintext highlighter-rouge">LVs</code> get mounted to those created directories</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># name of the volume group for the system</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__VG_SYSTEM</span><span class="o">=</span><span class="s2">"vg_system"</span>
<span class="c"># name of the volume group for the data partition - leave empty if you don't have it</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__VG_DATA</span><span class="o">=</span><span class="s2">"vg_data"</span>
<span class="c"># mount point where the chroot environment will be mounted</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__DESTINATION_PARENT</span><span class="o">=</span><span class="s2">"/mnt"</span>
<span class="c"># name of the logical volume, which contains the root ( / ) partition</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__ROOT_LV_NAME</span><span class="o">=</span><span class="s2">"root"</span>
<span class="c"># device where the /boot partition is stored on</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__BOOT_DEVICE</span><span class="o">=</span><span class="s2">"/dev/md0"</span>
<span class="c"># device where the system LUKS partition is stored on</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__SYSTEM_CRYPT_DEVICE</span><span class="o">=</span><span class="s2">"/dev/md1"</span>
<span class="c"># name of the LUKS partition after unlocking it (/dev/mapper/&lt;NAME&gt;)</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__SYSTEM_CRYPT_NAME</span><span class="o">=</span><span class="s2">"crypted_system"</span>
<span class="c"># device where the data LUKS partition is stored on - leave empty if you don't have it</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__DATA_CRYPT_DEVICE</span><span class="o">=</span><span class="s2">"/dev/md2"</span>
<span class="c"># name of the LUKS partition after unlocking it (/dev/mapper/&lt;NAME&gt;) - leave empty if you don't have it</span>
<span class="nb">declare</span> <span class="nt">-r</span> <span class="nv">__DATA_CRYPT_NAME</span><span class="o">=</span><span class="s2">"crypted_data"</span>

<span class="c"># function to mount all partitions</span>
<span class="c"># if the script was called with a second parameter also all</span>
<span class="c"># necessary system partitions (/dev /dev/pts etc) are mounted as well</span>
<span class="k">function </span>mount_chroot <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"Trying to decrypt system crypt device '</span><span class="k">${</span><span class="nv">__SYSTEM_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">'"</span>
  cryptsetup luksOpen <span class="s2">"</span><span class="k">${</span><span class="nv">__SYSTEM_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__SYSTEM_CRYPT_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Decrypting '</span><span class="k">${</span><span class="nv">__SYSTEM_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">' failed!"</span><span class="p">;</span>
    <span class="nb">exit </span>1<span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">"Successful!"</span>

  <span class="o">(</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DATA_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span>
    <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DATA_CRYPT_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span>
  <span class="o">)</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Trying to decrypt data crypt device '</span><span class="k">${</span><span class="nv">__DATA_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">'"</span>
    cryptsetup luksOpen <span class="s2">"</span><span class="k">${</span><span class="nv">__DATA_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DATA_CRYPT_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span>
      <span class="nb">echo</span> <span class="s2">"Decrypting '</span><span class="k">${</span><span class="nv">__DATA_CRYPT_DEVICE</span><span class="k">}</span><span class="s2">' failed!"</span><span class="p">;</span>
      <span class="nb">exit </span>1<span class="p">;</span>
    <span class="o">}</span><span class="p">;</span>
    <span class="nb">echo</span> <span class="s2">"Successful!"</span>
  <span class="o">}</span><span class="p">;</span>

  <span class="c"># sleep to prevent that the VGs cant be detected yet</span>
  <span class="nb">sleep </span>2
  <span class="c"># detect vgs and switch to them</span>
  vgchange <span class="nt">-aay</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Searching and activating volume groups failed!"</span><span class="p">;</span>
    <span class="nb">exit </span>1<span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>

  <span class="c"># check whether the given root lv exist</span>
  <span class="o">[[</span> <span class="nt">-e</span> <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">__ROOT_LV_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"root LV '/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">__ROOT_LV_NAME</span><span class="k">}</span><span class="s2">' does not exist!"</span><span class="p">;</span>
    <span class="nb">exit </span>1<span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>

  <span class="c"># mount the root lv and check whether it has been mounted successfully</span>
  mount <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">__ROOT_LV_NAME</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">"</span>
  mountpoint <span class="nt">-q</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">"</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Destination root '</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">' is not mounted!"</span>
    <span class="nb">exit </span>1<span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>

  <span class="o">(</span> <span class="o">[[</span> <span class="nt">-e</span> <span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span>/boot <span class="o">]]</span> <span class="o">&amp;&amp;</span>
    <span class="o">[[</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span>/boot <span class="o">]]</span>
  <span class="o">)</span> <span class="o">||</span> <span class="o">{</span>
  <span class="c"># create /boot within __DESTINATION_PARENT if it does not exist</span>
    <span class="nb">mkdir</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/boot"</span>
  <span class="o">}</span><span class="p">;</span>
  <span class="c"># try mounting /boot</span>
  mount <span class="s2">"</span><span class="k">${</span><span class="nv">__BOOT_DEVICE</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/boot"</span>

  <span class="c"># go through all system LVs and mount them, unless its the root or swap partition</span>
  <span class="k">for </span>lv <span class="k">in</span> <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">-"</span><span class="k">*</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">declare </span><span class="nv">part</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/vg_.*-//'</span> <span class="nt">-e</span> <span class="s1">'s/_/\//g'</span><span class="si">)</span><span class="s2">"</span>
    <span class="k">case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="k">in
      </span>root<span class="p">)</span>
        <span class="c"># we mounted it already</span>
        <span class="k">continue</span>
      <span class="p">;;</span>
      swap<span class="p">)</span>
        <span class="c"># set swap to the current LV</span>
        swapon <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span>
      <span class="p">;;</span>
      <span class="k">*</span><span class="p">)</span>
        <span class="c"># create the necessary folders for the current LV</span>
        <span class="c"># if they don't exist yet</span>
        <span class="o">(</span> <span class="o">[[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span>
          <span class="o">[[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span>
        <span class="o">)</span> <span class="o">||</span> <span class="o">{</span>
          <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="c"># try mounting the LV</span>
        mount <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span>
      <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">done</span>

  <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__VG_DATA</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Data partition defined :3"</span>
    <span class="c"># do the same as for the system LVs for the data LVs</span>
    <span class="k">for </span>lv <span class="k">in</span> <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_DATA</span><span class="k">}</span><span class="s2">-"</span><span class="k">*</span><span class="p">;</span> <span class="k">do
      </span><span class="nb">declare </span><span class="nv">part</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/vg_.*-//'</span> <span class="nt">-e</span> <span class="s1">'s/_/\//g'</span><span class="si">)</span><span class="s2">"</span>
      <span class="o">(</span> <span class="o">[[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span>
        <span class="o">[[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span>
      <span class="o">)</span> <span class="o">||</span> <span class="o">{</span>
        <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span>
      <span class="o">}</span><span class="p">;</span>
      mount <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span>
    <span class="k">done</span>
  <span class="o">}</span><span class="p">;</span>


  <span class="o">[[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">2</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">exit </span>0<span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>

  <span class="nb">echo</span> <span class="s2">"Mounting necessary system partitions to chroot"</span>
  mount <span class="nt">-o</span> <span class="nb">bind</span> /dev <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/dev"</span>
  mount <span class="nt">-o</span> <span class="nb">bind</span> /run <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/run"</span>
  mount <span class="nt">-t</span> devpts devpts <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/dev/pts"</span>
  mount <span class="nt">-t</span> sysfs sys <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/sys"</span>
  mount <span class="nt">-t</span> proc proc <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">/proc"</span>
  <span class="nb">exit </span>0<span class="p">;</span>
<span class="o">}</span> <span class="c">#; function mount_chroot ( )</span>

<span class="c"># function to unmount all partitions defined under __DESTINATION_PARENT</span>
<span class="c"># and "close" the VGs and finally close the LUKS partitions</span>
<span class="k">function </span>umount_chroot <span class="o">()</span> <span class="o">{</span>
  umount <span class="nt">-lf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__DESTINATION_PARENT</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">for </span>lv <span class="k">in</span> <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">-"</span><span class="k">*</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">declare </span><span class="nv">part</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/vg_.*-//'</span> <span class="nt">-e</span> <span class="s1">'s/_/\//g'</span><span class="si">)</span><span class="s2">"</span>
    <span class="k">case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">part</span><span class="k">}</span><span class="s2">"</span> <span class="k">in
      </span>swap<span class="p">)</span>
        swapoff <span class="s2">"</span><span class="k">${</span><span class="nv">lv</span><span class="k">}</span><span class="s2">"</span>
      <span class="p">;;</span>
      <span class="k">*</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">done
  </span>lvchange <span class="nt">-a</span> n <span class="s2">"</span><span class="k">${</span><span class="nv">__VG_SYSTEM</span><span class="k">}</span><span class="s2">"</span>

  <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">__VG_DATA</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span>
    lvchange <span class="nt">-a</span> n <span class="s2">"</span><span class="k">${</span><span class="nv">__VG_DATA</span><span class="k">}</span><span class="s2">"</span>
    cryptsetup luksClose <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__DATA_CRYPT_NAME</span><span class="k">}</span><span class="s2">"</span>
  <span class="o">}</span><span class="p">;</span>

  cryptsetup luksClose <span class="s2">"/dev/mapper/</span><span class="k">${</span><span class="nv">__SYSTEM_CRYPT_NAME</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span> <span class="c">#; function umount_chroot ( )</span>

<span class="k">case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span> <span class="k">in
  </span>mount<span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Mounting chroot"</span>
    mount_chroot <span class="s2">"</span><span class="k">${</span><span class="p">@</span><span class="k">}</span><span class="s2">"</span>
  <span class="p">;;</span>
  umount<span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Unmounting chroot"</span>
    umount_chroot <span class="s2">"</span><span class="k">${</span><span class="p">@</span><span class="k">}</span><span class="s2">"</span>
  <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Use either mount or umount as parameters. Additionally a second parameter with any value can be passed to mount system partitions as well (/dev /dev/pts etc)"</span>
  <span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div></div>

<p>To be able to copy the script right into the command line, you can use the following approach:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt;-'#EOF' &gt; mount.sh
#!/bin/bash
# name of the volume group for the system
declare -r __VG_SYSTEM="vg_system"
# name of the volume group for the data partition - leave empty if you don't have it
declare -r __VG_DATA="vg_data"
# mount point where the chroot environment will be mounted
declare -r __DESTINATION_PARENT="/mnt"
# name of the logical volume, which contains the root ( / ) partition
declare -r __ROOT_LV_NAME="root"
# device where the /boot partition is stored on
declare -r __BOOT_DEVICE="/dev/md0"
# device where the system LUKS partition is stored on
declare -r __SYSTEM_CRYPT_DEVICE="/dev/md1"
# name of the LUKS partition after unlocking it (/dev/mapper/&lt;NAME&gt;)
declare -r __SYSTEM_CRYPT_NAME="crypted_system"
# device where the data LUKS partition is stored on - leave empty if you don't have it
declare -r __DATA_CRYPT_DEVICE="/dev/md2"
# name of the LUKS partition after unlocking it (/dev/mapper/&lt;NAME&gt;) - leave empty if you don't have it
declare -r __DATA_CRYPT_NAME="crypted_data"

# function to mount all partitions
# if the script was called with a second parameter also all
# necessary system partitions (/dev /dev/pts etc) are mounted as well
function mount_chroot () {
  echo "Trying to decrypt system crypt device '${__SYSTEM_CRYPT_DEVICE}'"
  cryptsetup luksOpen "${__SYSTEM_CRYPT_DEVICE}" "${__SYSTEM_CRYPT_NAME}" || {
    echo "Decrypting '${__SYSTEM_CRYPT_DEVICE}' failed!";
    exit 1;
  };
  echo "Successful!"

  ( [[ -z "${__DATA_CRYPT_DEVICE}" ]] &amp;&amp;
    [[ -z "${__DATA_CRYPT_NAME}" ]]
  ) || {
    echo "Trying to decrypt data crypt device '${__DATA_CRYPT_DEVICE}'"
    cryptsetup luksOpen "${__DATA_CRYPT_DEVICE}" "${__DATA_CRYPT_NAME}" || {
      echo "Decrypting '${__DATA_CRYPT_DEVICE}' failed!";
      exit 1;
    };
    echo "Successful!"
  };

  # sleep to prevent that the VGs cant be detected yet
  sleep 2
  # detect vgs and switch to them
  vgchange -aay || {
    echo "Searching and activating volume groups failed!";
    exit 1;
  };

  # check whether the given root lv exist
  [[ -e "/dev/mapper/${__VG_SYSTEM}-${__ROOT_LV_NAME}" ]] || {
    echo "root LV '/dev/mapper/${__VG_SYSTEM}-${__ROOT_LV_NAME}' does not exist!";
    exit 1;
  };

  # mount the root lv and check whether it has been mounted successfully
  mount "/dev/mapper/${__VG_SYSTEM}-${__ROOT_LV_NAME}" "${__DESTINATION_PARENT}"
  mountpoint -q "${__DESTINATION_PARENT}" || {
    echo "Destination root '${__DESTINATION_PARENT}' is not mounted!"
    exit 1;
  };

  ( [[ -e ${__DESTINATION_PARENT}/boot ]] &amp;&amp;
    [[ -d ${__DESTINATION_PARENT}/boot ]]
  ) || {
  # create /boot within __DESTINATION_PARENT if it does not exist
    mkdir "${__DESTINATION_PARENT}/boot"
  };
  # try mounting /boot
  mount "${__BOOT_DEVICE}" "${__DESTINATION_PARENT}/boot"

  # go through all system LVs and mount them, unless its the root or swap partition
  for lv in "/dev/mapper/${__VG_SYSTEM}-"*; do
    declare part="$(echo "$(basename "${lv}")" | sed -e 's/vg_.*-//' -e 's/_/\//g')"
    case "${part}" in
      root)
        # we mounted it already
        continue
      ;;
      swap)
        # set swap to the current LV
        swapon "${lv}"
      ;;
      *)
        # create the necessary folders for the current LV
        # if they don't exist yet
        ( [[ -e "${__DESTINATION_PARENT}/${part}" ]] &amp;&amp;
          [[ -d "${__DESTINATION_PARENT}/${part}" ]]
        ) || {
          mkdir -p "${__DESTINATION_PARENT}/${part}"
        };
        # try mounting the LV
        mount "${lv}" "${__DESTINATION_PARENT}/${part}"
      ;;
    esac
  done

  [[ -z "${__VG_DATA}" ]] || {
    echo "Data partition defined :3"
    # do the same as for the system LVs for the data LVs
    for lv in "/dev/mapper/${__VG_DATA}-"*; do
      declare part="$(echo "$(basename "${lv}")" | sed -e 's/vg_.*-//' -e 's/_/\//g')"
      ( [[ -e "${__DESTINATION_PARENT}/${part}" ]] &amp;&amp;
        [[ -e "${__DESTINATION_PARENT}/${part}" ]]
      ) || {
        mkdir -p "${__DESTINATION_PARENT}/${part}"
      };
      mount "${lv}" "${__DESTINATION_PARENT}/${part}"
    done
  };


  [[ -n "${2}" ]] || {
    exit 0;
  };

  echo "Mounting necessary system partitions to chroot"
  mount -o bind /dev "${__DESTINATION_PARENT}/dev"
  mount -o bind /run "${__DESTINATION_PARENT}/run"
  mount -t devpts devpts "${__DESTINATION_PARENT}/dev/pts"
  mount -t sysfs sys "${__DESTINATION_PARENT}/sys"
  mount -t proc proc "${__DESTINATION_PARENT}/proc"
  exit 0;
} #; function mount_chroot ( )

# function to unmount all partitions defined under __DESTINATION_PARENT
# and "close" the VGs and finally close the LUKS partitions
function umount_chroot () {
  umount -lf "${__DESTINATION_PARENT}"
  for lv in "/dev/mapper/${__VG_SYSTEM}-"*; do
    declare part="$(echo "$(basename "${lv}")" | sed -e 's/vg_.*-//' -e 's/_/\//g')"
    case "${part}" in
      swap)
        swapoff "${lv}"
      ;;
      *)
        continue
      ;;
    esac
  done
  lvchange -a n "${__VG_SYSTEM}"

  [[ -z "${__VG_DATA}" ]] || {
    lvchange -a n "${__VG_DATA}"
    cryptsetup luksClose "/dev/mapper/${__DATA_CRYPT_NAME}"
  };

  cryptsetup luksClose "/dev/mapper/${__SYSTEM_CRYPT_NAME}"
} #; function umount_chroot ( )

case "${1}" in
  mount)
    echo "Mounting chroot"
    mount_chroot "${@}"
  ;;
  umount)
    echo "Unmounting chroot"
    umount_chroot "${@}"
  ;;
  *)
    echo "Use either mount or umount as parameters. Additionally a second parameter with any value can be passed to mount system partitions as well (/dev /dev/pts etc)"
  ;;
esac
#EOF
</code></pre></div></div>

<p>You should now have a file <code class="language-plaintext highlighter-rouge">mount.sh</code> in your current directory, with the contents of the script above (minus the first and last line).
Now, go ahead and adjust the necessary parts and execute it via either <code class="language-plaintext highlighter-rouge">bash mount.sh mount</code> or first setting executable permissions on it and then
executing it (done via <code class="language-plaintext highlighter-rouge">chmod +x mount.sh &amp;&amp; ./mount.sh mount</code>).</p>

<p>The output will look similar to the following (depending again, whether you have an additional data drive or not):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>bash mount.sh mount
<span class="go">Mounting chroot
Trying to decrypt system crypt device '/dev/md1'
Enter passphrase for /dev/md1:
Successful!
Trying to decrypt data crypt device '/dev/md2'
Enter passphrase for /dev/md2:
Successful!
  1 logical volume(s) in volume group "vg_data" now active
  8 logical volume(s) in volume group "vg_system" now active
Data partition defined :3
</span></code></pre></div></div>

<p>Finally you should check whether the script has been successfully run and the partitions are mounted to your needs (the last lines are showing the mounted partitions
from the script):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>mount
<span class="go">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
sys on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,relatime,size=65912560k,nr_inodes=16478140,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
[2a01:4ff:ff00::b007:1]:/nfs on /root/.oldroot/nfs type nfs (ro,noatime,vers=3,rsize=8192,wsize=8192,namlen=255,acregmin=600,acregmax=600,acdirmin=600,acdirmax=600,hard,nocto,nolock,noresvport,proto=tcp6,timeo=600,retrans=2,sec=sys,mountaddr=2a01:4ff:ff00::b007:1,mountvers=3,mountproto=tcp6,local_lock=all,addr=2a01:4ff:ff00::b007:1)
overlay on / type overlay (rw,relatime,lowerdir=/nfsroot,upperdir=/ramfs/root,workdir=/ramfs/work)
securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,nodev,size=26368588k,nr_inodes=819200,mode=755)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
cgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)
pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime)
systemd-1 on /proc/sys/fs/binfmt_misc type autofs (rw,relatime,fd=28,pgrp=1,timeout=0,minproto=5,maxproto=5,direct)
mqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)
hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime,pagesize=2M)
debugfs on /sys/kernel/debug type debugfs (rw,nosuid,nodev,noexec,relatime)
tracefs on /sys/kernel/tracing type tracefs (rw,nosuid,nodev,noexec,relatime)
ramfs on /run/credentials/systemd-sysusers.service type ramfs (ro,nosuid,nodev,noexec,relatime,mode=700)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,nosuid,nodev,noexec,relatime)
fusectl on /sys/fs/fuse/connections type fusectl (rw,nosuid,nodev,noexec,relatime)
configfs on /sys/kernel/config type configfs (rw,nosuid,nodev,noexec,relatime)
ramfs on /run/credentials/systemd-tmpfiles-setup-dev.service type ramfs (ro,nosuid,nodev,noexec,relatime,mode=700)
ramfs on /run/credentials/systemd-sysctl.service type ramfs (ro,nosuid,nodev,noexec,relatime,mode=700)
ramfs on /run/credentials/systemd-tmpfiles-setup.service type ramfs (ro,nosuid,nodev,noexec,relatime,mode=700)
tracefs on /sys/kernel/debug/tracing type tracefs (rw,nosuid,nodev,noexec,relatime)
tmpfs on /run/user/0 type tmpfs (rw,nosuid,nodev,relatime,size=13184292k,nr_inodes=3296073,mode=700)
/dev/mapper/vg_system-root on /mnt type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/md0 on /mnt/boot type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-home on /mnt/home type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-tmp on /mnt/tmp type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-var on /mnt/var type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-var_log on /mnt/var/log type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-var_log_audit on /mnt/var/log/audit type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_system-var_tmp on /mnt/var/tmp type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=256,swidth=256,noquota)
/dev/mapper/vg_data-var_lib_vz on /mnt/var/lib/vz type xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,sunit=1024,swidth=8192,noquota)
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>As the last step, we need to set the proper permissions on the mounted <code class="language-plaintext highlighter-rouge">tmp</code> folder (<code class="language-plaintext highlighter-rouge">/mnt/tmp</code>):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">chmod </span>1777 /mnt/tmp
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h3 id="starting-the-installation">
  
  
    Starting the installation <a href="#starting-the-installation">#</a>
  
  
</h3>
    

<p>Finally we can start the installation of Debian Bullseye within our live system.
For the installation we are going to use a program called <a href="https://wiki.debian.org/Debootstrap"><code class="language-plaintext highlighter-rouge">Debootstrap</code></a>. <code class="language-plaintext highlighter-rouge">Debootstrap</code> is basically used to install a Debian system
within a Debian system (our live environment). The latest version can always be found
<a href="http://ftp.debian.org/debian/pool/main/d/debootstrap/">package repository of debian.org</a> - we need the version, which is packaged using <code class="language-plaintext highlighter-rouge">.deb</code>.</p>
<h3 id="downloading-debootstrap-and-modify-it">
  
  
    Downloading <code class="language-plaintext highlighter-rouge">Debootstrap</code> and modify it <a href="#downloading-debootstrap-and-modify-it">#</a>
  
  
</h3>
    

<p>First, we need to download the .deb using <code class="language-plaintext highlighter-rouge">wget</code> or <code class="language-plaintext highlighter-rouge">curl</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">cd</span> /tmp/
<span class="gp">root@rescue /tmp #</span><span class="w"> </span>wget http://ftp.debian.org/debian/pool/main/d/debootstrap/debootstrap_1.0.124_all.deb
<span class="go">--2021-08-22 12:42:35--  http://ftp.debian.org/debian/pool/main/d/debootstrap/debootstrap_1.0.124_all.deb
Resolving ftp.debian.org (ftp.debian.org)... 151.101.14.132, 2a04:4e42:3::644
Connecting to ftp.debian.org (ftp.debian.org)|151.101.14.132|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 76416 (75K) [application/x-debian-package]
Saving to: ‘debootstrap_1.0.124_all.deb’

</span><span class="gp">debootstrap_1.0.124_all.deb                100%[=======================================================================================&gt;</span><span class="o">]</span>  74.62K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.03s
<span class="go">
2021-08-22 12:42:35 (2.30 MB/s) - ‘debootstrap_1.0.124_all.deb’ saved [76416/76416]

</span><span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>

<p>After we downloaded it, we need to unpack it:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span>ar x debootstrap_1.0.131_all.deb
<span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nb">tar </span>xfz control.tar.gz
<span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nb">tar </span>xfz data.tar.gz
<span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>

<p>Next, we want to make sure, that the contents are not broken or modified in any way.</p>

<p>The following commands create a MD5 checksums from the local files and compare it to the MD5 checksums shipped with the <code class="language-plaintext highlighter-rouge">.deb</code> file.</p>

<p>If there is no output at all, the files do not differ - if there is output, the files differ. If the files differ, re-download it
(it shouldn’t happen at all - <strong>never!</strong>). Although it could be a bug from the Debian team, while creating the package (very, very unlikely!).
If the local MD5 checksums still differ from the shipped MD5 checksums, consider re-downloading an older version (doesn’t really matter) and file a bug report over at Debian.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nb">cat </span>md5sums | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 3 | xargs <span class="nb">md5sum</span> <span class="nv">$1</span> <span class="o">&gt;</span> md5sums.local<span class="p">;</span> diff md5sums md5sums.local
<span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>

<p>Next, we want to search in the file <code class="language-plaintext highlighter-rouge">usr/sbin/debootstrap</code> for the line <code class="language-plaintext highlighter-rouge">DEBOOTSTRAP_DIR=/usr/share/debootstrap</code> and prefix <code class="language-plaintext highlighter-rouge">/tmp</code> in front of the path.
This is necessary in order to run the script from <code class="language-plaintext highlighter-rouge">/tmp</code> (where we are in the moment).</p>

<p>You can either do it by hand or run following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed 's@\/usr\/share\/debootstrap@/tmp/usr/share/debootstrap@' -i usr/sbin/debootstrap
</code></pre></div></div>

<p>.. and check afterwards if the change has been done successfully using the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep [[:space:]]DEBOOTSTRAP_DIR= usr/sbin/debootstrap
</code></pre></div></div>

<p>The output should be similar to following:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nb">sed</span> <span class="s1">'s@\/usr\/share\/debootstrap@/tmp/usr/share/debootstrap@'</span> <span class="nt">-i</span> usr/sbin/debootstrap
<span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nb">grep</span> <span class="o">[[</span>:space:]]DEBOOTSTRAP_DIR<span class="o">=</span> usr/sbin/debootstrap
<span class="go">                DEBOOTSTRAP_DIR=/debootstrap
                DEBOOTSTRAP_DIR=/tmp/usr/share/debootstrap
</span><span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>
<h2 id="installation-of-the-system">
  
  
    Installation of the system <a href="#installation-of-the-system">#</a>
  
  
</h2>
    

<p>Finally we can start the installation using <code class="language-plaintext highlighter-rouge">debootstrap</code> with the following command (replace the values you want to change):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usr/sbin/debootstrap --arch amd64 bookworm /mnt/ http://ftp2.de.debian.org/debian | tee /mnt/install.log
</code></pre></div></div>

<p>The installation will take a couple of minutes/seconds (depending on the performance of your system) and the output will look similar to this (truncated):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span>usr/sbin/debootstrap <span class="nt">--arch</span> amd64 bookworm /mnt/ http://ftp2.de.debian.org/debian | <span class="nb">tee</span> /mnt/install.log
<span class="go">[..]
I: Validating libstdc++6 12.2.0-14
I: Retrieving libsystemd-shared 252.12-1~deb12u1
I: Validating libsystemd-shared 252.12-1~deb12u1
I: Retrieving libsystemd0 252.12-1~deb12u1
I: Validating libsystemd0 252.12-1~deb12u1
I: Retrieving libtasn1-6 4.19.0-2
I: Validating libtasn1-6 4.19.0-2
[..]
I: Validating vim-tiny 2:9.0.1378-2
I: Retrieving whiptail 0.52.23-1+b1
I: Validating whiptail 0.52.23-1+b1
I: Retrieving zlib1g 1:1.2.13.dfsg-1
I: Validating zlib1g 1:1.2.13.dfsg-1
I: Chosen extractor for .deb packages: dpkg-deb
I: Extracting adduser...
I: Extracting apt...
I: Extracting base-files...
I: Extracting base-passwd...
I: Extracting bash...
[..]
I: Unpacking coreutils...
I: Unpacking dash...
I: Unpacking debconf...
I: Unpacking debian-archive-keyring...
I: Unpacking debianutils...
[..]
I: Configuring mawk...
I: Configuring libdebconfclient0:amd64...
I: Configuring base-files...
I: Configuring libbz2-1.0:amd64...
I: Configuring libdb5.3:amd64...
I: Configuring libblkid1:amd64...
I: Configuring libstdc++6:amd64...
I: Configuring libtinfo6:amd64...
[..]
I: Configuring vim-tiny...
I: Configuring fdisk...
I: Configuring libgssapi-krb5-2:amd64...
I: Configuring whiptail...
I: Configuring libtirpc3:amd64...
I: Configuring libnftables1:amd64...
I: Configuring nftables...
I: Configuring iproute2...
I: Configuring isc-dhcp-client...
I: Configuring ifupdown...
I: Configuring tasksel...
I: Configuring tasksel-data...
I: Configuring libc-bin...
I: Base system installed successfully.
</span><span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>

<p>After the installation has been successfully finished, we need to mount the necessary system partitions, in order to configure the system, using the following commands:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span>mount <span class="nt">-o</span> <span class="nb">bind</span> /dev/ /mnt/dev/
<span class="gp">root@rescue /tmp #</span><span class="w"> </span>mount <span class="nt">-t</span> devpts devpts /mnt/dev/pts
<span class="gp">root@rescue /tmp #</span><span class="w"> </span>mount <span class="nt">-t</span> proc proc /mnt/proc/
<span class="gp">root@rescue /tmp #</span><span class="w"> </span>mount <span class="nt">-t</span> sysfs sys /mnt/sys/
<span class="gp">root@rescue /tmp #</span><span class="w"> </span>mount <span class="nt">-o</span> <span class="nb">bind</span> /run /mnt/run
<span class="gp">root@rescue /tmp #</span><span class="w">
</span></code></pre></div></div>

<p>.. or “copy-paste-friendlier”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount -o bind /dev/ /mnt/dev/; mount -t devpts devpts /mnt/dev/pts; mount -t proc proc /mnt/proc/; mount -t sysfs sys /mnt/sys/; mount -o bind /run /mnt/run
</code></pre></div></div>

<p>Finally we have the system installed and ready to configure - we still have a couple of things to do, in order to make the system work as we want it to.</p>
<h2 id="base-configuration">
  
  
    Base configuration <a href="#base-configuration">#</a>
  
  
</h2>
    

<p>First we want to <code class="language-plaintext highlighter-rouge">chroot</code> to the environment:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue /tmp #</span><span class="w"> </span><span class="nv">XTERM</span><span class="o">=</span>xterm-color <span class="nv">LANG</span><span class="o">=</span>C.UTF-8 <span class="nb">chroot</span> /mnt /bin/bash
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">pwd</span>
<span class="go">/
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>We need to set the proper permissions for <code class="language-plaintext highlighter-rouge">/tmp</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chmod </span>1777 /tmp/
</code></pre></div></div>

<p>Next, we want to change the root password, as it is currently not set (use a <strong>complex</strong> and <strong>unique</strong> password!):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>passwd
<span class="go">Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Then we want to set both the <code class="language-plaintext highlighter-rouge">hostname</code> (<code class="language-plaintext highlighter-rouge">/etc/hostname</code>) and <code class="language-plaintext highlighter-rouge">mailname</code> (<code class="language-plaintext highlighter-rouge">/etc/mailname</code> - this will come in handy later, when we install <code class="language-plaintext highlighter-rouge">postfix</code>) and as well add
ourselves to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"pven.scheib.me"</span> <span class="o">&gt;</span> /etc/hostname
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"pven.scheib.me"</span> <span class="o">&gt;</span> /etc/mailname
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span>ip addr show eth0 | <span class="nb">grep </span>inet[[:space:]] | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">sed</span> <span class="nt">-E</span> <span class="s1">'s@\/[[:digit:]]+$@@'</span><span class="si">)</span><span class="s2"> </span><span class="si">$(</span><span class="nb">cat</span> /etc/hostname<span class="si">)</span><span class="s2"> </span><span class="si">$(</span><span class="nb">cat</span> /etc/hostname | <span class="nb">sed</span> <span class="s1">'s@\.@ @g'</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>As next step we want to configure our network adapter(s) within <code class="language-plaintext highlighter-rouge">/etc/network/interfaces</code> - mine looks like the following:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/network/interfaces
<span class="gp">#</span><span class="w"> </span>interfaces<span class="o">(</span>5<span class="o">)</span> file used by ifup<span class="o">(</span>8<span class="o">)</span> and ifdown<span class="o">(</span>8<span class="o">)</span>
<span class="gp">#</span><span class="w"> </span>Include files from /etc/network/interfaces.d:
<span class="go">source-directory /etc/network/interfaces.d

auto            lo
iface           lo inet loopback

auto            eth0
iface           eth0 inet static
address         159.69.68.69
netmask         255.255.255.192
gateway         159.69.68.65
broadcast       159.69.68.127
pre-up          /sbin/ip addr flush dev eth0 || true
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Please note, I modified the IP addresses and they do not reflect an actual system. Please adjust the file accordingly.</p>

<p>The <code class="language-plaintext highlighter-rouge">pre-up</code> command <code class="language-plaintext highlighter-rouge">/sbin/ip addr flush dev eth0 || true</code> has to be used, as we have an IP address already <em>before</em> the final system is up and running. This is due
to the <code class="language-plaintext highlighter-rouge">Dropbear instance</code> that is running which allows as to unlock the <code class="language-plaintext highlighter-rouge">LUKS</code> partition(s) - more on that later.</p>

<p>Of course we want to set our nameservers correctly - in this case I am using the nameservers from
<a href="https://www.cloudflare.com/de-de/learning/dns/what-is-1.1.1.1/">Cloudflare</a> and <a href="https://developers.google.com/speed/public-dns">Google</a>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/resolv.conf
<span class="go">nameserver 1.1.1.1
nameserver 1.0.0.1
nameserver 8.8.8.8
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> I am not using <code class="language-plaintext highlighter-rouge">systemd-resolved</code>, therefore I can simply edit <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code></p>

<p>Also we want to set the sources for aptitude correctly (change it to your needs):</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cat &gt;</span><span class="w"> </span>/etc/apt/sources.list &lt;&lt; <span class="s2">"#EOF"</span>
<span class="go">deb http://ftp.de.debian.org/debian/ bookworm main non-free non-free-firmware contrib
deb-src http://ftp.de.debian.org/debian/ bookworm main non-free non-free-firmware contrib
deb http://security.debian.org/ bookworm-security main non-free non-free-firmware contrib
deb-src http://security.debian.org/ bookworm-security main non-free non-free-firmware contrib
deb http://ftp.de.debian.org/debian/ bookworm-updates main non-free non-free-firmware contrib
deb-src http://ftp.de.debian.org/debian/ bookworm-updates main non-free non-free-firmware contrib
</span><span class="gp">#</span>EOF
</code></pre></div></div>

<p>.. which will result in the following file:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/apt/sources.list
<span class="go">deb http://ftp.de.debian.org/debian/ bookworm main non-free non-free-firmware contrib
deb-src http://ftp.de.debian.org/debian/ bookworm main non-free non-free-firmware contrib
deb http://security.debian.org/ bookworm-security main non-free non-free-firmware contrib
deb-src http://security.debian.org/ bookworm-security main non-free non-free-firmware contrib
deb http://ftp.de.debian.org/debian/ bookworm-updates main non-free non-free-firmware contrib
deb-src http://ftp.de.debian.org/debian/ bookworm-updates main non-free non-free-firmware contrib
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p><img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> Debian split with Bookworm its non-free repository. You can read more on that in the
<a href="https://www.debian.org/releases/bookworm/amd64/release-notes/ch-whats-new.en.html#archive-areas">release notes of Debian Bookworm</a>.</p>

<p>Let’s update the cache .. <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>apt-get update
<span class="go">Fetched 22.9 MB in 3s (8565 kB/s)
[..]
Reading package lists... Done
Building dependency tree... Done
3 packages can be upgraded. Run 'apt list --upgradable' to see them.
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Finally we want to install and configure the <code class="language-plaintext highlighter-rouge">locales</code> (I use <code class="language-plaintext highlighter-rouge">en_US.UTF-8</code> as the system language), using the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install -y locales &amp;&amp; dpkg-reconfigure locales
</code></pre></div></div>

<!-- markdownlint-disable MD033 MD034 -->
<details>
<summary>Example output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue:/#</span><span class="w"> </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> locales <span class="o">&amp;&amp;</span> dpkg-reconfigure locales
<span class="go">Reading package lists... Done
Building dependency tree... Done
The following additional packages will be installed:
  libc-l10n
The following NEW packages will be installed:
  libc-l10n locales
0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.
Need to get 4577 kB of archives.
After this operation, 20.7 MB of additional disk space will be used.
Get:1 http://ftp.de.debian.org/debian bookworm/main amd64 libc-l10n all 2.36-9+deb12u1 [673 kB]
Get:2 http://ftp.de.debian.org/debian bookworm/main amd64 locales all 2.36-9+deb12u1 [3904 kB]
Fetched 4577 kB in 0s (18.3 MB/s)
Preconfiguring packages ...
Selecting previously unselected package libc-l10n.
(Reading database ... 8743 files and directories currently installed.)
Preparing to unpack .../libc-l10n_2.36-9+deb12u1_all.deb ...
Unpacking libc-l10n (2.36-9+deb12u1) ...
Selecting previously unselected package locales.
Preparing to unpack .../locales_2.36-9+deb12u1_all.deb ...
Unpacking locales (2.36-9+deb12u1) ...
Setting up libc-l10n (2.36-9+deb12u1) ...
Setting up locales (2.36-9+deb12u1) ...
Generating locales (this might take a while)...
Generation complete.
Generating locales (this might take a while)...
  en_US.UTF-8... done
Generation complete.
</span><span class="gp">root@rescue:/#</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD033 MD034 -->

<p>Additionally we need to set a few more locale settings in <code class="language-plaintext highlighter-rouge">/etc/environment</code>, which are not set by default, but are causing warning messages when not set,
while installing packages using <code class="language-plaintext highlighter-rouge">aptitude</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cat &gt;</span><span class="w"> </span>/etc/environment <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">"
</span><span class="go">export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
EOF
</span></code></pre></div></div>

<!-- markdownlint-disable MD033 -->
<details>
<summary>Example output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> <span class="o">&gt;</span> /etc/environment <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">"
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">export LANGUAGE=en_US.UTF-8
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">export LC_ALL=en_US.UTF-8
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">export LANG=en_US.UTF-8
</span><span class="gp">&gt;</span><span class="w"> </span><span class="no">EOF
</span><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/environment
<span class="go">export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
</span><span class="gp">root@rescue:/#</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD033 -->

<p>Next, we want to set the correct timezone using <code class="language-plaintext highlighter-rouge">tzdata</code> and the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpkg-reconfigure tzdata
</code></pre></div></div>

<!-- markdownlint-disable MD033 -->
<details>
<summary>Example output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue:/#</span><span class="w"> </span>dpkg-reconfigure tzdata
<span class="go">
Current default time zone: 'Europe/Berlin'
Local time is now:      Mon Aug 28 22:54:27 CEST 2023.
Universal Time is now:  Mon Aug 28 20:54:27 UTC 2023.

</span><span class="gp">root@rescue:/#</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD033 -->

<p>Last but not least, we want to install <code class="language-plaintext highlighter-rouge">cryptsetup</code> and the linux image itself for AMD64 architectures (<code class="language-plaintext highlighter-rouge">linux-image-amd64</code>; For i386 (32bit) systems you need to install
the package for i386). During the installation also the keyboard is configured - I set mine to German.</p>

<p>The following command will be used to install the needed packages:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install -y linux-image-amd64 cryptsetup
</code></pre></div></div>

<!-- markdownlint-disable MD033 MD034 -->
<details>
<summary>Example output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue:/#</span><span class="w"> </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> linux-image-amd64 cryptsetup
<span class="go">Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  apparmor busybox cryptsetup-bin firmware-linux-free initramfs-tools initramfs-tools-core klibc-utils libklibc linux-base linux-image-6.1.0-11-amd64 zstd
Suggested packages:
  apparmor-profiles-extra apparmor-utils cryptsetup-initramfs dosfstools keyutils bash-completion linux-doc-6.1 debian-kernel-handbook grub-pc | grub-efi-amd64 | extlinux
The following NEW packages will be installed:
  apparmor busybox cryptsetup cryptsetup-bin firmware-linux-free initramfs-tools initramfs-tools-core klibc-utils libklibc linux-base linux-image-6.1.0-11-amd64 linux-image-amd64
  zstd
0 upgraded, 13 newly installed, 0 to remove and 0 not upgraded.
Need to get 71.3 MB of archives.
After this operation, 418 MB of additional disk space will be used.
Get:1 http://security.debian.org bookworm-security/main amd64 linux-image-6.1.0-11-amd64 amd64 6.1.38-4 [68.5 MB]
Get:2 http://ftp.de.debian.org/debian bookworm/main amd64 apparmor amd64 3.0.8-3 [616 kB]
Get:3 http://security.debian.org bookworm-security/main amd64 linux-image-amd64 amd64 6.1.38-4 [1484 B]
Get:4 http://ftp.de.debian.org/debian bookworm/main amd64 busybox amd64 1:1.35.0-4+b3 [452 kB]
Get:5 http://ftp.de.debian.org/debian bookworm/main amd64 cryptsetup-bin amd64 2:2.6.1-4~deb12u1 [473 kB]
Get:6 http://ftp.de.debian.org/debian bookworm/main amd64 cryptsetup amd64 2:2.6.1-4~deb12u1 [213 kB]
Get:7 http://ftp.de.debian.org/debian bookworm/main amd64 firmware-linux-free all 20200122-1 [24.2 kB]
Get:8 http://ftp.de.debian.org/debian bookworm/main amd64 libklibc amd64 2.0.12-1 [44.2 kB]
Get:9 http://ftp.de.debian.org/debian bookworm/main amd64 klibc-utils amd64 2.0.12-1 [94.9 kB]
Get:10 http://ftp.de.debian.org/debian bookworm/main amd64 initramfs-tools-core all 0.142 [105 kB]
Get:11 http://ftp.de.debian.org/debian bookworm/main amd64 linux-base all 4.9 [31.8 kB]
Get:12 http://ftp.de.debian.org/debian bookworm/main amd64 initramfs-tools all 0.142 [72.9 kB]
Get:13 http://ftp.de.debian.org/debian bookworm/main amd64 zstd amd64 1.5.4+dfsg2-5 [701 kB]
Fetched 71.3 MB in 2s (37.1 MB/s)
Preconfiguring packages ...
Selecting previously unselected package apparmor.
(Reading database ... 9405 files and directories currently installed.)
Preparing to unpack .../00-apparmor_3.0.8-3_amd64.deb ...
Unpacking apparmor (3.0.8-3) ...
Selecting previously unselected package busybox.
Preparing to unpack .../01-busybox_1%3a1.35.0-4+b3_amd64.deb ...
Unpacking busybox (1:1.35.0-4+b3) ...
Selecting previously unselected package cryptsetup-bin.
Preparing to unpack .../02-cryptsetup-bin_2%3a2.6.1-4~deb12u1_amd64.deb ...
Unpacking cryptsetup-bin (2:2.6.1-4~deb12u1) ...
Selecting previously unselected package cryptsetup.
Preparing to unpack .../03-cryptsetup_2%3a2.6.1-4~deb12u1_amd64.deb ...
Unpacking cryptsetup (2:2.6.1-4~deb12u1) ...
Selecting previously unselected package firmware-linux-free.
Preparing to unpack .../04-firmware-linux-free_20200122-1_all.deb ...
Unpacking firmware-linux-free (20200122-1) ...
Selecting previously unselected package libklibc:amd64.
Preparing to unpack .../05-libklibc_2.0.12-1_amd64.deb ...
Unpacking libklibc:amd64 (2.0.12-1) ...
Selecting previously unselected package klibc-utils.
Preparing to unpack .../06-klibc-utils_2.0.12-1_amd64.deb ...
Unpacking klibc-utils (2.0.12-1) ...
Selecting previously unselected package initramfs-tools-core.
Preparing to unpack .../07-initramfs-tools-core_0.142_all.deb ...
Unpacking initramfs-tools-core (0.142) ...
Selecting previously unselected package linux-base.
Preparing to unpack .../08-linux-base_4.9_all.deb ...
Unpacking linux-base (4.9) ...
Selecting previously unselected package initramfs-tools.
Preparing to unpack .../09-initramfs-tools_0.142_all.deb ...
Unpacking initramfs-tools (0.142) ...
Selecting previously unselected package linux-image-6.1.0-11-amd64.
Preparing to unpack .../10-linux-image-6.1.0-11-amd64_6.1.38-4_amd64.deb ...
Unpacking linux-image-6.1.0-11-amd64 (6.1.38-4) ...
Selecting previously unselected package linux-image-amd64.
Preparing to unpack .../11-linux-image-amd64_6.1.38-4_amd64.deb ...
Unpacking linux-image-amd64 (6.1.38-4) ...
Selecting previously unselected package zstd.
Preparing to unpack .../12-zstd_1.5.4+dfsg2-5_amd64.deb ...
Unpacking zstd (1.5.4+dfsg2-5) ...
Setting up cryptsetup-bin (2:2.6.1-4~deb12u1) ...
Setting up linux-base (4.9) ...
Setting up cryptsetup (2:2.6.1-4~deb12u1) ...
Running in chroot, ignoring command 'daemon-reload'
Running in chroot, ignoring command 'daemon-reload'
Setting up firmware-linux-free (20200122-1) ...
Setting up apparmor (3.0.8-3) ...
Running in chroot, ignoring command 'daemon-reload'
Created symlink /etc/systemd/system/sysinit.target.wants/apparmor.service → /lib/systemd/system/apparmor.service.
Setting up busybox (1:1.35.0-4+b3) ...
Setting up libklibc:amd64 (2.0.12-1) ...
Setting up klibc-utils (2.0.12-1) ...
No diversion 'diversion of /usr/share/initramfs-tools/hooks/klibc to /usr/share/initramfs-tools/hooks/klibc^i-t by klibc-utils', none removed.
Setting up zstd (1.5.4+dfsg2-5) ...
Setting up initramfs-tools-core (0.142) ...
Setting up initramfs-tools (0.142) ...
update-initramfs: deferring update (trigger activated)
Setting up linux-image-6.1.0-11-amd64 (6.1.38-4) ...
I: /vmlinuz.old is now a symlink to boot/vmlinuz-6.1.0-11-amd64
I: /initrd.img.old is now a symlink to boot/initrd.img-6.1.0-11-amd64
I: /vmlinuz is now a symlink to boot/vmlinuz-6.1.0-11-amd64
I: /initrd.img is now a symlink to boot/initrd.img-6.1.0-11-amd64
/etc/kernel/postinst.d/initramfs-tools:
update-initramfs: Generating /boot/initrd.img-6.1.0-11-amd64
Setting up linux-image-amd64 (6.1.38-4) ...
Processing triggers for initramfs-tools (0.142) ...
update-initramfs: Generating /boot/initrd.img-6.1.0-11-amd64</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD033 MD034 -->
<h2 id="configuring-etccrypttab-and-etcfstab">
  
  
    Configuring <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> and <code class="language-plaintext highlighter-rouge">/etc/fstab</code> <a href="#configuring-etccrypttab-and-etcfstab">#</a>
  
  
</h2>
    

<p>Next up is the configuration of <a href="https://linux.die.net/man/5/crypttab"><code class="language-plaintext highlighter-rouge">/etc/crypttab</code></a> and <a href="https://wiki.debian.org/fstab"><code class="language-plaintext highlighter-rouge">/etc/fstab</code></a>.
First, we’ll be starting with <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> - to do so, we first have to read out the <code class="language-plaintext highlighter-rouge">UUID</code> of our system <code class="language-plaintext highlighter-rouge">LUKS</code> partition by using (adapt to your crypt device if necessary):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cryptsetup luksDump /dev/md1 | grep UUID
</code></pre></div></div>

<p>The given <code class="language-plaintext highlighter-rouge">UUID</code> has to be added to the file <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> in the following format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;LUKS_device_name&gt; UUID=&lt;UUID&gt; none luks
</code></pre></div></div>

<p>Substitute <code class="language-plaintext highlighter-rouge">&lt;LUKS_device_name&gt;</code> with the name of your <code class="language-plaintext highlighter-rouge">LUKS</code> device (e.g. <code class="language-plaintext highlighter-rouge">crypted_system</code>) and <code class="language-plaintext highlighter-rouge">&lt;UUID&gt;</code> with the <code class="language-plaintext highlighter-rouge">UUID</code> you received by the command before.</p>

<p>You can either do it by hand or use the following one liner (you can adjust the name of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "crypted_system UUID="$(cryptsetup luksDump /dev/md1 | grep UUID | awk '/UUID/ { print $2 }')" none luks" &gt; /etc/crypttab
</code></pre></div></div>

<p>The next step is to configure <code class="language-plaintext highlighter-rouge">/etc/fstab</code>.
To do so, we first need to read out the <code class="language-plaintext highlighter-rouge">UUID</code> for both the <code class="language-plaintext highlighter-rouge">/boot</code> partition (which is stored on <code class="language-plaintext highlighter-rouge">/dev/md0</code>) and all partitions that <code class="language-plaintext highlighter-rouge">LVM</code> is managing for us.
Again depending whether you have multiple <code class="language-plaintext highlighter-rouge">VGs</code> (e.g. another drive holding data) or not. This can be easily achieved using <code class="language-plaintext highlighter-rouge">blkid</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>blkid /dev/md0
<span class="go">/dev/md0: UUID="67619dac-48fd-4140-9040-d31c1d3bba0f" TYPE="xfs" PARTLABEL="Linux filesystem" PARTUUID="e435544d-b8df-4e6a-bf74-7f094c3007e1"
</span><span class="gp">root@rescue:/#</span><span class="w"> </span>blkid /dev/mapper/vg_system-<span class="k">*</span>
<span class="go">/dev/mapper/vg_system-home: UUID="e560e1fc-897e-4738-832c-09c2663048ba" TYPE="xfs"
/dev/mapper/vg_system-root: UUID="c1934670-c520-4d57-b87c-69a376fa51e4" TYPE="xfs"
/dev/mapper/vg_system-swap: UUID="a2f49117-66f0-489b-9092-6548c272766d" TYPE="swap"
/dev/mapper/vg_system-tmp: UUID="d9f8f8a5-3a5f-4199-817c-a5c454281aeb" TYPE="xfs"
/dev/mapper/vg_system-var: UUID="1408bbe7-88a7-4181-85bc-edcc7b2ef054" TYPE="xfs"
/dev/mapper/vg_system-var_log: UUID="6f354868-dd1e-48d6-8ef7-c0dac5324ac5" TYPE="xfs"
/dev/mapper/vg_system-var_log_audit: UUID="3a5bf013-75e0-4981-a2fb-1666e0e3c293" TYPE="xfs"
/dev/mapper/vg_system-var_tmp: UUID="a2432df7-dd9d-4bc1-9a04-2f118463bf31" TYPE="xfs"
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Please note, the <code class="language-plaintext highlighter-rouge">UUIDs</code> above have been randomized and thus do not reflect an actual system. Your <code class="language-plaintext highlighter-rouge">UUIDs</code> will, of course, vary.</p>

<p>With the above information we can build our <code class="language-plaintext highlighter-rouge">/etc/fstab</code> in the following format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;file system UUID&gt; &lt;mount point on the system&gt; &lt;type&gt; &lt;mount options&gt; &lt;dump&gt; &lt;pass&gt;
</code></pre></div></div>

<p>In the following table I summarized the flags (mount options) for each mount point. These are documented at e.g. <a href="https://linux.die.net/man/8/mount">linux.die.net</a>.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">mount point</th>
      <th style="text-align: left">flags</th>
      <th style="text-align: left">comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">defaults</code></td>
      <td style="text-align: left">-</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/boot</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">defaults</code></td>
      <td style="text-align: left">-</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/tmp</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw,nosuid,nodev,noexec</code></td>
      <td style="text-align: left">For security reasons, you should consider adding <code class="language-plaintext highlighter-rouge">nosuid,nodev,noexec</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw</code></td>
      <td style="text-align: left">-</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/log</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw,nosuid,nodev,noexec</code></td>
      <td style="text-align: left">For security reasons, you should consider adding <code class="language-plaintext highlighter-rouge">nosuid,nodev,noexec</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/log/audit</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw,nosuid,nodev,noexec</code></td>
      <td style="text-align: left">For security reasons, you should consider adding <code class="language-plaintext highlighter-rouge">nosuid,nodev,noexec</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/var/tmp</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw,nosuid,nodev</code></td>
      <td style="text-align: left">For security reasons, you should consider adding <code class="language-plaintext highlighter-rouge">nosuid,nodev</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/home</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rw,nosuid,nodev</code></td>
      <td style="text-align: left">For security reasons, you should consider adding <code class="language-plaintext highlighter-rouge">nosuid,nodev</code>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">swap</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">sw</code></td>
      <td style="text-align: left">-</td>
    </tr>
  </tbody>
</table>

<p>Please note, the hardening mount options are taken from the <a href="https://www.cisecurity.org/benchmark/debian_linux"><code class="language-plaintext highlighter-rouge">CIS</code> Benchmark for Debian Bullseye</a>.</p>

<p>The end result will look something like this:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/fstab
<span class="gp">#</span><span class="w"> </span>file system                                   mount point     <span class="nb">type    </span>options                 dump    pass
<span class="go">UUID=c1934670-c520-4d57-b87c-69a376fa51e4       /               xfs     defaults                0       1
UUID=67619dac-48fd-4140-9040-d31c1d3bba0f       /boot           xfs     defaults                0       1
UUID=d9f8f8a5-3a5f-4199-817c-a5c454281aeb       /tmp            xfs     rw,nosuid,nodev         0       2
UUID=1408bbe7-88a7-4181-85bc-edcc7b2ef054       /var            xfs     rw                      0       2
UUID=6f354868-dd1e-48d6-8ef7-c0dac5324ac5       /var/log        xfs     rw,nosuid,nodev,noexec  0       2
UUID=3a5bf013-75e0-4981-a2fb-1666e0e3c293       /var/log/audit  xfs     rw,nosuid,nodev,noexec  0       2
UUID=a2432df7-dd9d-4bc1-9a04-2f118463bf31       /var/tmp        xfs     rw,nosuid,nodev         0       2
UUID=e560e1fc-897e-4738-832c-09c2663048ba       /home           xfs     rw,nosuid,nodev         0       2
UUID=a2f49117-66f0-489b-9092-6548c272766d       none            swap    sw                      0       0
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>
<h3 id="optional-configuring-automatical-unlock-of-the-data-partition">
  
  
    Optional: Configuring automatical unlock of the data partition <a href="#optional-configuring-automatical-unlock-of-the-data-partition">#</a>
  
  
</h3>
    

<p>In order to unlock the data <code class="language-plaintext highlighter-rouge">LUKS</code> partition after the system <code class="language-plaintext highlighter-rouge">LUKS</code> has been unlocked, we can make use of a
so-called <a href="https://wiki.archlinux.org/title/dm-crypt/Device_encryption#Keyfiles"><code class="language-plaintext highlighter-rouge">keyfile</code></a>.</p>

<p>What we can to do is:</p>

<ul>
  <li>Create a <code class="language-plaintext highlighter-rouge">keyfile</code>
</li>
  <li>Restrict the permissions of the <code class="language-plaintext highlighter-rouge">keyfile</code>, so only the user root has access to it</li>
  <li>Add the <code class="language-plaintext highlighter-rouge">keyfile</code> to the data <code class="language-plaintext highlighter-rouge">LUKS</code> partition</li>
  <li>Add an additional entry in <code class="language-plaintext highlighter-rouge">/etc/crypttab</code>, so the data <code class="language-plaintext highlighter-rouge">LUKS</code> partition gets automatically unlocked, when the system <code class="language-plaintext highlighter-rouge">LUKS</code> partition gets unlocked</li>
</ul>

<p>First, we need to create a <code class="language-plaintext highlighter-rouge">keyfile</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/root/keyfile <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>4
<span class="go">4+0 records in
4+0 records out
4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000149027 s, 27.5 MB/s
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Next, we set the appropriate permissions on this file:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chmod </span>0400 /root/keyfile
<span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Now, we add the <code class="language-plaintext highlighter-rouge">keyfile</code> to the data <code class="language-plaintext highlighter-rouge">LUKS</code> partition.
For this process you need to enter the password, which you used to create the <code class="language-plaintext highlighter-rouge">LUKS</code> (data) partition:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>cryptsetup luksAddKey /dev/md2 /root/keyfile
<span class="go">Enter any existing passphrase:
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>We can verify, that adding of the <code class="language-plaintext highlighter-rouge">keyfile</code> worked properly using <code class="language-plaintext highlighter-rouge">cryptsetup luksDump</code> - here we can see, that two key slots are taken:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>cryptsetup luksDump /dev/md2
<span class="go">LUKS header information for /dev/md2

Version:        1
Cipher name:    aes
Cipher mode:    xts-plain64
Hash spec:      sha1
Payload offset: 4096
MK bits:        512
MK digest:      3d 0b c6 a2 5c d1 37 98 87 70 ee 22 48 48 ff 90 36 2a 5d 46
MK salt:        e9 cb 0d bc 5f 1f 1d 77 ff 6b 2f 75 c4 3d 52 4b
                85 e2 ec 95 47 5c 20 8c dd ad 97 60 08 5c c4 a3
MK iterations:  158375
UUID:           4132d4a6-929e-4ab0-8bdd-ee43065b4b03

Key Slot 0: ENABLED
        Iterations:             633663
        Salt:                   a1 55 d6 82 9e 9b b1 26 55 48 88 01 83 50 fa 8b
                                d2 7d cc 16 bd 25 75 b9 af 5f 70 ef ee a1 fa 4b
        Key material offset:    8
        AF stripes:             4000
Key Slot 1: ENABLED
        Iterations:             1414363
        Salt:                   a5 9f f6 6e bc f7 4d 8d 5b 3b a7 03 65 f1 90 34
                                59 07 51 31 58 de ee be a8 58 49 1f 4b 6f 51 a2
        Key material offset:    512
        AF stripes:             4000
Key Slot 2: DISABLED
Key Slot 3: DISABLED
Key Slot 4: DISABLED
Key Slot 5: DISABLED
Key Slot 6: DISABLED
Key Slot 7: DISABLED
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Finally we add the device <code class="language-plaintext highlighter-rouge">/dev/md2</code> with its <code class="language-plaintext highlighter-rouge">UUID</code> (taken from <code class="language-plaintext highlighter-rouge">cryptsetup luksDump</code>) to <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> with a reference to the <code class="language-plaintext highlighter-rouge">keyfile</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">echo</span> <span class="s1">'crypted_data UUID=4132d4a6-929e-4ab0-8bdd-ee43065b4b03 /root/keyfile luks'</span> <span class="o">&gt;&gt;</span> /etc/crypttab
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/crypttab
<span class="go">crypted_system UUID=e6864adb-dd67-42a1-867c-6a241b4119b5 none luks
crypted_data UUID=4132d4a6-929e-4ab0-8bdd-ee43065b4b03 /root/keyfile luks
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>
<h2 id="installing-additional-software">
  
  
    Installing additional software <a href="#installing-additional-software">#</a>
  
  
</h2>
    

<p>Within this section, we are going to install additional packages. Not all packages I am going to install are needed by the operating system to function properly.
First, install the <strong>required packages</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install -y makedev lvm2 ssh dropbear busybox initramfs-tools bash-completion kbd console-setup pciutils psmisc grub-pc git plymouth sudo man xfsprogs ntp python3 dropbear-initramfs
</code></pre></div></div>

<p><strong>Optionally</strong>, install more packages, such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get -y install vim iftop iotop htop screen postfix mailutils fail2ban mdadm
</code></pre></div></div>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> It can happen that the disks are detected in a different order during boot than during installation time. To avoid issues while booting, please select
all <strong>physical devices</strong> during GRUB installation, when the installer asks you where to install GRUB to.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> Physical devices are for instance <code class="language-plaintext highlighter-rouge">/dev/sda</code>, <code class="language-plaintext highlighter-rouge">/dev/sdb</code>; <strong>NOT</strong> the partitions of those devices (such as <code class="language-plaintext highlighter-rouge">/dev/sda1</code>, etc.).</p>
<h2 id="post-installation-tasks">
  
  
    Post-installation tasks <a href="#post-installation-tasks">#</a>
  
  
</h2>
    

<p>Generally the system is fully installed and can be rebooted.
<strong>However</strong>, the remote unlock via SSH is not configured yet and as well some optional post-installation setup tasks are not done (yet).
This includes adding an additional user, configuring vim, installing fail2ban as a precaution and “hardening” the system a bit.</p>
<h3 id="configuring-vim">
  
  
    Configuring vim <a href="#configuring-vim">#</a>
  
  
</h3>
    

<p>With later versions of vim it is (by default) not possible anymore to copy/paste from vim using your mouse. In order to be able to copy/paste from vim, one needs to
create a <code class="language-plaintext highlighter-rouge">.vimrc</code> in every users home directory with the following content:</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">set</span> <span class="nb">clipboard</span><span class="p">=</span>unnamed
</code></pre></div></div>

<p>It is a pain if you have to do this (and even remembering to do so) every time you add a new user. This is why we make use of <code class="language-plaintext highlighter-rouge">/etc/skel</code> and simply add a file in
there called <code class="language-plaintext highlighter-rouge">.vimrc</code> with the line from above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'set clipboard=unnamed' &gt; /etc/skel/.vimrc
</code></pre></div></div>

<p>By now every new user will have this file in its home directory automatically. As the user root is already created, we need to copy this file to its home directory:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cp</span> /etc/skel/.vimrc /root/
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /root/
<span class="go">total 20
drwx------  2 root root   62 Aug 26 19:08 .
drwxr-xr-x 21 root root 4096 Aug 26 16:59 ..
-rw-r--r--  1 root root  570 Jan 31  2010 .bashrc
-rw-r--r--  1 root root  148 Aug 17  2015 .profile
-rw-r--r--  1 root root   22 Aug 26 19:08 .vimrc
-r--------  1 root root 4096 Aug 26 18:30 keyfile
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>
<h3 id="adding-an-additional-user">
  
  
    Adding an additional user <a href="#adding-an-additional-user">#</a>
  
  
</h3>
    

<p>Adding an additional user is pretty easy and does not need much explanation.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>adduser steffen <span class="nt">--disabled-password</span> <span class="nt">--gecos</span> <span class="s2">"steffen"</span>
<span class="go">Adding user `steffen' ...
Adding new group `steffen' (1000) ...
Adding new user `steffen' (1000) with group `steffen' ...
Creating home directory `/home/steffen' ...
Copying files from `/etc/skel' ...
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Adding the user to <code class="language-plaintext highlighter-rouge">sudoers</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>usermod <span class="nt">-aG</span> <span class="nb">sudo </span>steffen
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">groups </span>steffen
<span class="go">steffen : steffen sudo
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Add (an) SSH public key(s) to the users <code class="language-plaintext highlighter-rouge">authorized_keys</code> file:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">mkdir</span> /home/steffen/.ssh
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> <span class="o">&gt;</span>  /home/steffen/.ssh/authorized_keys <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">"
</span><span class="go">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINmwi1h1337Q/hIomn3VWjw5Ky2vd2ujnYyaTLuil5sh Key1
ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA313373bmlzdHA1MjEAAACFBADjklC2kev78lChCQobczoF0Zl1lcL9SWiVcfj/KoloxC2/Nz7gN1UQdqJHKJamwWyFdIUy6JucRK730LV4QQhVNwCY2fyf9gGaOP56FvzzeEq9n2pR3WNyD74Bn8u1abt+vALHDEVO6dejZKunJmzsBzXIe79kAH34NwM+gCd4vQbjoQ== Key2
ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAF11m0mRdIjcwwrfz04t4O+YqngFbP0gP313373+vUADyOYkdhiimbJYN9ge1nVy3nMkMGMf5HNzD9AbO1ACjRyFkta0b2pNyu3kdKu6EQlJWgl25PzJQLjxhllinS+xf4rT5lcdOu3aSKDrG6lV5xXh/Cw/i84VR5NWFftHfRA== Key3
EOF
</span><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chown</span> <span class="nt">-R</span> steffen:steffen /home/steffen/
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chmod </span>600 /home/steffen/.ssh/authorized_keys
<span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Of course, the SSH keys above have been modified <img class="emoji" title=":slightly_smiling_face:" alt=":slightly_smiling_face:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png" height="20" width="20"></p>

<p>Set the default editor to vim:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>update-alternatives <span class="nt">--set</span> editor /usr/bin/vim.basic
<span class="go">update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/editor (editor) in manual mode
</span></code></pre></div></div>

<p>Adding an Ansible user to be able to automate the system later on:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>adduser remote-ansible <span class="nt">--disabled-password</span> <span class="nt">--gecos</span> <span class="s2">"Ansible Remote User"</span>
<span class="go">Adding user `remote-ansible' ...
Adding new group `remote-ansible' (1001) ...
Adding new user `remote-ansible' (1001) with group `remote-ansible' ...
Creating home directory `/home/remote-ansible' ...
Copying files from `/etc/skel' ...
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Adding the Ansible user to <code class="language-plaintext highlighter-rouge">sudoers</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>usermod <span class="nt">-aG</span> <span class="nb">sudo </span>remote-ansible
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">groups </span>remote-ansible
<span class="go">remote-ansible : remote-ansible sudo
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Add a public key to the Ansible user’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> file:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">mkdir</span> /home/remote-ansible/.ssh
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> <span class="o">&gt;</span>  /home/remote-ansible/.ssh/authorized_keys <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="no">EOF</span><span class="sh">"
</span><span class="go">ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1Mj313373/ok5i5CSwUuK8y8Zn2URC/ex1cQBfVBANQlfhAe7P4eFK43IdSsnp3uEigsLOr9Uju9QvuniTNuIudkfonmeL91znWyP0KyCciOxZO2O7Mtf6V9GLaA== root@ansible.servers.local
EOF
</span><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chown</span> <span class="nt">-R</span> remote-ansible:remote-ansible /home/remote-ansible/
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">chmod </span>600 /home/remote-ansible/.ssh/authorized_keys
<span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>In order to allow <code class="language-plaintext highlighter-rouge">sudo</code> commands without entering a password the <code class="language-plaintext highlighter-rouge">sudoers</code> file needs to be adjusted - specifically the <code class="language-plaintext highlighter-rouge">%sudo rule</code> (use <code class="language-plaintext highlighter-rouge">visudo</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Allow members of group sudo to execute any command
%sudo   ALL=(ALL) NOPASSWD: ALL
</code></pre></div></div>
<h3 id="hardening-the-system">
  
  
    “Hardening” the system <a href="#hardening-the-system">#</a>
  
  
</h3>
    

<p>The system should be hardened - at least a bit. In the next few lines I’ll show you how to do a <strong>minimal</strong> hardening.
First, we want to harden the <code class="language-plaintext highlighter-rouge">SSHd</code>.
My configuration file (<code class="language-plaintext highlighter-rouge">/etc/ssh/sshd.conf</code>) looks like follows:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/ssh/sshd_config
<span class="go">[..]
Port 32764
[..]
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

</span><span class="gp">#</span><span class="w"> </span>Ciphers and keying
<span class="go">RekeyLimit 64M

</span><span class="gp">#</span><span class="w"> </span>Logging
<span class="go">SyslogFacility AUTH
LogLevel INFO

</span><span class="gp">#</span><span class="w"> </span>Authentication:
<span class="go">
LoginGraceTime 1m
PermitRootLogin no
StrictModes yes
MaxAuthTries 3
MaxSessions 5

PubkeyAuthentication yes
AuthorizedKeysFile      .ssh/authorized_keys

</span><span class="gp">#</span><span class="w"> </span>To disable tunneled clear text passwords, change to no here!
<span class="go">PasswordAuthentication no
PermitEmptyPasswords no

</span><span class="gp">#</span><span class="w"> </span>Change to <span class="nb">yes </span>to <span class="nb">enable </span>challenge-response passwords <span class="o">(</span>beware issues with
<span class="gp">#</span><span class="w"> </span>some PAM modules and threads<span class="o">)</span>
<span class="go">ChallengeResponseAuthentication no

</span><span class="gp">#</span><span class="w"> </span>Set this to <span class="s1">'yes'</span> to <span class="nb">enable </span>PAM authentication, account processing,
<span class="gp">#</span><span class="w"> </span>and session processing. If this is enabled, PAM authentication will
<span class="gp">#</span><span class="w"> </span>be allowed through the ChallengeResponseAuthentication and
<span class="gp">#</span><span class="w"> </span>PasswordAuthentication.  Depending on your PAM configuration,
<span class="gp">#</span><span class="w"> </span>PAM authentication via ChallengeResponseAuthentication may bypass
<span class="gp">#</span><span class="w"> </span>the setting of <span class="s2">"PermitRootLogin without-password"</span><span class="nb">.</span>
<span class="gp">#</span><span class="w"> </span>If you just want the PAM account and session checks to run without
<span class="gp">#</span><span class="w"> </span>PAM authentication, <span class="k">then </span><span class="nb">enable </span>this but <span class="nb">set </span>PasswordAuthentication
<span class="gp">#</span><span class="w"> </span>and ChallengeResponseAuthentication to <span class="s1">'no'</span><span class="nb">.</span>
<span class="go">UsePAM yes

AllowAgentForwarding no
AllowTcpForwarding no
GatewayPorts no
X11Forwarding no
</span><span class="gp">#</span>X11DisplayOffset 10
<span class="gp">#</span>X11UseLocalhost <span class="nb">yes</span>
<span class="go">PermitTTY yes
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
UseLogin no
UsePrivilegeSeparation sandbox
PermitUserEnvironment no
Compression delayed
ClientAliveInterval 0
ClientAliveCountMax 3
UseDNS no
PidFile /var/run/sshd.pid
MaxStartups 10:30:100
PermitTunnel no
ChrootDirectory none
VersionAddendum none
Banner /etc/issue.net

</span><span class="gp">#</span><span class="w"> </span>override default of no subsystems
<span class="go">Subsystem       sftp    /usr/lib/openssh/sftp-server
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Installing <code class="language-plaintext highlighter-rouge">Fail2Ban</code> is best-practice with systems facing the internet directly:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> fail2ban
<span class="go">Reading package lists... Done
Building dependency tree
Reading state information... Done
The following additional packages will be installed:
  python3-pyinotify python3-systemd whois
Suggested packages:
  monit python-pyinotify-doc
The following NEW packages will be installed:
  fail2ban python3-pyinotify python3-systemd whois
0 upgraded, 4 newly installed, 0 to remove and 0 not upgraded.
Need to get 424 kB of archives.
After this operation, 1,967 kB of additional disk space will be used.
Get:1 http://ftp.de.debian.org/debian bullseye/main amd64 fail2ban all 0.9.6-2 [288 kB]
Get:2 http://ftp.de.debian.org/debian bullseye/main amd64 python3-pyinotify all 0.9.6-1 [26.9 kB]
Get:3 http://ftp.de.debian.org/debian bullseye/main amd64 python3-systemd amd64 233-1 [33.3 kB]
Get:4 http://ftp.de.debian.org/debian bullseye/main amd64 whois amd64 5.2.17~deb9u1 [76.8 kB]
Fetched 424 kB in 0s (3,477 kB/s)
Selecting previously unselected package fail2ban.
(Reading database ... 38168 files and directories currently installed.)
Preparing to unpack .../fail2ban_0.9.6-2_all.deb ...
Unpacking fail2ban (0.9.6-2) ...
Selecting previously unselected package python3-pyinotify.
Preparing to unpack .../python3-pyinotify_0.9.6-1_all.deb ...
Unpacking python3-pyinotify (0.9.6-1) ...
Selecting previously unselected package python3-systemd.
Preparing to unpack .../python3-systemd_233-1_amd64.deb ...
Unpacking python3-systemd (233-1) ...
Selecting previously unselected package whois.
Preparing to unpack .../whois_5.2.17~deb9u1_amd64.deb ...
Unpacking whois (5.2.17~deb9u1) ...
Setting up fail2ban (0.9.6-2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/fail2ban.service â†’ /lib/systemd/system/fail2ban.service.
Setting up whois (5.2.17~deb9u1) ...
Setting up python3-systemd (233-1) ...
Processing triggers for systemd (232-25+deb9u4) ...
Processing triggers for man-db (2.7.6.1-2) ...
Setting up python3-pyinotify (0.9.6-1) ...
</span></code></pre></div></div>

<p>In my case I only enabled the <code class="language-plaintext highlighter-rouge">sshd jail</code>.
For that simply create the file <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.local</code> with the following content:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/fail2ban/jail.local
<span class="go">[sshd]

port    = 32764
logpath = %(sshd_log)s
backend = %(sshd_backend)s
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Please adjust the <code class="language-plaintext highlighter-rouge">port</code> directive according to your setup.</p>
<h2 id="preparing-the-remote-unlock-via-ssh-of-the-luks-partition">
  
  
    Preparing the remote unlock via SSH of the <code class="language-plaintext highlighter-rouge">LUKS</code> partition <a href="#preparing-the-remote-unlock-via-ssh-of-the-luks-partition">#</a>
  
  
</h2>
    

<p>In order to unlock the system’s <code class="language-plaintext highlighter-rouge">LUKS</code> partition(s) via SSH using <code class="language-plaintext highlighter-rouge">Dropbear</code>, we need to do a few things. To be able to remotely unlock via SSH, we need to properly
configure both <code class="language-plaintext highlighter-rouge">Dropbear</code> and GRUB for that.</p>
<h3 id="configure-dropbear">
  
  
    Configure <code class="language-plaintext highlighter-rouge">Dropbear</code> <a href="#configure-dropbear">#</a>
  
  
</h3>
    

<p>First, we copy the public SSH key, we just added to the created user, to the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file for <code class="language-plaintext highlighter-rouge">Dropbear</code>.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cp</span> /home/steffen/.ssh/authorized_keys /etc/dropbear/initramfs/authorized_keys
<span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Next we configure <code class="language-plaintext highlighter-rouge">Dropbear</code>. We will be using the following settings, which can be read about at <a href="https://linux.die.net/man/8/dropbear">linux.die.net</a>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">option</th>
      <th>explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-p 605</td>
      <td>
<code class="language-plaintext highlighter-rouge">Dropbear</code> will listen on port 605</td>
    </tr>
    <tr>
      <td style="text-align: left">-s</td>
      <td>Disable password logins</td>
    </tr>
    <tr>
      <td style="text-align: left">-j</td>
      <td>Disable local port forwarding</td>
    </tr>
    <tr>
      <td style="text-align: left">-k</td>
      <td>Disable remote port forwarding</td>
    </tr>
    <tr>
      <td style="text-align: left">-I 60</td>
      <td>Disconnect the session if no traffic is transmitted for 60 seconds</td>
    </tr>
  </tbody>
</table>

<p>You can set those settings easily using the below command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed 's/#DROPBEAR_OPTIONS=""/DROPBEAR_OPTIONS="-p 605 -s -j -k -I 60"/' -i /etc/dropbear/initramfs/dropbear.conf
</code></pre></div></div>

<p>Verify, whether the settings where set correctly:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep DROPBEAR_OPTIONS /etc/dropbear/initramfs/dropbear.conf
</code></pre></div></div>

<!-- markdownlint-disable MD033 -->
<details>
<summary>Example output:</summary>


<figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">sed</span> <span class="s1">'s/#DROPBEAR_OPTIONS=""/DROPBEAR_OPTIONS="-p 605 -s -j -k -I 60"/'</span> <span class="nt">-i</span> /etc/dropbear/initramfs/dropbear.conf
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">grep </span>DROPBEAR_OPTIONS /etc/dropbear/initramfs/dropbear.conf
<span class="go">DROPBEAR_OPTIONS="-p 605 -s -j -k -I 60"
</span><span class="gp">root@rescue:/#</span></code></pre></figure>


</details>
<!-- markdownlint-enable MD033 -->
<h3 id="configure-grub">
  
  
    Configure GRUB <a href="#configure-grub">#</a>
  
  
</h3>
    

<p>Configuring GRUB for remote unlocking is as easy as configuring <code class="language-plaintext highlighter-rouge">Dropbear</code>.</p>

<p>However, we need to use the “old style-naming” of the ethernet devices (e.g. <code class="language-plaintext highlighter-rouge">eth0</code>), so we have to use both <code class="language-plaintext highlighter-rouge">net.ifnames=0</code> and <code class="language-plaintext highlighter-rouge">biosdevname=0</code> in the
<code class="language-plaintext highlighter-rouge">GRUB_CMDLINE_LINUX_DEFAULT</code>, which can be found in <code class="language-plaintext highlighter-rouge">/etc/default/grub</code>. Additionally we need to enter the IP address, the gateway, the network mask and the ethernet
device to use for the remote connection.</p>

<p>Following is the format of the IP parameter (a detailed explanation can be looked up at <a href="https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt">kernel.org</a>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip=&lt;ip&gt;::&lt;gateway&gt;:&lt;netmask&gt;::&lt;ethernet device&gt;:none
</code></pre></div></div>

<p>Substitute <code class="language-plaintext highlighter-rouge">&lt;ip&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;gateway&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;netmask&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;ethernet device&gt;</code> with your values.</p>

<p>Following an example configuration:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRUB_CMDLINE_LINUX_DEFAULT="net.ifnames=0 biosdevname=0 ip=159.69.68.69::159.69.68.65:255.255.255.192::eth0:none"
</code></pre></div></div>
<h3 id="adding-drivers-to-initramfs">
  
  
    Adding drivers to <code class="language-plaintext highlighter-rouge">initramfs</code> <a href="#adding-drivers-to-initramfs">#</a>
  
  
</h3>
    

<p>To be able to unlock the system <code class="language-plaintext highlighter-rouge">LUKS</code> partition via SSH, an IP address on any ethernet device (in our case <code class="language-plaintext highlighter-rouge">eth0</code>) is required, obviously. For that reason, it
is necessary to provide the correct drivers to the <code class="language-plaintext highlighter-rouge">initramfs image</code>.</p>

<p>You can find out which driver your ethernet device uses with the following command:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">grep </span>DRIVER /sys/class/net/eth0/device/uevent
<span class="go">DRIVER=igb
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Now we need to tell <code class="language-plaintext highlighter-rouge">initramfs-tools</code> to include the above driver in our <code class="language-plaintext highlighter-rouge">initramfs image</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"igb"</span> <span class="o">&gt;&gt;</span> /etc/initramfs-tools/modules
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">cat</span> /etc/initramfs-tools/modules
<span class="gp">#</span><span class="w"> </span>List of modules that you want to include <span class="k">in </span>your initramfs.
<span class="gp">#</span><span class="w"> </span>They will be loaded at boot <span class="nb">time </span><span class="k">in </span>the order below.
<span class="gp">#</span><span class="w">
</span><span class="gp">#</span><span class="w"> </span>Syntax:  module_name <span class="o">[</span>args ...]
<span class="gp">#</span><span class="w">
</span><span class="gp">#</span><span class="w"> </span>You must run update-initramfs<span class="o">(</span>8<span class="o">)</span> to effect this change.
<span class="gp">#</span><span class="w">
</span><span class="gp">#</span><span class="w"> </span>Examples:
<span class="gp">#</span><span class="w">
</span><span class="gp">#</span><span class="w"> </span>raid1
<span class="gp">#</span><span class="w"> </span>sd_mod
<span class="go">igb
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>
<h3 id="optional-updating-the-mdadm-configuration">
  
  
    Optional: Updating the <code class="language-plaintext highlighter-rouge">mdadm</code> configuration <a href="#optional-updating-the-mdadm-configuration">#</a>
  
  
</h3>
    

<p>This section only concerns users with software RAIDs.</p>

<p>I guess you recall that we created the <code class="language-plaintext highlighter-rouge">mdadm</code> software RAIDs <em>outside</em> of the <code class="language-plaintext highlighter-rouge">chroot</code>. Since we mounted <code class="language-plaintext highlighter-rouge">/proc</code> (and other system relevant partitions,
such as <code class="language-plaintext highlighter-rouge">dev</code>) <code class="language-plaintext highlighter-rouge">mdadm</code> is <em>currently</em> aware which arrays have been created with which personalities. To ensure that the configuration remains intact after
rebooting, it cannot hurt to update the <code class="language-plaintext highlighter-rouge">/etc/mdadm/mdadm.conf</code> with the proper configuration.</p>

<p>First, lets ensure that the RAIDs are being detected perfectly fine by <code class="language-plaintext highlighter-rouge">mdadm</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>mdadm <span class="nt">--detail</span> <span class="nt">--scan</span>
<span class="go">ARRAY /dev/md0 metadata=0.90 UUID=c8745d1f:ed8dd7dc:776c2c25:004bd7b2
ARRAY /dev/md/1 metadata=1.2 name=rescue:1 UUID=a0e88eb6:4fae8ddc:a2214f58:4324028a
ARRAY /dev/md/2 metadata=1.2 name=rescue:2 UUID=99552fd2:254ca90d:7b9e04ad:942333ee
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Looks good to me, let’s populate <code class="language-plaintext highlighter-rouge">/etc/mdadm/mdadm.conf</code> with that content:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/#</span><span class="w"> </span>mdadm <span class="nt">--detail</span> <span class="nt">--scan</span> <span class="o">&gt;</span> /etc/mdadm/mdam.conf
<span class="go">ARRAY /dev/md0 metadata=0.90 UUID=c8745d1f:ed8dd7dc:776c2c25:004bd7b2
ARRAY /dev/md/1 metadata=1.2 name=rescue:1 UUID=a0e88eb6:4fae8ddc:a2214f58:4324028a
ARRAY /dev/md/2 metadata=1.2 name=rescue:2 UUID=99552fd2:254ca90d:7b9e04ad:942333ee
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Yea, right, it’s as easy as that <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20"></p>
<h3 id="installing-grub-generating-new-initramfs-and-updating-grub">
  
  
    Installing GRUB, generating new <code class="language-plaintext highlighter-rouge">initramfs</code> and updating GRUB <a href="#installing-grub-generating-new-initramfs-and-updating-grub">#</a>
  
  
</h3>
    

<p>Finally we are able to install GRUB, generate a new <code class="language-plaintext highlighter-rouge">initramfs image</code> and update GRUB the GRUB configuration file.</p>

<p>Since (at least) Debian 11 (Buster) it is necessary to manually install GRUB onto the devices that should “store” the boot loader, as it is not automatically triggered anymore.</p>

<p>This can be easily done with: <code class="language-plaintext highlighter-rouge">grub-install &lt;device&gt;</code>. <code class="language-plaintext highlighter-rouge">&lt;device&gt;</code> has to be replaced with the device/s that have the BIOS boot partition created. In my case
that’s <code class="language-plaintext highlighter-rouge">/dev/nvme0n1</code> and <code class="language-plaintext highlighter-rouge">/dev/nvme1n1</code>.</p>

<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> It is important to specify the <em>device</em> itself, not a partition!</p>

<p>Updating both <code class="language-plaintext highlighter-rouge">initramfs</code> and GRUB is necessary as we changed the configuration and/or added new drivers to the <code class="language-plaintext highlighter-rouge">initramfs image</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue:/boot#</span><span class="w"> </span>update-initramfs <span class="nt">-u</span> <span class="nt">-k</span> all
<span class="go">update-initramfs: Generating /boot/initrd.img-4.19.0-10-amd64
</span><span class="gp">root@rescue:/boot#</span><span class="w"> </span>update-grub
<span class="go">Generating grub configuration file ...
Found linux image: /boot/vmlinuz-4.19.0-10-amd64
Found initrd image: /boot/initrd.img-4.19.0-10-amd64
done
</span><span class="gp">root@rescue:/boot#</span><span class="w">
</span></code></pre></div></div>

<p>Now simply logout of the <code class="language-plaintext highlighter-rouge">chroot</code> and reboot the system.
You should be able to reach the system on the port you have configured in the <code class="language-plaintext highlighter-rouge">Dropbear</code> section, via SSH. Since <code class="language-plaintext highlighter-rouge">Dropbear</code> is not aware of any other users
than root, you need to use the user <code class="language-plaintext highlighter-rouge">root</code> to login.
If you followed my configuration, it’s port 605 via SSH. There you’ll have to run <code class="language-plaintext highlighter-rouge">cryptroot-unlock</code> and enter the password for the system <code class="language-plaintext highlighter-rouge">LUKS</code> partition.</p>

<p>Congratulations, you managed to manually install a Debian Bullseye <img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20"></p>
<h2 id="troubleshooting-the-installation">
  
  
    Troubleshooting the installation <a href="#troubleshooting-the-installation">#</a>
  
  
</h2>
    

<p>If something goes wrong during the installation and the system does not come up as expected, you can troubleshoot the installation pretty easily using a
live CD (like the Hetzner rescue system).</p>

<p>First login to the live system as root.
In order to re-mount the system as done during the installation, you can use the script from the section <a href="#Mounting%20the%20partitions">Mounting the partitions</a> or do it manually.
In this case I will do it manually, just to show the general approach behind this procedure.
First, we need to unlock the system’s <code class="language-plaintext highlighter-rouge">LUKS</code> partition and - if you have it - the data <code class="language-plaintext highlighter-rouge">LUKS</code> partition:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksOpen /dev/sda3 crypted_system
<span class="go">Enter passphrase for /dev/sda3:
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksOpen /dev/sdb crypted_data
<span class="go">Enter passphrase for /dev/sdb:
</span><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /dev/mapper/
<span class="go">total 0
drwxr-xr-x  2 root root     100 Aug 27 16:29 .
drwxr-xr-x 16 root root    6.4K Aug 27 16:29 ..
crw-------  1 root root 10, 236 Aug 27 16:28 control
</span><span class="gp">lrwxrwxrwx  1 root root       7 Aug 27 16:29 crypted_data -&gt;</span><span class="w"> </span>../dm-1
<span class="gp">lrwxrwxrwx  1 root root       7 Aug 27 16:29 crypted_system -&gt;</span><span class="w"> </span>../dm-0
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>Next, we need to make the system aware of our volume groups. This can easily be done using <code class="language-plaintext highlighter-rouge">vgchange -aay</code>, which will automatically detect all volume groups and active them:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>vgchange <span class="nt">-aay</span>
<span class="go">  1 logical volume(s) in volume group "vg_data" now active
  7 logical volume(s) in volume group "vg_system" now active
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>Now, we can mount all volumes again to <code class="language-plaintext highlighter-rouge">/mnt</code>:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /dev/mapper/<span class="k">*</span>
<span class="go">crw------- 1 root root 10, 236 Aug 27 16:28 /dev/mapper/control
</span><span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:29 /dev/mapper/crypted_data -&gt;</span><span class="w"> </span>../dm-1
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:29 /dev/mapper/crypted_system -&gt;</span><span class="w"> </span>../dm-0
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_data-var_lib_vz -&gt;</span><span class="w"> </span>../dm-2
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-home -&gt;</span><span class="w"> </span>../dm-4
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-root -&gt;</span><span class="w"> </span>../dm-3
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-swap -&gt;</span><span class="w"> </span>../dm-8
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-tmp -&gt;</span><span class="w"> </span>../dm-5
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-var -&gt;</span><span class="w"> </span>../dm-9
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-var_log -&gt;</span><span class="w"> </span>../dm-7
<span class="gp">lrwxrwxrwx 1 root root       7 Aug 27 16:33 /dev/mapper/vg_system-var_tmp -&gt;</span><span class="w"> </span>../dm-6
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-root /mnt/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-home /mnt/home/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-tmp /mnt/tmp
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-var /mnt/var/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-var_log /mnt/var/log/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_system-var_tmp /mnt/var/tmp/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount /dev/mapper/vg_data-var_lib_vz /mnt/var/lib/vz/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount
<span class="go">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
sys on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,relatime,size=132021144k,nr_inodes=33005286,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
213.133.99.101:/nfs on /root/.oldroot/nfs type nfs (ro,noatime,vers=3,rsize=8192,wsize=8192,namlen=255,acregmin=600,acregmax=600,acdirmin=600,acdirmax=600,hard,nocto,nolock,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=213.133.99.101,mountvers=3,mountproto=tcp,local_lock=all,addr=213.133.99.101)
overlay on / type overlay (rw,relatime,lowerdir=/nfsroot,upperdir=/ramfs/root,workdir=/ramfs/work)
securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,nodev,mode=755)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=systemd)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
systemd-1 on /proc/sys/fs/binfmt_misc type autofs (rw,relatime,fd=21,pgrp=1,timeout=300,minproto=5,maxproto=5,direct)
mqueue on /dev/mqueue type mqueue (rw,relatime)
hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime)
fusectl on /sys/fs/fuse/connections type fusectl (rw,relatime)
/dev/mapper/vg_system-root on /mnt type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_system-home on /mnt/home type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_system-tmp on /mnt/tmp type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_system-var on /mnt/var type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_system-var_log on /mnt/var/log type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_system-var_tmp on /mnt/var/tmp type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_data-var_lib_vz on /mnt/var/lib/vz type xfs (rw,relatime,attr2,inode64,noquota)
</span><span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>

<p>Before we can <code class="language-plaintext highlighter-rouge">chroot</code> into the environment, we need to mount the necessary system partitions:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>mount <span class="nt">-o</span> <span class="nb">bind</span> /dev/ /mnt/dev/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount <span class="nt">-t</span> devpts devpts /mnt/dev/pts/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount <span class="nt">-t</span> proc proc /mnt/proc/
<span class="gp">root@rescue ~ #</span><span class="w"> </span>mount <span class="nt">-t</span> sysfs sys /mnt/sys/
<span class="gp">root@rescue ~ #</span><span class="w"> </span><span class="nv">XTERM</span><span class="o">=</span>xterm-color <span class="nv">LANG</span><span class="o">=</span>C.UTF-8 <span class="nb">chroot</span> /mnt /bin/bash
<span class="gp">root@rescue:/#</span><span class="w"> </span><span class="nb">pwd</span>
<span class="go">/
</span><span class="gp">root@rescue:/#</span><span class="w">
</span></code></pre></div></div>

<p>Now you can change, whatever you need to, <code class="language-plaintext highlighter-rouge">umount</code> everything and reboot the system.</p>

<p>Don’t forget to close everything properly:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@rescue ~ #</span><span class="w"> </span>lvchange <span class="nt">-a</span> n vg_system
<span class="gp">root@rescue ~ #</span><span class="w"> </span>lvchange <span class="nt">-a</span> n vg_data
<span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksClose crypted_system
<span class="gp">root@rescue ~ #</span><span class="w"> </span>cryptsetup luksClose crypted_data
<span class="gp">root@rescue ~ #</span><span class="w">
</span></code></pre></div></div>
<h2 id="change-log">
  
  
    Change log <a href="#change-log">#</a>
  
  
</h2>
    
<h3 id="2025-01-23">
  
  
    2025-01-23 <a href="#2025-01-23">#</a>
  
  
</h3>
    

<ul>
  <li>Replacing dead individual <code class="language-plaintext highlighter-rouge">access.redhat.com</code> links with an overview of <code class="language-plaintext highlighter-rouge">LVM</code> (also from <code class="language-plaintext highlighter-rouge">access.redhat.com</code>)</li>
</ul>
<h3 id="2024-04-01">
  
  
    2024-04-01 <a href="#2024-04-01">#</a>
  
  
</h3>
    

<ul>
  <li>Replacing dead <code class="language-plaintext highlighter-rouge">tldp.org</code> links with <code class="language-plaintext highlighter-rouge">access.redhat.com</code> links, which describe the <code class="language-plaintext highlighter-rouge">LVM</code> way better</li>
  <li>Spelling fix</li>
</ul>
<h3 id="2024-03-11">
  
  
    2024-03-11 <a href="#2024-03-11">#</a>
  
  
</h3>
    

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">markdownlint</code> fixes</li>
  <li>Spelling fixes</li>
</ul>
<h3 id="2024-03-10">
  
  
    2024-03-10 <a href="#2024-03-10">#</a>
  
  
</h3>
    

<ul>
  <li>Unifying code blocks for better readability</li>
  <li>Fixing header levels</li>
</ul>
<h3 id="2024-02-02">
  
  
    2024-02-02 <a href="#2024-02-02">#</a>
  
  
</h3>
    

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">markdownlint</code> fixes</li>
</ul>

  </div>

  <script src="https://utteranc.es/client.js" repo="sscheib/sscheib.github.io-comments" issue-term="title" label="comment" theme="github-light" crossorigin="anonymous" async>
  </script>

  <a class="u-url" href="/2023/08/28/debootstrapping-debian-bookworm.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://blog.scheib.me/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          
        </ul>
      </div>
      <div class="footer-col">
        <p>This my personal blog, where I post about things that I do and find interesting. All posts and thoughts on this blog are solely my opinion and are not related to my employer.</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list"><li><a href="https://github.com/sscheib"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sscheib</span></a></li></ul>
</div>
    <div class="datenschutzerklaerung">
    <a style="font-size:10px" href="https://blog.scheib.me/datenschutzerklaerung.html">Datenschutzerklärung</a> <a style="font-size:10px" href="https://blog.scheib.me/impressum.html">Impressum</a>
    </div>

  </div>
</footer>
</body>

</html>
